import{_ as O,$ as rt,a0 as ee,a1 as Pt,a2 as Dt,v as ei,u as Ot,w as Q,a3 as Ye,a4 as se,a5 as we,m as j,g as qe,a6 as ti,a7 as Lt,a8 as ri,B as ii,a9 as ni,aa as Ut,U as vt,ab as si,H as oi,ac as ai,ad as Ie,ae as Qt,p as li,af as ci,ag as er,ah as te,ai as Ne,aj as hi,F as tr,ak as ui,al as fi,am as Nt,an as di,ao as gi,ap as pi,aq as rr,ar as Ti,as as Gt,R as Ei,at as mi,au as _i,av as yi}from"./Layer-5200258f.js";import{b as xi,d as Ge,r as Ri,f as wi,E as bi,g as Ai,h as Si,c as Ii,e as Ci,i as Pi,j as Di,k as Oi,l as Ft,m as Fe,T as Li,I as ir,R as it,n as de,o as Ui,a as Bt,L as vi}from"./TileProperty-ab86017d.js";import{g as nr}from"./_commonjsHelpers-39b5b250.js";import{l as Z}from"./index-c940254e.js";import{B as Ni}from"./BaseTile-53865aab.js";function Ce(i){return i instanceof Image||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement||i instanceof ImageBitmap?i:null}function We(i){return i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Float32Array||i instanceof DataView?i:null}let re=null;function Gi(i){re||(re=rt(i.width,i.height,void 0,{willReadFrequently:!0}));const e=re.canvas,t=i.width;e.width!==t&&(e.width=t);const r=i.height;return e.height!==r&&(e.height=r),re.clearRect(0,0,t,r),re.drawImage(i,0,0),re.getImageData(0,0,t,r).data}const Fi=[256,256];let Bi=class extends xi{constructor(e){const t=O.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null}getSize(){if(this.size_)return this.size_;const e=Ce(this.data_);return e?[e.width,e.height]:Fi}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==O.IDLE&&this.state!==O.ERROR)return;this.state=O.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=O.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=O.ERROR,e.changed()})}};const nt=Bi;class Mi extends nt{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8Array(4)),interpolate:e.interpolate,transition:e.transition}),this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),r=this.targetTileGrid_.getExtent();let n=this.sourceTileGrid_.getExtent();const s=r?ee(t,r):t;if(Pt(s)===0){this.state=O.EMPTY;return}const o=e.sourceProj,a=o.getExtent();a&&(n?n=ee(n,a):n=a);const l=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),h=e.targetProj,c=wi(o,h,s,l);if(!isFinite(c)||c<=0){this.state=O.EMPTY;return}const u=e.errorThreshold!==void 0?e.errorThreshold:bi;if(this.triangulation_=new Ai(o,h,s,n,c*u,l),this.triangulation_.getTriangles().length===0){this.state=O.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(c);let d=this.triangulation_.calculateSourceExtent();if(n&&(o.canWrapX()?(d[1]=Ye(d[1],n[1],n[3]),d[3]=Ye(d[3],n[1],n[3])):d=ee(d,n)),!Pt(d))this.state=O.EMPTY;else{const f=this.sourceTileGrid_.getTileRangeForExtentAndZ(d,this.sourceZ_),p=e.getTileFunction;for(let g=f.minX;g<=f.maxX;g++)for(let T=f.minY;T<=f.maxY;T++){const _=p(this.sourceZ_,g,T,this.pixelRatio_);_&&this.sourceTiles_.push(_)}this.sourceTiles_.length===0&&(this.state=O.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{if(!t||t.getState()!==O.LOADED)return;const r=t.getSize(),n=this.gutter_;let s;const o=We(t.getData());o?s=o:s=Gi(Ce(t.getData()));const a=[r[0]+2*n,r[1]+2*n],l=s instanceof Float32Array,h=a[0]*a[1],c=l?Float32Array:Uint8Array,u=new c(s.buffer),d=c.BYTES_PER_ELEMENT,f=d*u.length/h,p=u.byteLength/a[1],g=Math.floor(p/d/a[0]),T=h*g;let _=u;if(u.length!==T){_=new c(T);let E=0,y=0;const x=a[0]*g;for(let R=0;R<a[1];++R){for(let A=0;A<x;++A)_[E++]=u[y+A];y+=p/d}}e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),data:new Uint8Array(_.buffer),dataType:c,bytesPerPixel:f,pixelSize:a})}),this.sourceTiles_.length=0,e.length===0)this.state=O.ERROR;else{const t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),n=typeof r=="number"?r:r[0],s=typeof r=="number"?r:r[1],o=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),l=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);let h,c;const u=e[0].bytesPerPixel,d=Math.ceil(u/3);for(let f=d-1;f>=0;--f){const p=[];for(let x=0,R=e.length;x<R;++x){const A=e[x],S=A.data,b=A.pixelSize,D=b[0],L=b[1],v=rt(D,L,Ge),B=v.createImageData(D,L),X=B.data;let M=f*3;for(let k=0,Ue=X.length;k<Ue;k+=4)X[k]=S[M],X[k+1]=S[M+1],X[k+2]=S[M+2],X[k+3]=255,M+=u;v.putImageData(B,0,0),p.push({extent:A.extent,image:v.canvas})}const g=Ri(n,s,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),o,l,this.triangulation_,p,this.gutter_,!1,!1);for(let x=0,R=p.length;x<R;++x){const S=p[x].image.getContext("2d");Dt(S),Ge.push(S.canvas)}const T=g.getContext("2d"),_=T.getImageData(0,0,g.width,g.height);Dt(T),Ge.push(g),h||(c=new Uint8Array(u*_.width*_.height),h=new e[0].dataType(c.buffer));const E=_.data;let y=f*3;for(let x=0,R=E.length;x<R;x+=4)E[x+3]===255?(c[y]=E[x],c[y+1]=E[x+1],c[y+2]=E[x+2]):(c[y]=0,c[y+1]=0,c[y+2]=0),y+=u}this.reprojData_=h,this.reprojSize_=[Math.round(n*this.pixelRatio_),Math.round(s*this.pixelRatio_)],this.state=O.LOADED}this.changed()}load(){if(this.state!==O.IDLE&&this.state!==O.ERROR)return;this.state=O.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(t=>{const r=t.getState();if(r!==O.IDLE&&r!==O.LOADING)return;e++;const n=ei(t,Q.CHANGE,function(){const s=t.getState();(s==O.LOADED||s==O.ERROR||s==O.EMPTY)&&(Ot(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(t){t.getState()==O.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Ot),this.sourcesListenerKeys_=null}}const st=Mi;class $i extends Si{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Ii({extent:Ci(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,opaque:e.opaque,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?se(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.tileCacheForProjection_={}}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?se(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return!t||we(t,e)?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s){const o=this.getTileCacheForProjection(n),a=Ft(e,t,r);if(o.containsKey(a)){const T=o.get(a);if(T&&T.key==this.getKey())return T}const l=this.getTileGrid(),h=Math.max.apply(null,l.getResolutions().map((T,_)=>{const E=se(l.getTileSize(_)),y=this.getTileSize(_);return Math.max(y[0]/E[0],y[1]/E[1])})),c=this.getTileGridForProjection(s),u=this.getTileGridForProjection(n),d=[e,t,r],f=this.getTileCoordForTileUrlFunction(d,n),p=Object.assign({sourceProj:s,sourceTileGrid:c,targetProj:n,targetTileGrid:u,tileCoord:d,wrappedTileCoord:f,pixelRatio:h,gutter:this.getGutterForProjection(s),getTileFunction:(T,_,E,y)=>this.getTile(T,_,E,y,s)},this.tileOptions),g=new st(p);return g.key=this.getKey(),g}getTile(e,t,r,n,s){const o=this.getProjection();if(o&&s&&!we(o,s))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),l=Ft(e,t,r);if(this.tileCache.containsKey(l))return this.tileCache.get(l);const h=this.loader_;function c(){return ti(function(){return h(e,t,r)})}const u=Object.assign({tileCoord:[e,t,r],loader:c,size:a},this.tileOptions),d=new nt(u);return d.key=this.getKey(),d.addEventListener(Q.CHANGE,this.handleTileChange_),this.tileCache.set(l,d),d}handleTileChange_(e){const t=e.target,r=j(t),n=t.getState();let s;n==O.LOADING?(this.tileLoadingKeys_[r]=!0,s=Fe.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==O.ERROR?Fe.TILELOADERROR:n==O.LOADED?Fe.TILELOADEND:void 0),s&&this.dispatchEvent(new Pi(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||we(t,e)))return this.tileGrid;const r=j(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=Di(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=qe(e);if(r){const n=j(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}getTileCacheForProjection(e){const t=this.getProjection();if(!t||we(t,e))return this.tileCache;const r=j(e);return r in this.tileCacheForProjection_||(this.tileCacheForProjection_[r]=new Oi(.1)),this.tileCacheForProjection_[r]}expireCache(e,t){const r=this.getTileCacheForProjection(e);this.tileCache.expireCache(this.tileCache==r?t:{});for(const n in this.tileCacheForProjection_){const s=this.tileCacheForProjection_[n];s.expireCache(s==r?t:{})}}clear(){super.clear();for(const e in this.tileCacheForProjection_)this.tileCacheForProjection_[e].clear()}}const ki=$i;function F(i){return(e,...t)=>zi(i,e,t)}function le(i,e){return F(sr(i,e).get)}const{apply:zi,construct:So,defineProperty:Io,get:Co,getOwnPropertyDescriptor:sr,getPrototypeOf:ot,has:Po,ownKeys:ji,set:Do,setPrototypeOf:Oo}=Reflect,{iterator:me,species:Lo,toStringTag:Xi,for:Uo}=Symbol,Vi=Object,{create:at,defineProperty:Hi,freeze:vo,is:No}=Vi,Ki=Array,Yi=Ki.prototype,or=Yi[me],qi=F(or),ar=ArrayBuffer,Wi=ar.prototype;le(Wi,"byteLength");const Mt=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;Mt&&le(Mt.prototype,"byteLength");const lr=ot(Uint8Array);lr.from;const $=lr.prototype;$[me];F($.keys);F($.values);F($.entries);F($.set);F($.reverse);F($.fill);F($.copyWithin);F($.sort);F($.slice);F($.subarray);le($,"buffer");le($,"byteOffset");le($,"length");le($,Xi);const Zi=Uint8Array,cr=Uint16Array,lt=Uint32Array,Ji=Float32Array,Ee=ot([][me]()),hr=F(Ee.next),Qi=F(function*(){}().next),en=ot(Ee),tn=DataView.prototype,rn=F(tn.getUint16),ct=WeakMap,ur=ct.prototype,fr=F(ur.get),nn=F(ur.set),dr=new ct,sn=at(null,{next:{value:function(){const e=fr(dr,this);return hr(e)}},[me]:{value:function(){return this}}});function on(i){if(i[me]===or&&Ee.next===hr)return i;const e=at(sn);return nn(dr,e,qi(i)),e}const an=new ct,ln=at(en,{next:{value:function(){const e=fr(an,this);return Qi(e)},writable:!0,configurable:!0}});for(const i of ji(Ee))i!=="next"&&Hi(ln,i,sr(Ee,i));const gr=new ar(4),cn=new Ji(gr),hn=new lt(gr),H=new cr(512),K=new Zi(512);for(let i=0;i<256;++i){const e=i-127;e<-27?(H[i]=0,H[i|256]=32768,K[i]=24,K[i|256]=24):e<-14?(H[i]=1024>>-e-14,H[i|256]=1024>>-e-14|32768,K[i]=-e-1,K[i|256]=-e-1):e<=15?(H[i]=e+15<<10,H[i|256]=e+15<<10|32768,K[i]=13,K[i|256]=13):e<128?(H[i]=31744,H[i|256]=64512,K[i]=24,K[i|256]=24):(H[i]=31744,H[i|256]=64512,K[i]=13,K[i|256]=13)}const ht=new lt(2048);for(let i=1;i<1024;++i){let e=i<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,ht[i]=e|t}for(let i=1024;i<2048;++i)ht[i]=939524096+(i-1024<<13);const ce=new lt(64);for(let i=1;i<31;++i)ce[i]=i<<23;ce[31]=1199570944;ce[32]=2147483648;for(let i=33;i<63;++i)ce[i]=2147483648+(i-32<<23);ce[63]=3347054592;const pr=new cr(64);for(let i=1;i<64;++i)i!==32&&(pr[i]=1024);function un(i){const e=i>>10;return hn[0]=ht[pr[e]+(i&1023)]+ce[e],cn[0]}function Tr(i,e,...t){return un(rn(i,e,...on(t)))}var ut={exports:{}};function Er(i,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+i);const n=typeof i=="object"?i.outer:i,s=n.slice(0,n.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],h=e+"\\="+l+"([^"+l+"]*)"+l;r&&console.log("[xml-utils] pattern:",h);const u=new RegExp(h).exec(s);if(r&&console.log("[xml-utils] match:",u),u)return u[1]}}ut.exports=Er;ut.exports.default=Er;var fn=ut.exports;const Be=nr(fn);var ft={exports:{}},dt={exports:{}},gt={exports:{}};function mr(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index:-1}gt.exports=mr;gt.exports.default=mr;var dn=gt.exports,pt={exports:{}};function _r(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index+n[0].length-1:-1}pt.exports=_r;pt.exports.default=_r;var gn=pt.exports,Tt={exports:{}};function yr(i,e){const t=new RegExp(e,"g"),r=i.match(t);return r?r.length:0}Tt.exports=yr;Tt.exports.default=yr;var pn=Tt.exports;const Tn=dn,Me=gn,$t=pn;function xr(i,e,t){const r=t&&t.debug||!1,n=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=Tn(i,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=i.slice(o+e.length);let l=Me(a,"^[^<]*[ /]>",0);const h=l!==-1&&a[l-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",h),h===!1)if(n){let f=0,p=1,g=0;for(;(l=Me(a,"[ /]"+e+">",f))!==-1;){const T=a.substring(f,l+1);if(p+=$t(T,"<"+e+`[ 
	>]`),g+=$t(T,"</"+e+">"),g>=p)break;f=l}}else l=Me(a,"[ /]"+e+">",0);const c=o+e.length+l+1;if(r&&console.log("[xml-utils] end:",c),c===-1)return;const u=i.slice(o,c);let d;return h?d=null:d=u.slice(u.indexOf(">")+1,u.lastIndexOf("<")),{inner:d,outer:u,start:o,end:c}}dt.exports=xr;dt.exports.default=xr;var En=dt.exports;const mn=En;function Rr(i,e,t){const r=[],n=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=mn(i,e,{debug:n,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return n&&console.log("findTagsByName found",r.length,"tags"),r}ft.exports=Rr;ft.exports.default=Rr;var _n=ft.exports;const yn=nr(_n),Te={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},Y={};for(const i in Te)Te.hasOwnProperty(i)&&(Y[Te[i]]=parseInt(i,10));const xn=[Y.BitsPerSample,Y.ExtraSamples,Y.SampleFormat,Y.StripByteCounts,Y.StripOffsets,Y.StripRowCounts,Y.TileByteCounts,Y.TileOffsets,Y.SubIFDs],$e={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},P={};for(const i in $e)$e.hasOwnProperty(i)&&(P[$e[i]]=parseInt(i,10));const z={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,TransparencyMask:4,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},Rn={Unspecified:0,Assocalpha:1,Unassalpha:2},Go={Version:0,AddCompression:1},Fo={None:0,Deflate:1,Zstandard:2},wn={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function bn(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=256-i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function An(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function Sn(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<i.length;++a,l+=3){const h=i[a];n[l]=e[h]/65536*256,n[l+1]=e[h+s]/65536*256,n[l+2]=e[h+o]/65536*256}return n}function In(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=4,s+=3){const o=i[n],a=i[n+1],l=i[n+2],h=i[n+3];r[s]=255*((255-o)/256)*((255-h)/256),r[s+1]=255*((255-a)/256)*((255-h)/256),r[s+2]=255*((255-l)/256)*((255-h)/256)}return r}function Cn(i){const{width:e,height:t}=i,r=new Uint8ClampedArray(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n],a=i[n+1],l=i[n+2];r[s]=o+1.402*(l-128),r[s+1]=o-.34414*(a-128)-.71414*(l-128),r[s+2]=o+1.772*(a-128)}return r}const Pn=.95047,Dn=1,On=1.08883;function Ln(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n+0],a=i[n+1]<<24>>24,l=i[n+2]<<24>>24;let h=(o+16)/116,c=a/500+h,u=h-l/200,d,f,p;c=Pn*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),h=Dn*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),u=On*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),d=c*3.2406+h*-1.5372+u*-.4986,f=c*-.9689+h*1.8758+u*.0415,p=c*.0557+h*-.204+u*1.057,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,p=p>.0031308?1.055*p**(1/2.4)-.055:12.92*p,r[s]=Math.max(0,Math.min(1,d))*255,r[s+1]=Math.max(0,Math.min(1,f))*255,r[s+2]=Math.max(0,Math.min(1,p))*255}return r}const wr=new Map;function J(i,e){Array.isArray(i)||(i=[i]),i.forEach(t=>wr.set(t,e))}async function br(i){const e=wr.get(i.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const t=await e();return new t(i)}J([void 0,1],()=>Z(()=>import("./raw-7a0fe838.js"),["./raw-7a0fe838.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));J(5,()=>Z(()=>import("./lzw-901d9363.js"),["./lzw-901d9363.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));J(6,()=>{throw new Error("old style JPEG compression is not supported.")});J(7,()=>Z(()=>import("./jpeg-2f15dd85.js"),["./jpeg-2f15dd85.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));J([8,32946],()=>Z(()=>import("./deflate-29fb883b.js"),["./deflate-29fb883b.js","./pako.esm-bae9e474.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));J(32773,()=>Z(()=>import("./packbits-90020365.js"),["./packbits-90020365.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));J(34887,()=>Z(()=>import("./lerc-e965a52b.js"),["./lerc-e965a52b.js","./pako.esm-bae9e474.js","./_commonjsHelpers-39b5b250.js","./basedecoder-3573ccae.js","./Layer-5200258f.js","./TileProperty-ab86017d.js","./index-c940254e.js","./index-3002667b.css","./BaseTile-53865aab.js"],import.meta.url).then(async i=>(await i.zstd.init(),i)).then(i=>i.default));J(50001,()=>Z(()=>import("./webimage-aa764004.js"),["./webimage-aa764004.js","./basedecoder-3573ccae.js"],import.meta.url).then(i=>i.default));function Oe(i,e,t,r=1){return new(Object.getPrototypeOf(i)).constructor(e*t*r)}function Un(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=Oe(a,r,n);for(let h=0;h<n;++h){const c=Math.min(Math.round(o*h),t-1);for(let u=0;u<r;++u){const d=Math.min(Math.round(s*u),e-1),f=a[c*e+d];l[h*r+u]=f}}return l})}function oe(i,e,t){return(1-t)*i+t*e}function vn(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=Oe(a,r,n);for(let h=0;h<n;++h){const c=o*h,u=Math.floor(c),d=Math.min(Math.ceil(c),t-1);for(let f=0;f<r;++f){const p=s*f,g=p%1,T=Math.floor(p),_=Math.min(Math.ceil(p),e-1),E=a[u*e+T],y=a[u*e+_],x=a[d*e+T],R=a[d*e+_],A=oe(oe(E,y,g),oe(x,R,g),c%1);l[h*r+f]=A}}return l})}function Nn(i,e,t,r,n,s="nearest"){switch(s.toLowerCase()){case"nearest":return Un(i,e,t,r,n);case"bilinear":case"linear":return vn(i,e,t,r,n);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function Gn(i,e,t,r,n,s){const o=e/r,a=t/n,l=Oe(i,r,n,s);for(let h=0;h<n;++h){const c=Math.min(Math.round(a*h),t-1);for(let u=0;u<r;++u){const d=Math.min(Math.round(o*u),e-1);for(let f=0;f<s;++f){const p=i[c*e*s+d*s+f];l[h*r*s+u*s+f]=p}}}return l}function Fn(i,e,t,r,n,s){const o=e/r,a=t/n,l=Oe(i,r,n,s);for(let h=0;h<n;++h){const c=a*h,u=Math.floor(c),d=Math.min(Math.ceil(c),t-1);for(let f=0;f<r;++f){const p=o*f,g=p%1,T=Math.floor(p),_=Math.min(Math.ceil(p),e-1);for(let E=0;E<s;++E){const y=i[u*e*s+T*s+E],x=i[u*e*s+_*s+E],R=i[d*e*s+T*s+E],A=i[d*e*s+_*s+E],S=oe(oe(y,x,g),oe(R,A,g),c%1);l[h*r*s+f*s+E]=S}}}return l}function Bn(i,e,t,r,n,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return Gn(i,e,t,r,n,s);case"bilinear":case"linear":return Fn(i,e,t,r,n,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function Mn(i,e,t){let r=0;for(let n=e;n<t;++n)r+=i[n];return r}function Ze(i,e,t){switch(i){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function $n(i,e){return(i===1||i===2)&&e<=32&&e%8===0?!1:!(i===3&&(e===16||e===32||e===64))}function kn(i,e,t,r,n,s,o){const a=new DataView(i),l=t===2?o*s:o*s*r,h=t===2?1:r,c=Ze(e,n,l),u=parseInt("1".repeat(n),2);if(e===1){let d;t===1?d=r*n:d=n;let f=s*d;f&7&&(f=f+7&-8);for(let p=0;p<o;++p){const g=p*f;for(let T=0;T<s;++T){const _=g+T*h*n;for(let E=0;E<h;++E){const y=_+E*n,x=(p*s+T)*h+E,R=Math.floor(y/8),A=y%8;if(A+n<=8)c[x]=a.getUint8(R)>>8-n-A&u;else if(A+n<=16)c[x]=a.getUint16(R)>>16-n-A&u;else if(A+n<=24){const S=a.getUint16(R)<<8|a.getUint8(R+2);c[x]=S>>24-n-A&u}else c[x]=a.getUint32(R)>>32-n-A&u}}}}return c.buffer}class zn{constructor(e,t,r,n,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=n,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(n,s){return Tr(this,n,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),n=this.getBitsPerSample(e);return Ze(r,n,t)}async getTileOrStrip(e,t,r,n,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:h}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let c,u;this.isTiled?(c=this.fileDirectory.TileOffsets[l],u=this.fileDirectory.TileByteCounts[l]):(c=this.fileDirectory.StripOffsets[l],u=this.fileDirectory.StripByteCounts[l]);const d=(await this.source.fetch([{offset:c,length:u}],s))[0];let f;return h===null||!h[l]?(f=(async()=>{let p=await n.decode(this.fileDirectory,d);const g=this.getSampleFormat(),T=this.getBitsPerSample();return $n(g,T)&&(p=kn(p,g,this.planarConfiguration,this.getSamplesPerPixel(),T,this.getTileWidth(),this.getBlockHeight(t))),p})(),h!==null&&(h[l]=f)):f=h[l],{x:e,y:t,sample:r,data:await f}}async _readRaster(e,t,r,n,s,o,a,l,h){const c=this.getTileWidth(),u=this.getTileHeight(),d=this.getWidth(),f=this.getHeight(),p=Math.max(Math.floor(e[0]/c),0),g=Math.min(Math.ceil(e[2]/c),Math.ceil(d/c)),T=Math.max(Math.floor(e[1]/u),0),_=Math.min(Math.ceil(e[3]/u),Math.ceil(f/u)),E=e[2]-e[0];let y=this.getBytesPerPixel();const x=[],R=[];for(let b=0;b<t.length;++b)this.planarConfiguration===1?x.push(Mn(this.fileDirectory.BitsPerSample,0,t[b])/8):x.push(0),R.push(this.getReaderForSample(t[b]));const A=[],{littleEndian:S}=this;for(let b=T;b<_;++b)for(let D=p;D<g;++D){let L;this.planarConfiguration===1&&(L=this.getTileOrStrip(D,b,0,s,h));for(let v=0;v<t.length;++v){const B=v,X=t[v];this.planarConfiguration===2&&(y=this.getSampleByteSize(X),L=this.getTileOrStrip(D,b,X,s,h));const M=L.then(k=>{const Ue=k.data,Kr=new DataView(Ue),ve=this.getBlockHeight(k.y),he=k.y*u,xe=k.x*c,Yr=he+ve,qr=(k.x+1)*c,Wr=R[B],Zr=Math.min(ve,ve-(Yr-e[3]),f-he),Jr=Math.min(c,c-(qr-e[2]),d-xe);for(let ue=Math.max(0,e[1]-he);ue<Zr;++ue)for(let fe=Math.max(0,e[0]-xe);fe<Jr;++fe){const Qr=(ue*c+fe)*y,Ct=Wr.call(Kr,Qr+x[B],S);let Re;n?(Re=(ue+he-e[1])*E*t.length+(fe+xe-e[0])*t.length+B,r[Re]=Ct):(Re=(ue+he-e[1])*E+fe+xe-e[0],r[B][Re]=Ct)}});A.push(M)}}if(await Promise.all(A),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let b;return n?b=Bn(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):b=Nn(r,e[2]-e[0],e[3]-e[1],o,a,l),b.width=o,b.height=a,b}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:n=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:h}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=c[2]-c[0],d=c[3]-c[1],f=u*d,p=this.getSamplesPerPixel();if(!t||!t.length)for(let E=0;E<p;++E)t.push(E);else for(let E=0;E<t.length;++E)if(t[E]>=p)return Promise.reject(new RangeError(`Invalid sample index '${t[E]}'.`));let g;if(r){const E=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,y=Math.max.apply(null,this.fileDirectory.BitsPerSample);g=Ze(E,y,f*t.length),l&&g.fill(l)}else{g=[];for(let E=0;E<t.length;++E){const y=this.getArrayForSample(t[E],f);Array.isArray(l)&&E<l.length?y.fill(l[E]):l&&!Array.isArray(l)&&y.fill(l),g.push(y)}}const T=n||await br(this.fileDirectory);return await this._readRaster(c,t,g,r,T,s,o,a,h)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:n,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const h=e||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");const c=this.fileDirectory.PhotometricInterpretation;if(c===z.RGB){let _=[0,1,2];if(this.fileDirectory.ExtraSamples!==Rn.Unspecified&&a){_=[];for(let E=0;E<this.fileDirectory.BitsPerSample.length;E+=1)_.push(E)}return this.readRasters({window:e,interleave:t,samples:_,pool:r,width:n,height:s,resampleMethod:o,signal:l})}let u;switch(c){case z.WhiteIsZero:case z.BlackIsZero:case z.Palette:u=[0];break;case z.CMYK:u=[0,1,2,3];break;case z.YCbCr:case z.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const d={window:h,interleave:!0,samples:u,pool:r,width:n,height:s,resampleMethod:o,signal:l},{fileDirectory:f}=this,p=await this.readRasters(d),g=2**this.fileDirectory.BitsPerSample[0];let T;switch(c){case z.WhiteIsZero:T=bn(p,g);break;case z.BlackIsZero:T=An(p,g);break;case z.Palette:T=Sn(p,f.ColorMap);break;case z.CMYK:T=In(p);break;case z.YCbCr:T=Cn(p);break;case z.CIELab:T=Ln(p);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const _=new Uint8Array(T.length/3),E=new Uint8Array(T.length/3),y=new Uint8Array(T.length/3);for(let x=0,R=0;x<T.length;x+=3,++R)_[R]=T[x],E[R]=T[x+1],y[R]=T[x+2];T=[_,E,y]}return T.width=p.width,T.height=p.height,T}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let n=yn(r,"Item");e===null?n=n.filter(s=>Be(s,"sample")===void 0):n=n.filter(s=>Number(Be(s,"sample"))===e);for(let s=0;s<n.length;++s){const o=n[s];t[Be(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return[r[0],-r[5],r[10]];if(e){const[n,s,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(){const e=this.getHeight(),t=this.getWidth();if(this.fileDirectory.ModelTransformation){const[r,n,s,o,a,l,h,c]=this.fileDirectory.ModelTransformation,d=[[0,0],[0,e],[t,0],[t,e]].map(([g,T])=>[o+r*g+n*T,c+a*g+l*T]),f=d.map(g=>g[0]),p=d.map(g=>g[1]);return[Math.min(...f),Math.min(...p),Math.max(...f),Math.max(...p)]}else{const r=this.getOrigin(),n=this.getResolution(),s=r[0],o=r[1],a=s+n[0]*this.getWidth(),l=o+n[1]*this.getHeight();return[Math.min(s,a),Math.min(o,l),Math.max(s,a),Math.max(o,l)]}}}const Ar=zn;class jn{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),n=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return n&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Tr(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class Xn{constructor(e,t,r,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const Vn=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class Hn{constructor(e=Vn,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{Z(()=>import("./decoder-88d82e9b.js"),["./decoder-88d82e9b.js","./_commonjsHelpers-39b5b250.js"],import.meta.url).then(n=>{r(n.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let n=0;n<e;n++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?br(e).then(r=>r.decode(e,t)):new Promise(r=>{const n=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];n.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(n.idle=!0,r(a.data.decoded),n.worker.removeEventListener("message",o))};n.worker.addEventListener("message",o),n.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Kn=Hn,kt=`\r
\r
`;function Sr(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const e={};for(const[t,r]of i)e[t.toLowerCase()]=r;return e}function Yn(i){const e=i.split(`\r
`).map(t=>{const r=t.split(":").map(n=>n.trim());return r[0]=r[0].toLowerCase(),r});return Sr(e)}function qn(i){const[e,...t]=i.split(";").map(n=>n.trim()),r=t.map(n=>n.split("="));return{type:e,params:Sr(r)}}function Je(i){let e,t,r;return i&&([,e,t,r]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function Wn(i,e){let t=null;const r=new TextDecoder("ascii"),n=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(i,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<i.byteLength;){const a=r.decode(new Uint8Array(i,t,Math.min(s.length+1024,i.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const h=l.indexOf(kt),c=Yn(l.substr(0,h)),{start:u,end:d,total:f}=Je(c["content-range"]),p=t+s.length+h+kt.length,g=parseInt(d,10)+1-parseInt(u,10);n.push({headers:c,data:i.slice(p,p+g),offset:u,length:g,fileSize:f}),t=p+g+4}return n}class Et{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class Zn extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this.cache.has(n)||this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function Jn(i){return new Promise(e=>setTimeout(e,i))}function Qn(i,e){const t=Array.isArray(i)?i:Array.from(i),r=Array.isArray(e)?e:Array.from(e);return t.map((n,s)=>[n,r[s]])}class ae extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,ae),this.name="AbortError"}}class es extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const ts=es;class rs{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class zt{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class is extends Et{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new Zn({maxSize:r,onEviction:(n,s)=>{this.evictedBlocks.set(n,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],n=[],s=[];this.evictedBlocks.clear();for(const{offset:d,length:f}of e){let p=d+f;const{fileSize:g}=this;g!==null&&(p=Math.min(p,g));const T=Math.floor(d/this.blockSize)*this.blockSize;for(let _=T;_<p;_+=this.blockSize){const E=Math.floor(_/this.blockSize);!this.blockCache.has(E)&&!this.blockRequests.has(E)&&(this.blockIdsToFetch.add(E),n.push(E)),this.blockRequests.has(E)&&r.push(this.blockRequests.get(E)),s.push(E)}}await Jn(),this.fetchBlocks(t);const o=[];for(const d of n)this.blockRequests.has(d)&&o.push(this.blockRequests.get(d));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=s.filter(d=>this.abortedBlockIds.has(d)||!this.blockCache.has(d));if(l.forEach(d=>this.blockIdsToFetch.add(d)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const d of l){const f=this.blockRequests.get(d);if(!f)throw new Error(`Block ${d} is not in the block requests`);a.push(f)}await Promise.allSettled(a)}if(t&&t.aborted)throw new ae("Request was aborted");const h=s.map(d=>this.blockCache.get(d)||this.evictedBlocks.get(d)),c=h.filter(d=>!d);if(c.length)throw new ts(c,"Request failed");const u=new Map(Qn(s,h));return this.readSliceData(e,u)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const s=t[n];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[n],l=o*this.blockSize,h=l-a.offset,c=Math.min(h+this.blockSize,a.data.byteLength),u=a.data.slice(h,c),d=new rs(l,u.byteLength,u,o);this.blockCache.set(o,d),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],n=null;const s=[];for(const o of t)n===null||n+1===o?(r.push(o),n=o):(s.push(new zt(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],n=o);return s.push(new zt(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let n=r.offset+r.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let h=s;h<=o;++h){const c=t.get(h),u=c.offset-r.offset,d=c.top-n;let f=0,p=0,g;u<0?f=-u:u>0&&(p=u),d<0?g=c.length-f:g=n-c.offset-f;const T=new Uint8Array(c.data,f,g);l.set(T,p)}return a})}}class mt{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class _t{constructor(e){this.url=e}async request({headers:e,credentials:t,signal:r}={}){throw new Error("request is not implemented")}}class ns extends mt{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class ss extends _t{constructor(e,t){super(e),this.credentials=t}async request({headers:e,credentials:t,signal:r}={}){const n=await fetch(this.url,{headers:e,credentials:t,signal:r});return new ns(n)}}class os extends mt{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class as extends _t{constructRequest(e,t){return new Promise((r,n)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new os(s,o))},s.onerror=n,s.onabort=()=>n(new ae("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const ke={};class ls extends mt{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class cs extends _t{constructor(e){super(e),this.parsedUrl=ke.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",ke)}constructRequest(e,t){return new Promise((r,n)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const h=[];o.on("data",c=>{h.push(c)}),o.on("end",()=>{const c=Buffer.concat(h).buffer;l(c)}),o.on("error",n)});r(new ls(o,a))});s.on("error",n),t&&(t.aborted&&s.destroy(new ae("Request aborted")),t.addEventListener("abort",()=>s.destroy(new ae("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class yt extends Et{constructor(e,t,r,n){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:s})=>`${n}-${n+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:n,params:s}=qn(r.getHeader("content-type"));if(n==="multipart/byteranges"){const u=Wn(await r.getData(),s.boundary);return this._fileSize=u[0].fileSize||null,u}const o=await r.getData(),{start:a,end:l,total:h}=Je(r.getHeader("content-range"));this._fileSize=h||null;const c=[{data:o,offset:a,length:l-a}];if(e.length>1){const u=await Promise.all(e.slice(1).map(d=>this.fetchSlice(d,t)));return c.concat(u)}return c}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await r.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:n}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+n}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Je(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function xt(i,{blockSize:e,cacheSize:t}){return e===null?i:new is(i,{blockSize:e,cacheSize:t})}function hs(i,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:n=!1,...s}={}){const o=new ss(i,t),a=new yt(o,e,r,n);return xt(a,s)}function us(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new as(i),o=new yt(s,e,t,r);return xt(o,n)}function fs(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new cs(i),o=new yt(s,e,t,r);return xt(o,n)}function Qe(i,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?hs(i,t):typeof XMLHttpRequest<"u"?us(i,t):fs(i,t)}class ds extends Et{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,n)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=n,o.onabort=n,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function gs(i){return new ds(i)}function et(i){switch(i){case P.BYTE:case P.ASCII:case P.SBYTE:case P.UNDEFINED:return 1;case P.SHORT:case P.SSHORT:return 2;case P.LONG:case P.SLONG:case P.FLOAT:case P.IFD:return 4;case P.RATIONAL:case P.SRATIONAL:case P.DOUBLE:case P.LONG8:case P.SLONG8:case P.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function ps(i){const e=i.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const n=wn[e[r]],s=e[r+1]?Te[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!s)l=a;else{if(l=i[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[n]=l}return t}function ie(i,e,t,r){let n=null,s=null;const o=et(e);switch(e){case P.BYTE:case P.ASCII:case P.UNDEFINED:n=new Uint8Array(t),s=i.readUint8;break;case P.SBYTE:n=new Int8Array(t),s=i.readInt8;break;case P.SHORT:n=new Uint16Array(t),s=i.readUint16;break;case P.SSHORT:n=new Int16Array(t),s=i.readInt16;break;case P.LONG:case P.IFD:n=new Uint32Array(t),s=i.readUint32;break;case P.SLONG:n=new Int32Array(t),s=i.readInt32;break;case P.LONG8:case P.IFD8:n=new Array(t),s=i.readUint64;break;case P.SLONG8:n=new Array(t),s=i.readInt64;break;case P.RATIONAL:n=new Uint32Array(t*2),s=i.readUint32;break;case P.SRATIONAL:n=new Int32Array(t*2),s=i.readInt32;break;case P.FLOAT:n=new Float32Array(t),s=i.readFloat32;break;case P.DOUBLE:n=new Float64Array(t),s=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===P.RATIONAL||e===P.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=s.call(i,r+a*o),n[a+1]=s.call(i,r+(a*o+4));else for(let a=0;a<t;++a)n[a]=s.call(i,r+a*o);return e===P.ASCII?new TextDecoder("utf-8").decode(n):n}class Ts{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class be extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Ir{async readRasters(e={}){const{window:t,width:r,height:n}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let h=l;const c=await this.getImageCount(),u=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||n){if(t){const[p,g]=l.getOrigin(),[T,_]=l.getResolution();a=[p+t[0]*T,g+t[1]*_,p+t[2]*T,g+t[3]*_]}const f=a||u;if(r){if(s)throw new Error("Both width and resX passed");s=(f[2]-f[0])/r}if(n){if(o)throw new Error("Both width and resY passed");o=(f[3]-f[1])/n}}if(s||o){const f=[];for(let p=0;p<c;++p){const g=await this.getImage(p),{SubfileType:T,NewSubfileType:_}=g.fileDirectory;(p===0||T===2||_&1)&&f.push(g)}f.sort((p,g)=>p.getWidth()-g.getWidth());for(let p=0;p<f.length;++p){const g=f[p],T=(u[2]-u[0])/g.getWidth(),_=(u[3]-u[1])/g.getHeight();if(h=g,s&&s>T||o&&o>_)break}}let d=t;if(a){const[f,p]=l.getOrigin(),[g,T]=h.getResolution(l);d=[Math.round((a[0]-f)/g),Math.round((a[1]-p)/T),Math.round((a[2]-f)/g),Math.round((a[3]-p)/T)],d=[Math.min(d[0],d[2]),Math.min(d[1],d[3]),Math.max(d[0],d[2]),Math.max(d[1],d[3])]}return h.readRasters({...e,window:d})}}let Pe=class Cr extends Ir{constructor(e,t,r,n,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=n,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new Xn((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let n=await this.getSlice(e);const s=this.bigTiff?n.readUint64(e):n.readUint16(e),o=s*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let u=0;u<s;l+=t,++u){const d=n.readUint16(l),f=n.readUint16(l+2),p=this.bigTiff?n.readUint64(l+4):n.readUint32(l+4);let g,T;const _=et(f),E=l+(this.bigTiff?12:8);if(_*p<=(this.bigTiff?8:4))g=ie(n,f,p,E);else{const y=n.readOffset(E),x=et(f)*p;if(n.covers(y,x))g=ie(n,f,p,y);else{const R=await this.getSlice(y,x);g=ie(R,f,p,y)}}p===1&&xn.indexOf(d)===-1&&!(f===P.RATIONAL||f===P.SRATIONAL)?T=g[0]:T=g,a[Te[d]]=T}const h=ps(a),c=n.readOffset(e+r+t*s);return new Ts(a,h,c)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof be?new be(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new be(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Ar(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof be)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let n=await this.getSlice(e,r);if(t===ie(n,P.ASCII,t.length,e)){const o=ie(n,P.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(n=await this.getSlice(e,a));const l=ie(n,P.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(h=>h.length>0).map(h=>h.split("=")).forEach(([h,c])=>{this.ghostValues[h]=c})}return this.ghostValues}static async fromSource(e,t,r){const n=(await e.fetch([{offset:0,length:1024}],r))[0],s=new jn(n),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let h;if(l===42)h=!1;else if(l===43){if(h=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const c=h?s.getUint64(8,a):s.getUint32(4,a);return new Cr(e,a,h,c,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}};class Es extends Ir{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let n=0;n<this.imageFiles.length;n++){const s=this.imageFiles[n];for(let o=0;o<this.imageCounts[n];o++){if(e===t){const a=await s.requestIFD(r);return new Ar(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function ms(i,e={},t){return Pe.fromSource(Qe(i,e),t)}async function _s(i,e){return Pe.fromSource(gs(i),e)}async function ys(i,e=[],t={},r){const n=await Pe.fromSource(Qe(i,t),r),s=await Promise.all(e.map(o=>Pe.fromSource(Qe(o,t))));return new Es(n,s)}function xs(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function Rs(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=z;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const jt="STATISTICS_MAXIMUM",Xt="STATISTICS_MINIMUM",ze=256;let je;function ws(){return je||(je=new Kn),je}function bs(i){try{return i.getBoundingBox()}catch{return[0,0,i.getWidth(),i.getHeight()]}}function As(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function Ss(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function Is(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=qe(t);if(!r){const n=Ut(e.ProjLinearUnitsGeoKey);n&&(r=new vt({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=qe(t);if(!r){const n=Ut(e.GeogAngularUnitsGeoKey);n&&(r=new vt({code:t,units:n}))}return r}return null}function Cs(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function Ps(i,e){let t;return i.blob?t=_s(i.blob):i.overviews?t=ys(i.url,i.overviews,e):t=ms(i.url,e),t.then(Cs)}function ge(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)ge(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function Ds(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function Os(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class Pr extends ki{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,opaque:e.opaque,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=Ps(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){Lt(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=Is(n);if(s){this.projection=s;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),l=new Array(e.length),h=new Array(e.length);let c=0;const u=e.length;for(let g=0;g<u;++g){const T=[],_=[];e[g].forEach(b=>{xs(b)?_.push(b):T.push(b)});const E=T.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let y,x;const R=new Array(E),A=new Array(E),S=new Array(E);l[g]=new Array(E),h[g]=new Array(E);for(let b=0;b<E;++b){const D=T[b],L=D.getGDALNoData();h[g][b]=D.getGDALMetadata(0),l[g][b]=L;const v=this.sourceInfo_[g].bands;a[g]=v?v.length:D.getSamplesPerPixel();const B=E-(b+1);y||(y=bs(D)),x||(x=As(D));const X=Ss(D,T[0]);S[B]=X[0];const M=[D.getTileWidth(),D.getTileHeight()];M[0]!==M[1]&&M[1]<ze&&(M[0]=ze,M[1]=ze),R[B]=M;const k=X[0]/Math.abs(X[1]);A[B]=[M[0],M[1]/k]}if(t?ee(t,y,t):t=y,!r)r=x;else{const b=`Origin mismatch for source ${g}, got [${x}] but expected [${r}]`;ge(r,x,0,b,this.viewRejector)}if(!o)o=S,this.resolutionFactors_[g]=1;else{o.length-c>S.length&&(c=o.length-S.length);const b=o[o.length-1]/S[S.length-1];this.resolutionFactors_[g]=b;const D=S.map(v=>v*=b),L=`Resolution mismatch for source ${g}, got [${D}] but expected [${o}]`;ge(o.slice(c,o.length),D,.02,L,this.viewRejector)}n?ge(n.slice(c,n.length),A,.01,`Tile size mismatch for source ${g}`,this.viewRejector):n=A,s?ge(s.slice(c,s.length),R,0,`Tile size mismatch for source ${g}`,this.viewRejector):s=R,this.sourceImagery_[g]=T.reverse(),this.sourceMasks_[g]=_.reverse()}for(let g=0,T=this.sourceImagery_.length;g<T;++g){const _=this.sourceImagery_[g];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=h;e:for(let g=0;g<u;++g){if(this.sourceInfo_[g].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[g].length){this.addAlpha_=!0;break}const T=l[g],_=this.sourceInfo_[g].bands;if(_){for(let E=0;E<_.length;++E)if(T[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<T.length;++E)if(T[E]!==null){this.addAlpha_=!0;break e}}let d=this.addAlpha_?1:0;for(let g=0;g<u;++g)d+=a[g];this.bandCount=d;const f=new Li({extent:t,minZoom:c,origin:r,resolutions:o,tileSizes:n});this.tileGrid=f,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const p=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]),this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:ri(ii(t),this.projection),extent:ni(t,this.projection),zoom:p})}loadTile_(e,t,r){const n=this.getTileSize(e),s=this.sourceImagery_.length,o=new Array(s*2),a=this.nodataValues_,l=this.sourceInfo_,h=ws();for(let c=0;c<s;++c){const u=l[c],d=this.resolutionFactors_[c],f=[Math.round(t*(n[0]*d)),Math.round(r*(n[1]*d)),Math.round((t+1)*(n[0]*d)),Math.round((r+1)*(n[1]*d))],p=this.sourceImagery_[c][e];let g;u.bands&&(g=u.bands.map(function(x){return x-1}));let T;"nodata"in u&&u.nodata!==null?T=u.nodata:g?T=g.map(function(x){return a[c][x]}):T=a[c];const _={window:f,width:n[0],height:n[1],samples:g,fillValue:T,pool:h,interleave:!1};Rs(this.convertToRGB_,p)?o[c]=p.readRGB(_):o[c]=p.readRasters(_);const E=s+c,y=this.sourceMasks_[c][e];if(!y){o[E]=Promise.resolve(null);continue}o[E]=y.readRasters({window:f,width:n[0],height:n[1],samples:[0],pool:h,interleave:!1})}return Promise.all(o).then(this.composeTile_.bind(this,n)).catch(function(c){throw Lt(c),c})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,h=this.normalize_,c=this.addAlpha_,u=e[0]*e[1],d=u*o;let f;h?f=new Uint8Array(d):f=new Float32Array(d);let p=0;for(let g=0;g<u;++g){let T=c;for(let _=0;_<s;++_){const E=n[_];let y=E.min,x=E.max,R,A;if(h){const S=r[_][0];y===void 0&&(S&&Xt in S?y=parseFloat(S[Xt]):y=Ds(t[_][0])),x===void 0&&(S&&jt in S?x=parseFloat(S[jt]):x=Os(t[_][0])),R=255/(x-y),A=-y*R}for(let S=0;S<a[_];++S){const b=t[_][S][g];let D;if(h?D=Ye(R*b+A,0,255):D=b,!c)f[p]=D;else{let L=E.nodata;if(L===void 0){let B;E.bands?B=E.bands[S]-1:B=S,L=l[_][B]}const v=isNaN(L);(!v&&b!==L||v&&!isNaN(b))&&(T=!1,f[p]=D)}p++}if(!T){const S=s+_,b=t[S];b&&!b[0][g]&&(T=!0)}}c&&(T||(f[p]=255),p++)}return f}}Pr.prototype.getView;const Bo=Pr,Rt=34962,wt=34963,Ls=35040,bt=35044,Us=35048,vs=5121,Ns=5123,Gs=5125,Dr=5126,Vt=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Fs(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!si},e);const t=Vt.length;for(let r=0;r<t;++r)try{const n=i.getContext(Vt[r],e);if(n)return n}catch{}return null}const Bs={STATIC_DRAW:bt,STREAM_DRAW:Ls,DYNAMIC_DRAW:Us};class Ms{constructor(e,t){this.array=null,this.type=e,oi(e===Rt||e===wt,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage=t!==void 0?t:Bs.STATIC_DRAW}ofSize(e){return this.array=new(Xe(this.type))(e),this}fromArray(e){return this.array=Xe(this.type).from(e),this}fromArrayBuffer(e){return this.array=new(Xe(this.type))(e),this}getType(){return this.type}getArray(){return this.array}getUsage(){return this.usage}getSize(){return this.array?this.array.length:0}}function Xe(i){switch(i){case Rt:return Float32Array;case wt:return Uint32Array;default:return Float32Array}}const Or=Ms,Ae={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},$s=`
  precision mediump float;
  
  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;
  
  uniform vec2 u_screenSize;
   
  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,ks=`
  precision mediump float;
   
  uniform sampler2D u_image;
  uniform float u_opacity;
   
  varying vec2 v_texCoord;
   
  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class zs{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||$s),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||ks),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,h=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,l,h),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=j(s.canvas);if(!e.renderTargets[l]){const h=s.getContextAttributes();h&&h.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const Ht=zs;function Lr(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Ur(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}const q={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},pe={UNSIGNED_BYTE:vs,UNSIGNED_SHORT:Ns,UNSIGNED_INT:Gs,FLOAT:Dr},De={};function Kt(i){return"shared/"+i}let Yt=0;function js(){const i="unique/"+Yt;return Yt+=1,i}function Xs(i){let e=De[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Fs(t)},De[i]=e}return e.users+=1,e.context}function Vs(i){const e=De[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete De[i]}class Hs extends ai{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Kt(e.canvasCacheKey):js(),this.gl_=Xs(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(Ae.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(Ae.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Ie(),this.offsetScaleMatrix_=Ie(),this.tmpMat4_=Lr(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new Ht({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new Ht({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Kt(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=j(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=this.gl_,r=j(e),n=this.bufferCache_[r];n&&!t.isContextLost()&&t.deleteBuffer(n.webGlBuffer),delete this.bufferCache_[r]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(Ae.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(Ae.RESTORED,this.boundHandleWebGLContextRestored_),Vs(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(q.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(q.ZOOM,e.viewState.zoom),this.setUniformFloatValue(q.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(q.PIXEL_RATIO,n),this.setUniformFloatVec2(q.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(q.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(q.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(q.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData)s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(!(r instanceof HTMLImageElement)||r.complete)&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++;else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,Ur(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,this.applyFrameState(t),this.applyUniforms(t)}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=j(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=j(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return Qt(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,n,s))}enableAttributes(e){const t=Ks(e);let r=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||Dr,t,r),r+=s.size*vr(s.type)}}handleWebGLContextLost(e){li(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r){const n=this.gl_;r=r||n.createTexture();const s=0,o=n.RGBA,a=0,l=n.RGBA,h=n.UNSIGNED_BYTE;return n.bindTexture(n.TEXTURE_2D,r),t?n.texImage2D(n.TEXTURE_2D,s,o,l,h,t):n.texImage2D(n.TEXTURE_2D,s,o,e[0],e[1],a,l,h,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),r}}function Ks(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*vr(r.type)}return e}function vr(i){switch(i){case pe.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case pe.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case pe.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case pe.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class At extends ci{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Ie(),this.pixelContext_=null,this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,e.addChangeListener(er.MAP,this.removeHelper.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(te.PRECOMPOSE)){const n=new Ne(te.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(te.POSTCOMPOSE)){const n=new Ne(te.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,h=l.getRenderer();if(!(h instanceof At)){t=!0;continue}const c=l.getClassName();if((t||c!==n)&&(r+=1,t=!1),n=c,h===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Hs({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){Qt(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new Ne(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(te.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(te.POSTRENDER,e,t)}}const Ys=At;class qs{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}}const Ws=qs;class Zs extends hi{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter_=e.gutter||0,this.helper_=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(Q.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===O.LOADED,this.loaded)this.uploadTile();else{if(e instanceof ir){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(Q.CHANGE,this.handleTileChange_)}}uploadTile(){tr()}setReady(){this.ready=!0,this.dispatchEvent(Q.CHANGE)}handleTileChange_(){this.tile.getState()===O.LOADED&&(this.loaded=!0,this.uploadTile())}disposeInternal(){this.tile.removeEventListener(Q.CHANGE,this.handleTileChange_)}}const Js=Zs;function Nr(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function Qs(i,e,t,r){Nr(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function qt(i,e,t,r,n,s){const o=i.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),l=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Nr(o,e,s&&l);const h=t.byteLength/r[1];let c=1;h%8===0?c=8:h%4===0?c=4:h%2===0&&(c=2);let u;switch(n){case 1:{u=o.LUMINANCE;break}case 2:{u=o.LUMINANCE_ALPHA;break}case 3:{u=o.RGB;break}case 4:{u=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const d=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,c),o.texImage2D(o.TEXTURE_2D,0,u,r[0],r[1],0,u,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,d)}let ne=null;function eo(){ne=rt(1,1,void 0,{willReadFrequently:!0})}class to extends Js{constructor(e){super(e),this.textures=[],this.renderSize_=se(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Or(Rt,bt);t.fromArray([0,1,1,1,1,0,0,0]),this.helper_.flushBufferData(t),this.coords=t,this.setTile(e.tile)}uploadTile(){const e=this.helper_,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof ir||r instanceof it?n=r.getImage():n=r.getData();const s=Ce(n);if(s){const E=t.createTexture();this.textures.push(E),this.bandCount=4,Qs(t,E,s,r.interpolate),this.setReady();return}n=We(n);const o=r.getSize(),a=[o[0]+2*this.gutter_,o[1]+2*this.gutter_],l=n instanceof Float32Array,h=a[0]*a[1],c=l?Float32Array:Uint8Array,u=c.BYTES_PER_ELEMENT,d=n.byteLength/a[1];this.bandCount=Math.floor(d/u/a[0]);const f=Math.ceil(this.bandCount/4);if(f===1){const E=t.createTexture();this.textures.push(E),qt(e,E,n,a,this.bandCount,r.interpolate),this.setReady();return}const p=new Array(f);for(let E=0;E<f;++E){const y=t.createTexture();this.textures.push(y);const x=E<f-1?4:(this.bandCount-1)%4+1;p[E]=new c(h*x)}let g=0,T=0;const _=a[0]*this.bandCount;for(let E=0;E<a[1];++E){for(let y=0;y<_;++y){const x=n[T+y],R=Math.floor(g/this.bandCount),A=y%this.bandCount,S=Math.floor(A/4),b=p[S],D=b.length/h,L=A%4;b[R*D+L]=x,++g}T+=d/u}for(let E=0;E<f;++E){const y=this.textures[E],x=p[E],R=x.length/h;qt(e,y,x,a,R,r.interpolate)}this.setReady()}disposeInternal(){const e=this.helper_.getGL();this.helper_.deleteBuffer(this.coords);for(let t=0;t<this.textures.length;++t)e.deleteTexture(this.textures[t]);this.tile.removeEventListener(Q.CHANGE,this.handleTileChange_)}getImagePixelData_(e,t,r){const n=this.gutter_,s=this.renderSize_[0],o=this.renderSize_[1];ne||eo(),ne.clearRect(0,0,1,1);const a=e.width,l=e.height,h=a-2*n,c=l-2*n,u=n+Math.floor(h*(t/s)),d=n+Math.floor(c*(r/o));let f;try{ne.drawImage(e,u,d,1,1,0,0,1,1),f=ne.getImageData(0,0,1,1).data}catch{return ne=null,null}return f}getArrayPixelData_(e,t,r,n){const s=this.gutter_,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],h=t[1],c=l+2*s,u=h+2*s,d=s+Math.floor(l*(r/o)),f=s+Math.floor(h*(n/a));if(e instanceof DataView){const g=e.byteLength/(c*u),T=g*(f*c+d),_=e.buffer.slice(T,T+g);return new DataView(_)}const p=this.bandCount*(f*c+d);return e.slice(p,p+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof nt){const r=this.tile.getData(),n=We(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(Ce(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const ro=to,io={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"},no={};function so(i){return 1/(i+2)}function oo(){return{tileIds:new Set,representationsByZ:{}}}function Wt(i,e){return i.tileIds.has(j(e))}function Zt(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(j(e.tile))}function Ve(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=ee(e,rr(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=ee(e,n))}return e}function tt(i,e){return`${i.getKey()},${de(e)}`}class ao extends Ys{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Ie(),this.tempMat4=Lr(),this.tempTileRange_=new Ui(0,0,0,0),this.tempTileCoord_=Bt(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new vi(r),this.frameState=null,this.projection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}isDrawableTile_(e){const t=this.getLayer(),r=e.getState(),n=t.getUseInterimTilesOnError();return r==O.LOADED||r==O.EMPTY||r==O.ERROR&&!n}prepareFrameInternal(e){this.projection_?e.viewState.projection!==this.projection_&&(this.clearCache(),this.projection_=e.viewState.projection):this.projection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||ui(Ve(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return tr()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),h=l.getTileGridForProjection(o.projection),c=l.getGutterForProjection(o.projection),u=j(l);u in e.wantedTiles||(e.wantedTiles[u]={});const d=e.wantedTiles[u],f=this.tileRepresentationCache,p=a.getMapInternal(),g=Math.max(r-s,h.getMinZoom(),h.getZForResolution(Math.min(a.getMaxResolution(),p?p.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):h.getResolution(0)),l.zDirection));for(let T=r;T>=g;--T){const _=h.getTileRangeForExtentAndZ(t,T,this.tempTileRange_),E=h.getResolution(T);for(let y=_.minX;y<=_.maxX;++y)for(let x=_.minY;x<=_.maxY;++x){const R=Bt(T,y,x,this.tempTileCoord_),A=tt(l,R);let S,b;if(f.containsKey(A)&&(S=f.get(A),b=S.tile),(!S||S.tile.key!==l.getKey())&&(b=l.getTile(T,y,x,e.pixelRatio,o.projection)),Wt(n,b))continue;if(!S)S=this.createTileRepresentation({tile:b,grid:h,helper:this.helper,gutter:c}),f.set(A,S);else if(this.isDrawableTile_(b))S.setTile(b);else{const L=b.getInterimTile();S.setTile(L)}Zt(n,S,T);const D=b.getKey();d[D]=!0,b.getState()===O.IDLE&&(e.tileQueue.isKeyQueued(D)||e.tileQueue.enqueue([b,u,h.getTileCoordCenter(R),E]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}renderTile(e,t,r,n,s,o,a,l,h,c,u){}drawTile_(e,t,r,n,s,o,a){if(!t.loaded)return;const h=t.tile.tileCoord,c=de(h),u=c in o?o[c]:1,d=a.getResolution(r),f=se(a.getTileSize(r),this.tempSize_),p=a.getOrigin(r),g=a.getTileCoordExtent(h),T=u<1?-1:so(r);u<1&&(e.animate=!0);const _=e.viewState,E=_.center[0],y=_.center[1],x=f[0]+2*n,R=f[1]+2*n,A=x/R,S=(E-p[0])/(f[0]*d),b=(p[1]-y)/(f[1]*d),D=_.resolution/d,L=h[1],v=h[2];fi(this.tileTransform_),Nt(this.tileTransform_,2/(e.size[0]*D/x),-2/(e.size[1]*D/x)),di(this.tileTransform_,_.rotation),Nt(this.tileTransform_,1,1/A),gi(this.tileTransform_,(f[0]*(L-S)-n)/x,(f[1]*(v-b)-n)/R),this.renderTile(t,this.tileTransform_,e,s,d,f,p,g,T,n,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=Ve(e,e.extent),h=o.getZForResolution(r.resolution,s.zDirection),c=oo(),u=n.getPreload();if(e.nextExtent){const R=o.getZForResolution(r.nextResolution,s.zDirection),A=Ve(e,e.nextExtent);this.enqueueTiles(e,A,R,c,u)}this.enqueueTiles(e,l,h,c,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,l,h-1,c,u-1)},0);const d={},f=j(this),p=e.time;let g=!1;for(const R of c.representationsByZ[h]){const A=R.tile;if((A instanceof it||A instanceof st)&&A.getState()===O.EMPTY)continue;const S=A.tileCoord;if(R.loaded){const L=A.getAlpha(f,p);if(L===1){A.endTransition(f);continue}g=!0;const v=de(S);d[v]=L}if(this.renderComplete=!1,this.findAltTiles_(o,S,h+1,c))continue;const D=o.getMinZoom();for(let L=h-1;L>=D&&!this.findAltTiles_(o,S,L,c);--L);}this.beforeTilesRender(e,g);const T=c.representationsByZ,_=Object.keys(T).map(Number).sort(pi);for(let R=0,A=_.length;R<A;++R){const S=_[R];for(const b of T[S]){const D=b.tile.tileCoord;de(D)in d||this.drawTile_(e,b,S,a,l,d,o)}}for(const R of T[h]){const A=R.tile.tileCoord;de(A)in d&&this.drawTile_(e,R,h,a,l,d,o)}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const E=this.helper.getCanvas(),y=this.tileRepresentationCache;for(;y.canExpireCache();)y.pop().dispose();const x=function(R,A){s.updateCacheSize(.1,A.viewState.projection),s.expireCache(A.viewState.projection,no)};return e.postRenderFunctions.push(x),this.postRender(t,e),E}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let h=s.minX;h<=s.maxX;++h)for(let c=s.minY;c<=s.maxY;++c){const u=tt(l,[r,h,c]);let d=!1;if(a.containsKey(u)){const f=a.get(u);f.loaded&&!Wt(n,f.tile)&&(Zt(n,f,r),d=!0)}d||(o=!1)}return o}clearCache(){const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}removeHelper(){this.helper&&this.clearCache(),super.removeHelper()}disposeInternal(){super.disposeInternal(),delete this.frameState}}const lo=ao,C={...io,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},Se={TEXTURE_COORD:"a_textureCoord"},co=[{name:Se.TEXTURE_COORD,size:2,type:pe.FLOAT}];class ho extends lo{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Or(wt,bt),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){super.reset(e),this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}createTileRepresentation(e){return new ro(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,l,h,c,u){const d=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(co);let f=0;for(;f<e.textures.length;){const A=`${C.TILE_TEXTURE_ARRAY}[${f}]`;this.helper.bindTexture(e.textures[f],f,A),++f}for(let A=0;A<this.paletteTextures_.length;++A){const S=this.paletteTextures_[A],b=S.getTexture(d);this.helper.bindTexture(b,f,S.name),++f}const p=r.viewState,g=o[0]+2*c,T=o[1]+2*c,E=e.tile.tileCoord,y=E[1],x=E[2];this.helper.setUniformMatrixValue(C.TILE_TRANSFORM,Ur(this.tempMat4,t)),this.helper.setUniformFloatValue(C.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(C.DEPTH,h);let R=n;c>0&&(R=l,ee(R,n,R)),this.helper.setUniformFloatVec4(C.RENDER_EXTENT,R),this.helper.setUniformFloatValue(C.RESOLUTION,p.resolution),this.helper.setUniformFloatValue(C.ZOOM,p.zoom),this.helper.setUniformFloatValue(C.TEXTURE_PIXEL_WIDTH,g),this.helper.setUniformFloatValue(C.TEXTURE_PIXEL_HEIGHT,T),this.helper.setUniformFloatValue(C.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(C.TEXTURE_ORIGIN_X,a[0]+y*o[0]*s-c*s),this.helper.setUniformFloatValue(C.TEXTURE_ORIGIN_Y,a[1]-x*o[1]*s+c*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=Ti(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!Gt(rr(a,o.projection),s))return null;const l=n.getSources(Ei([s]),o.resolution);let h,c,u;for(h=l.length-1;h>=0;--h)if(c=l[h],c.getState()==="ready"){if(u=c.getTileGridForProjection(o.projection),c.getWrapX())break;const f=u.getExtent();if(!f||Gt(f,s))break}if(h<0)return null;const d=this.tileRepresentationCache;for(let f=u.getZForResolution(o.resolution);f>=u.getMinZoom();--f){const p=u.getTileCoordForCoordAndZ(s,f),g=tt(c,p);if(!d.containsKey(g))continue;const T=d.get(g),_=T.tile;if((_ instanceof it||_ instanceof st)&&_.getState()===O.EMPTY)return null;if(!T.loaded)continue;const E=u.getOrigin(f),y=se(u.getTileSize(f)),x=u.getResolution(f),R=(s[0]-E[0])/x-p[1]*y[0],A=(E[1]-s[1])/x-p[2]*y[1];return T.getPixelData(R,A)}return null}disposeInternal(){const e=this.helper;e&&(e.getGL().deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)),super.disposeInternal(),delete this.indices_}}const uo=ho,m={NUMBER:1,STRING:2,COLOR:4,BOOLEAN:8,NUMBER_ARRAY:16,ANY:31,NONE:0};function fo(i){switch(i){case"string":return m.STRING;case"color":return m.COLOR;case"number":return m.NUMBER;case"boolean":return m.BOOLEAN;case"number[]":return m.NUMBER_ARRAY;default:throw new Error(`Unrecognized type hint: ${i}`)}}const I={};function G(i){if(typeof i=="number")return m.NUMBER;if(typeof i=="boolean")return m.BOOLEAN;if(typeof i=="string")return _i(i)?m.COLOR|m.STRING:m.STRING;if(!Array.isArray(i))throw new Error(`Unhandled value type: ${JSON.stringify(i)}`);const e=i;if(e.every(function(n){return typeof n=="number"}))return e.length===3||e.length===4?m.COLOR|m.NUMBER_ARRAY:m.NUMBER_ARRAY;if(typeof e[0]!="string")throw new Error(`Expected an expression operator but received: ${JSON.stringify(e)}`);const r=I[e[0]];if(r===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return r.getReturnType(e.slice(1))}function go(i){return Math.log2(i)%1===0}function W(i){const e=[];return(i&m.NUMBER)>0&&e.push("number"),(i&m.COLOR)>0&&e.push("color"),(i&m.BOOLEAN)>0&&e.push("boolean"),(i&m.NUMBER_ARRAY)>0&&e.push("number[]"),(i&m.STRING)>0&&e.push("string"),e.length>0?e.join(", "):"(no type)"}function po(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function Le(i){const e=i.toString();return e.includes(".")?e:e+".0"}function Gr(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(Le).join(", ")})`}function To(i){const e=yi(i),t=e.length>3?e[3]:1;return Gr([e[0]/255*t,e[1]/255*t,e[2]/255*t,t])}const He={};let Eo=0;function Fr(i){return i in He||(He[i]=Eo++),He[i]}function mo(i){return Le(Fr(i))}function w(i,e,t){const r=t!==void 0?t:m.NUMBER;if(Array.isArray(e)&&typeof e[0]=="string"){const s=I[e[0]];if(s===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return s.toGlsl(i,e.slice(1),r)}const n=G(e)&r;if(kr(e,n,""),(n&m.NUMBER)>0)return Le(e);if((n&m.BOOLEAN)>0)return e.toString();if((n&m.STRING)>0)return mo(e.toString());if((n&m.COLOR)>0)return To(e);if((n&m.NUMBER_ARRAY)>0)return Gr(e);throw new Error(`Unexpected expression ${e} (expected type ${W(r)})`)}function Br(i){if(!(G(i)&m.NUMBER))throw new Error(`A numeric value was expected, got ${JSON.stringify(i)} instead`)}function N(i){for(let e=0;e<i.length;e++)Br(i[e])}function Mr(i){if(!(G(i)&m.STRING))throw new Error(`A string value was expected, got ${JSON.stringify(i)} instead`)}function St(i){if(!(G(i)&m.BOOLEAN))throw new Error(`A boolean value was expected, got ${JSON.stringify(i)} instead`)}function U(i,e){if(i.length!==e)throw new Error(`Exactly ${e} arguments were expected, got ${i.length} instead`)}function V(i,e){if(i.length<e)throw new Error(`At least ${e} arguments were expected, got ${i.length} instead`)}function _e(i,e){if(i.length>e)throw new Error(`At most ${e} arguments were expected, got ${i.length} instead`)}function $r(i){if(i.length%2!==0)throw new Error(`An even amount of arguments was expected, got ${JSON.stringify(i)} instead`)}function _o(i){if(i.length%2===0)throw new Error(`An odd amount of arguments was expected, got ${JSON.stringify(i)} instead`)}function kr(i,e,t){if(e===m.NONE)throw new Error(`No matching type was found for the following expression ${t}: ${JSON.stringify(i)}`)}function ye(i,e,t){if(kr(i,e,t),!go(e))throw new Error(`Expected to have a unique type for the following expression ${t}: ${JSON.stringify(i)}
Got the following types instead: ${W(e)}`)}function It(i,e,t,r){if((e&t)===m.NONE)throw new Error(`Expected the ${r} type of the following expression: ${JSON.stringify(i)} to be of the following types: ${W(t)}
Got these types instead: ${W(e)}`)}I.get={getReturnType:function(i){if(i.length===2){const e=i[1];return fo(e)}return m.ANY},toGlsl:function(i,e,t){V(e,1),_e(e,2),Mr(e[0]);const r=t&I.get.getReturnType(e);ye(["get",...e],r,"");const n=e[0].toString(),s=i.attributes.find(a=>a.name===n);if(!s)i.attributes.push({name:n,type:r});else if(r!==s.type)throw new Error(`The following attribute was used in different places with incompatible types: ${n}
Types were: ${W(s.type)} and ${W(r)}`);return(i.inFragmentShader?"v_":"a_")+n}};function zr(i){return"u_var_"+i}I.var={getReturnType:function(){return m.ANY},toGlsl:function(i,e,t){U(e,1),Mr(e[0]);const r=e[0].toString();if(!i.style.variables||i.style.variables[r]===void 0)throw new Error(`The following variable is missing from the style: ${r}`);const n=i.style.variables[r],s=t&G(n);ye(["var",...e],s,"");const o=i.variables.find(a=>a.name===r);if(!o)i.variables.push({name:r,type:s});else if(s!==o.type)throw new Error(`The following variable was used in different places with incompatible types: ${r}
Types were: ${W(o.type)} and ${W(s)}`);return zr(r)}};const jr="u_paletteTextures";I.palette={getReturnType:function(){return m.COLOR},toGlsl:function(i,e){U(e,2),Br(e[0]);const t=w(i,e[0]),r=e[1];if(!Array.isArray(r))throw new Error("The second argument of palette must be an array");const n=r.length,s=new Uint8Array(n*4);for(let l=0;l<n;l++){const h=r[l];let c;if(typeof h=="string")c=mi(h);else{if(!Array.isArray(h))throw new Error("The second argument of palette must be an array of strings or colors");const d=h.length;if(d===4)c=h;else{if(d!==3)throw new Error(`Expected palette color to have 3 or 4 values, got ${d}`);c=[h[0],h[1],h[2],1]}}const u=l*4;s[u]=c[0],s[u+1]=c[1],s[u+2]=c[2],s[u+3]=c[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${jr}[${i.paletteTextures.length}]`,a=new Ws(o,s);return i.paletteTextures.push(a),`texture2D(${o}, vec2((${t} + 0.5) / ${n}.0, 0.5))`}};const Ke="getBandValue";I.band={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){V(e,1),_e(e,3);const t=e[0];if(!(Ke in i.functions)){let o="";const a=i.bandCount||1;for(let l=0;l<a;l++){const h=Math.floor(l/4);let c=l%4;l===a-1&&c===1&&(c=3);const u=`${C.TILE_TEXTURE_ARRAY}[${h}]`;o+=`
          if (band == ${l+1}.0) {
            return texture2D(${u}, v_textureCoord + vec2(dx, dy))[${c}];
          }
        `}i.functions[Ke]=`
        float getBandValue(float band, float xOffset, float yOffset) {
          float dx = xOffset / ${C.TEXTURE_PIXEL_WIDTH};
          float dy = yOffset / ${C.TEXTURE_PIXEL_HEIGHT};
          ${o}
        }
      `}const r=w(i,t),n=w(i,e[1]||0),s=w(i,e[2]||0);return`${Ke}(${r}, ${n}, ${s})`}};I.time={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,0),"u_time"}};I.zoom={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,0),"u_zoom"}};I.resolution={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,0),"u_resolution"}};I["geometry-type"]={getReturnType:function(){return m.STRING},toGlsl:function(i,e){U(e,0);const t="geometryType",r=o=>{const a=o.getType();switch(a){case"Point":case"LineString":case"Polygon":return a;case"MultiPoint":case"MultiLineString":case"MultiPolygon":return a.substring(5);case"Circle":return"Polygon";case"GeometryCollection":return r(o.getGeometries()[0])}};return i.attributes.find(o=>o.name===t)||i.attributes.push({name:t,type:m.STRING,callback:o=>r(o.getGeometry())}),(i.inFragmentShader?"v_":"a_")+t}};I["*"]={getReturnType:function(i){let e=m.NUMBER|m.COLOR;for(let t=0;t<i.length;t++)e=e&G(i[t]);return e},toGlsl:function(i,e,t){V(e,2);let r=t;for(let n=0;n<e.length;n++)r=r&G(e[n]);return It(e,r,m.NUMBER|m.COLOR,"output"),`(${e.map(n=>w(i,n,r)).join(" * ")})`}};I["/"]={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} / ${w(i,e[1])})`}};I["+"]={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return V(e,2),N(e),`(${e.map(t=>w(i,t)).join(" + ")})`}};I["-"]={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} - ${w(i,e[1])})`}};I.clamp={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){U(e,3),N(e);const t=w(i,e[1]),r=w(i,e[2]);return`clamp(${w(i,e[0])}, ${t}, ${r})`}};I["%"]={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,2),N(e),`mod(${w(i,e[0])}, ${w(i,e[1])})`}};I["^"]={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,2),N(e),`pow(${w(i,e[0])}, ${w(i,e[1])})`}};I.abs={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`abs(${w(i,e[0])})`}};I.floor={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`floor(${w(i,e[0])})`}};I.round={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`floor(${w(i,e[0])} + 0.5)`}};I.ceil={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`ceil(${w(i,e[0])})`}};I.sin={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`sin(${w(i,e[0])})`}};I.cos={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`cos(${w(i,e[0])})`}};I.atan={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return V(e,1),_e(e,2),N(e),e.length===2?`atan(${w(i,e[0])}, ${w(i,e[1])})`:`atan(${w(i,e[0])})`}};I.sqrt={getReturnType:function(){return m.NUMBER},toGlsl:function(i,e){return U(e,1),N(e),`sqrt(${w(i,e[0])})`}};I[">"]={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} > ${w(i,e[1])})`}};I[">="]={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} >= ${w(i,e[1])})`}};I["<"]={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} < ${w(i,e[1])})`}};I["<="]={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){return U(e,2),N(e),`(${w(i,e[0])} <= ${w(i,e[1])})`}};function Xr(i){return{getReturnType:function(){return m.BOOLEAN},toGlsl:function(e,t){U(t,2);let r=m.ANY;for(let n=0;n<t.length;n++)r&=G(t[n]);if(r===m.NONE)throw new Error(`All arguments should be of compatible type, got ${JSON.stringify(t)} instead`);return r&=~m.COLOR,`(${w(e,t[0],r)} ${i} ${w(e,t[1],r)})`}}}I["=="]=Xr("==");I["!="]=Xr("!=");I["!"]={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){return U(e,1),St(e[0]),`(!${w(i,e[0],m.BOOLEAN)})`}};function Vr(i){return{getReturnType:function(){return m.BOOLEAN},toGlsl:function(e,t){V(t,2);for(let n=0;n<t.length;n++)St(t[n]);let r=t.map(n=>w(e,n,m.BOOLEAN)).join(` ${i} `);return r=`(${r})`,r}}}I.all=Vr("&&");I.any=Vr("||");I.between={getReturnType:function(){return m.BOOLEAN},toGlsl:function(i,e){U(e,3),N(e);const t=w(i,e[1]),r=w(i,e[2]),n=w(i,e[0]);return`(${n} >= ${t} && ${n} <= ${r})`}};I.array={getReturnType:function(){return m.NUMBER_ARRAY},toGlsl:function(i,e){V(e,2),_e(e,4),N(e);const t=e.map(function(r){return w(i,r)});return`vec${e.length}(${t.join(", ")})`}};I.color={getReturnType:function(){return m.COLOR},toGlsl:function(i,e){V(e,3),_e(e,4),N(e);const t=e.slice(0,3).map(n=>`${w(i,n)} / 255.0`);return e.length===3?`vec4(${t.join(", ")}, 1.0)`:`(${w(i,e[3])} * vec4(${t.join(", ")}, 1.0))`}};I.interpolate={getReturnType:function(i){let e=m.COLOR|m.NUMBER;for(let t=3;t<i.length;t+=2)e=e&G(i[t]);return e},toGlsl:function(i,e,t){$r(e),V(e,6);const r=e[0];let n;switch(r[0]){case"linear":n=1;break;case"exponential":n=r[1];break;default:n=null}if(!n)throw new Error(`Invalid interpolation type for "interpolate" operator, received: ${JSON.stringify(r)}`);const s=m.NUMBER,o=I.interpolate.getReturnType(e)&t;ye(["interpolate",...e],o,"output");const a=w(i,e[1],s),l=Le(n);let h="";for(let c=2;c<e.length-2;c+=2){const u=w(i,e[c],s),d=h||w(i,e[c+1],o),f=w(i,e[c+2],s),p=w(i,e[c+3],o);let g;n===1?g=`(${a} - ${u}) / (${f} - ${u})`:g=`(pow(${l}, (${a} - ${u})) - 1.0) / (pow(${l}, (${f} - ${u})) - 1.0)`,h=`mix(${d}, ${p}, clamp(${g}, 0.0, 1.0))`}return h}};I.match={getReturnType:function(i){let e=m.ANY;for(let t=2;t<i.length;t+=2)e=e&G(i[t]);return e=e&G(i[i.length-1]),e},toGlsl:function(i,e,t){$r(e),V(e,4);let r=G(e[0]);for(let l=1;l<e.length-1;l+=2)r=r&G(e[l]);It(["match",...e],r,m.STRING|m.NUMBER|m.BOOLEAN,"input"),r=(m.STRING|m.NUMBER|m.BOOLEAN)&r;const n=I.match.getReturnType(e)&t;ye(["match",...e],n,"output");const s=w(i,e[0],r),o=w(i,e[e.length-1],n);let a=null;for(let l=e.length-3;l>=1;l-=2){const h=w(i,e[l],r),c=w(i,e[l+1],n);a=`(${s} == ${h} ? ${c} : ${a||o})`}return a}};I.case={getReturnType:function(i){let e=m.ANY;for(let t=1;t<i.length;t+=2)e=e&G(i[t]);return e=e&G(i[i.length-1]),e},toGlsl:function(i,e,t){_o(e),V(e,3);const r=I.case.getReturnType(e)&t;ye(["case",...e],r,"output");for(let o=0;o<e.length-1;o+=2)St(e[o]);const n=w(i,e[e.length-1],r);let s=null;for(let o=e.length-3;o>=0;o-=2){const a=w(i,e[o],m.BOOLEAN),l=w(i,e[o+1],r);s=`(${a} ? ${l} : ${s||n})`}return s}};I.in={getReturnType:function(i){return m.BOOLEAN},toGlsl:function(i,e){U(e,2);const t=e[0];let r=e[1];if(!Array.isArray(r))throw new Error('The "in" operator expects an array literal as its second argument.');if(typeof r[0]=="string"){if(r[0]!=="literal")throw new Error('For the "in" operator, a string array should be wrapped in a "literal" operator to disambiguate from expressions.');if(!Array.isArray(r[1]))throw new Error('The "in" operator was provided a literal value which was not an array as second argument.');r=r[1]}let n=G(t);for(let a=0;a<r.length-1;a+=1)n=n&G(r[a]);It(["match",...e],n,m.STRING|m.NUMBER|m.BOOLEAN,"input"),n=(m.STRING|m.NUMBER|m.BOOLEAN)&n;const s=po("in",i),o=[];for(let a=0;a<r.length;a+=1)o.push(`  if (inputValue == ${w(i,r[a],n)}) { return true; }`);return i.functions[s]=`bool ${s}(float inputValue) {
${o.join(`
`)}
  return false;
}`,`${s}(${w(i,t,n)})`}};function Jt(i,e){const t=`
    attribute vec2 ${Se.TEXTURE_COORD};
    uniform mat4 ${C.TILE_TRANSFORM};
    uniform float ${C.TEXTURE_PIXEL_WIDTH};
    uniform float ${C.TEXTURE_PIXEL_HEIGHT};
    uniform float ${C.TEXTURE_RESOLUTION};
    uniform float ${C.TEXTURE_ORIGIN_X};
    uniform float ${C.TEXTURE_ORIGIN_Y};
    uniform float ${C.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${Se.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${C.TEXTURE_ORIGIN_X} + ${C.TEXTURE_RESOLUTION} * ${C.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${C.TEXTURE_ORIGIN_Y} - ${C.TEXTURE_RESOLUTION} * ${C.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${C.TILE_TRANSFORM} * vec4(${Se.TEXTURE_COORD}, ${C.DEPTH}, 1.0);
    }
  `,r={inFragmentShader:!0,variables:[],attributes:[],functions:{},bandCount:e,style:i},n=[];if(i.color!==void 0){const u=w(r,i.color,m.COLOR);n.push(`color = ${u};`)}if(i.contrast!==void 0){const u=w(r,i.contrast,m.NUMBER);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb - (${u} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const u=w(r,i.exposure,m.NUMBER);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const u=w(r,i.saturation,m.NUMBER);n.push(`
      float saturation = ${u} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const u=w(r,i.gamma,m.NUMBER);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${u}));`)}if(i.brightness!==void 0){const u=w(r,i.brightness,m.NUMBER);n.push(`color.rgb = clamp(color.rgb + ${u}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=r.variables.length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let u=0;u<o;++u){const d=r.variables[u];if(!(d.name in i.variables))throw new Error(`Missing '${d.name}' in style variables`);const f=zr(d.name);s[f]=function(){let p=i.variables[d.name];return typeof p=="string"&&(p=Fr(p)),p!==void 0?p:-9999999}}const a=Object.keys(s).map(function(u){return`uniform float ${u};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${C.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${jr}[${r.paletteTextures.length}];`);const h=Object.keys(r.functions).map(function(u){return r.functions[u]}),c=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${C.RENDER_EXTENT};
    uniform float ${C.TRANSITION_ALPHA};
    uniform float ${C.TEXTURE_PIXEL_WIDTH};
    uniform float ${C.TEXTURE_PIXEL_HEIGHT};
    uniform float ${C.RESOLUTION};
    uniform float ${C.ZOOM};

    ${a.join(`
`)}

    ${h.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${C.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${C.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${C.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${C.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${C.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${C.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:c,uniforms:s,paletteTextures:r.paletteTextures}}class Hr extends Ni{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style;const r=e.cacheSize;delete e.cacheSize,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.cacheSize_=r,this.styleVariables_=this.style_.variables||{},this.addChangeListener(er.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache(),this.getSource()&&this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Jt(this.style_,this.getSourceBandCount_());return new uo(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.cacheSize_,paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const h=n[a],c=h.getState();if(c=="loading"){const u=()=>{h.getState()=="ready"&&(h.removeEventListener("change",u),this.changed())};h.addEventListener("change",u)}s=s&&c=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){this.styleVariables_=e.variables||{},this.style_=e;const t=Jt(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms}),this.changed()}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}Hr.prototype.dispose;const Mo=Hr;export{Bo as G,Go as L,Mo as T,Fo as a};
