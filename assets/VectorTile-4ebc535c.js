import{B as Q,l as ee}from"./featureloader-4f961e27.js";import{C as U,E as K,H as N,c as te,h as re}from"./hitdetect-4f776f31.js";import{C as ie}from"./TileLayer-d6ace1df.js";import{aA as oe,T as E,aM as D,Y as I,u as X,aN as P,a2 as ne,i as O,e as se,R as le,aO as ae,aP as ce,a1 as de,I as B,aQ as ue,aR as z,aS as k,aT as he,al as ge,J as Te,aj as fe,E as V,aU as pe,av as Re}from"./Layer-3211d6ef.js";import{r as Z,g as Ce}from"./vector-01534e8d.js";import{b as j,n as Y,e as Ee,c as xe,f as ye,o as me,p as Se,T as Ge,i as ve}from"./TileProperty-f0a52f17.js";import{U as _e}from"./UrlTile-7d5bd7ce.js";const Le={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},Ie={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class Fe extends ie{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.tmpTransform_=oe()}prepareTile(e,t,r){let i;const o=e.getState();return(o===E.LOADED||o===E.ERROR)&&(this.updateExecutorGroup_(e,t,r),this.tileImageNeedsRender_(e)&&(i=!0)),i}getTile(e,t,r,i){const o=i.pixelRatio,n=i.viewState,c=n.resolution,s=n.projection,a=this.getLayer(),l=a.getSource().getTile(e,t,r,o,s),p=i.viewHints,T=!(p[D.ANIMATING]||p[D.INTERACTING]);return(T||!l.wantedResolution)&&(l.wantedResolution=c),this.prepareTile(l,o,s)&&(T||Date.now()-i.time<8)&&a.getRenderMode()!=="vector"&&this.renderTileImage_(l,i),super.getTile(e,t,r,i)}isDrawableTile(e){const t=this.getLayer();return super.isDrawableTile(e)&&(t.getRenderMode()==="vector"?I(t)in e.executorGroups:e.hasContext(t))}getTileImage(e){return e.getImage(this.getLayer())}prepareFrame(e){const t=this.getLayer().getRevision();return this.renderedLayerRevision_!==t&&(this.renderedLayerRevision_=t,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,t,r){const i=this.getLayer(),o=i.getRevision(),n=i.getRenderOrder()||null,c=e.wantedResolution,s=e.getReplayState(i);if(!s.dirty&&s.renderedResolution===c&&s.renderedRevision==o&&s.renderedRenderOrder==n)return;const a=i.getSource(),l=i.getDeclutter(),p=a.getTileGrid(),d=a.getTileGridForProjection(r).getTileCoordExtent(e.wrappedTileCoord),u=a.getSourceTiles(t,r,e),g=I(i);delete e.hitDetectionImageData[g],e.executorGroups[g]=[],l&&(e.declutterExecutorGroups[g]=[]),s.dirty=!1;for(let R=0,x=u.length;R<x;++R){const f=u[R];if(f.getState()!=E.LOADED)continue;const h=f.tileCoord,C=p.getTileCoordExtent(h),S=X(d,C),_=P(S,i.getRenderBuffer()*c,this.tmpExtent),G=ne(C,S)?null:_,y=new U(0,_,c,t),m=l?new U(0,S,c,t):void 0,w=Ce(c,t),v=function(F){let A;const b=F.getStyleFunction()||i.getStyleFunction();if(b&&(A=b(F,c)),A){const J=this.renderFeature(F,w,A,y,m);s.dirty=s.dirty||J}},M=f.getFeatures();n&&n!==s.renderedRenderOrder&&M.sort(n);for(let F=0,A=M.length;F<A;++F){const b=M[F];(!G||O(G,b.getGeometry().getExtent()))&&v.call(this,b)}const W=y.finish(),$=i.getRenderMode()!=="vector"&&l&&u.length===1?null:S,q=new K($,c,t,a.getOverlaps(),W,i.getRenderBuffer());if(e.executorGroups[g].push(q),m){const F=new K(null,c,t,a.getOverlaps(),m.finish(),i.getRenderBuffer());e.declutterExecutorGroups[g].push(F)}}s.renderedRevision=o,s.renderedRenderOrder=n,s.renderedResolution=c}forEachFeatureAtCoordinate(e,t,r,i,o){const n=t.viewState.resolution,c=t.viewState.rotation;r=r??0;const s=this.getLayer(),l=s.getSource().getTileGridForProjection(t.viewState.projection),p=se([e]);P(p,n*r,p);const T={},d=function(R,x,f){let h=R.getId();h===void 0&&(h=I(R));const C=T[h];if(C){if(C!==!0&&f<C.distanceSq){if(f===0)return T[h]=!0,o.splice(o.lastIndexOf(C),1),i(R,s,x);C.geometry=x,C.distanceSq=f}}else{if(f===0)return T[h]=!0,i(R,s,x);o.push(T[h]={feature:R,layer:s,geometry:x,distanceSq:f,callback:i})}},u=this.renderedTiles;let g;for(let R=0,x=u.length;!g&&R<x;++R){const f=u[R],h=l.getTileCoordExtent(f.wrappedTileCoord);if(!O(h,p))continue;const C=I(s),S=[f.executorGroups[C]],_=f.declutterExecutorGroups[C];_&&S.push(_),S.some(G=>{const y=G===_?t.declutterTree.all().map(m=>m.value):null;for(let m=0,w=G.length;m<w;++m)if(g=G[m].forEachFeatureAtCoordinate(e,n,c,r,d,y),g)return!0})}return g}getFeatures(e){return new Promise((t,r)=>{const i=this.getLayer(),o=I(i),n=i.getSource(),c=this.renderedProjection,s=c.getExtent(),a=this.renderedResolution,l=n.getTileGridForProjection(c),p=le(this.renderedPixelToCoordinateTransform_,e.slice()),T=l.getTileCoordForCoordAndResolution(p,a);let d;for(let h=0,C=this.renderedTiles.length;h<C;++h)if(T.toString()===this.renderedTiles[h].tileCoord.toString()){if(d=this.renderedTiles[h],d.getState()===E.LOADED){const S=l.getTileCoordExtent(d.tileCoord);n.getWrapX()&&c.canWrapX()&&!ae(s,S)&&ce(p,c);break}d=void 0}if(!d||d.loadingSourceTiles>0){t([]);return}const u=l.getTileCoordExtent(d.wrappedTileCoord),g=de(u),R=[(p[0]-g[0])/a,(g[1]-p[1])/a],x=d.getSourceTiles().reduce(function(h,C){return h.concat(C.getFeatures())},[]);let f=d.hitDetectionImageData[o];if(!f){const h=B(l.getTileSize(l.getZForResolution(a,n.zDirection))),C=this.renderedRotation_,S=[this.getRenderTransform(l.getTileCoordCenter(d.wrappedTileCoord),a,0,N,h[0]*N,h[1]*N,0)];f=te(h,S,x,i.getStyleFunction(),l.getTileCoordExtent(d.wrappedTileCoord),d.getReplayState(i).renderedResolution,C),d.hitDetectionImageData[o]=f}t(re(R,x,f))})}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e){const t=this.context,r=t.globalAlpha;t.globalAlpha=this.getLayer().getOpacity();const i=e.viewHints,o=!(i[D.ANIMATING]||i[D.INTERACTING]),n=this.renderedTiles;for(let c=0,s=n.length;c<s;++c){const a=n[c],l=a.declutterExecutorGroups[I(this.getLayer())];if(l)for(let p=l.length-1;p>=0;--p)l[p].execute(this.context,1,this.getTileRenderTransform(a,e),e.viewState.rotation,o,void 0,e.declutterTree)}t.globalAlpha=r}getTileRenderTransform(e,t){const r=t.pixelRatio,i=t.viewState,o=i.center,n=i.resolution,c=i.rotation,s=t.size,a=Math.round(s[0]*r),l=Math.round(s[1]*r),T=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),d=e.tileCoord,u=T.getTileCoordExtent(e.wrappedTileCoord),g=T.getTileCoordExtent(d,this.tmpExtent)[0]-u[0];return ue(z(this.inversePixelTransform.slice(),1/r,1/r),this.getRenderTransform(o,n,c,r,a,l,g))}postRender(e,t){const r=t.viewHints,i=!(r[D.ANIMATING]||r[D.INTERACTING]);this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation;const o=this.getLayer(),n=o.getRenderMode(),c=e.globalAlpha;e.globalAlpha=o.getOpacity();const s=Ie[n],a=t.viewState,l=a.rotation,p=o.getSource(),d=p.getTileGridForProjection(a.projection).getZForResolution(a.resolution,p.zDirection),u=this.renderedTiles,g=[],R=[];let x=!0;for(let f=u.length-1;f>=0;--f){const h=u[f];x=x&&!h.getReplayState(o).dirty;const C=h.executorGroups[I(o)].filter(m=>m.hasExecutors(s));if(C.length===0)continue;const S=this.getTileRenderTransform(h,t),_=h.tileCoord[0];let G=!1;const y=C[0].getClipCoords(S);if(y){for(let m=0,w=g.length;m<w;++m)if(d!==_&&_<R[m]){const v=g[m];O([y[0],y[3],y[4],y[7]],[v[0],v[3],v[4],v[7]])&&(G||(e.save(),G=!0),e.beginPath(),e.moveTo(y[0],y[1]),e.lineTo(y[2],y[3]),e.lineTo(y[4],y[5]),e.lineTo(y[6],y[7]),e.moveTo(v[6],v[7]),e.lineTo(v[4],v[5]),e.lineTo(v[2],v[3]),e.lineTo(v[0],v[1]),e.clip())}g.push(y),R.push(_)}for(let m=0,w=C.length;m<w;++m)C[m].execute(e,1,S,l,i,s);G&&e.restore()}e.globalAlpha=c,this.ready=x,super.postRender(e,t)}renderFeature(e,t,r,i,o){if(!r)return!1;let n=!1;if(Array.isArray(r))for(let c=0,s=r.length;c<s;++c)n=Z(i,e,r[c],t,this.boundHandleStyleImageChange_,void 0,o)||n;else n=Z(i,e,r,t,this.boundHandleStyleImageChange_,void 0,o);return n}tileImageNeedsRender_(e){const t=this.getLayer();if(t.getRenderMode()==="vector")return!1;const r=e.getReplayState(t),i=t.getRevision(),o=e.wantedResolution;return r.renderedTileResolution!==o||r.renderedTileRevision!==i}renderTileImage_(e,t){const r=this.getLayer(),i=e.getReplayState(r),o=r.getRevision(),n=e.executorGroups[I(r)];i.renderedTileRevision=o;const c=e.wrappedTileCoord,s=c[0],a=r.getSource();let l=t.pixelRatio;const T=t.viewState.projection,d=a.getTileGridForProjection(T),u=d.getResolution(e.tileCoord[0]),g=t.pixelRatio/e.wantedResolution*u,R=d.getResolution(s),x=e.getContext(r);l=Math.round(Math.max(l,g/l));const f=a.getTilePixelSize(s,l,T);x.canvas.width=f[0],x.canvas.height=f[1];const h=l/g;if(h!==1){const G=k(this.tmpTransform_);z(G,h,h),x.setTransform.apply(x,G)}const C=d.getTileCoordExtent(c,this.tmpExtent),S=g/R,_=k(this.tmpTransform_);z(_,S,-S),he(_,-C[0],-C[3]);for(let G=0,y=n.length;G<y;++G)n[G].execute(x,h,_,0,!0,Le[r.getRenderMode()]);i.renderedTileResolution=e.wantedResolution}}const we=Fe;class De extends Q{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un;const r=e.renderMode||"hybrid";ge(r=="hybrid"||r=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=r,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new we(this)}getFeatures(e){return super.getFeatures(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(j.PRELOAD)}getUseInterimTilesOnError(){return this.get(j.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(j.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(j.USE_INTERIM_TILES_ON_ERROR,e)}}const He=De;let Oe=class extends Y{constructor(e,t,r,i,o,n){super(e,t,n),this.extent=null,this.format_=i,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=o,this.url_=r,this.key=r}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==E.IDLE&&(this.setState(E.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(e,t){this.setFeatures(e)}onError(){this.setState(E.ERROR)}setFeatures(e){this.features_=e,this.setState(E.LOADED)}setLoader(e){this.loader_=e}};const Ae=Oe,H=[];class be extends Y{constructor(e,t,r,i){super(e,t,{transition:0}),this.context_={},this.executorGroups={},this.declutterExecutorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=i.bind(void 0,this),this.wrappedTileCoord=r}getContext(e){const t=I(e);return t in this.context_||(this.context_[t]=Te(1,1,H)),this.context_[t]}hasContext(e){return I(e)in this.context_}getImage(e){return this.hasContext(e)?this.getContext(e).canvas:null}getReplayState(e){const t=I(e);return t in this.replayState_||(this.replayState_[t]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[t]}load(){this.getSourceTiles()}release(){for(const e in this.context_){const t=this.context_[e];fe(t),H.push(t.canvas),delete this.context_[e]}super.release()}}const Pe=be;class je extends _e{constructor(e){const t=e.projection||"EPSG:3857",r=e.extent||Ee(t),i=e.tileGrid||xe({extent:r,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,opaque:!1,projection:t,state:e.state,tileGrid:i,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:Me,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX===void 0?!0:e.wrapX,transition:e.transition,zDirection:e.zDirection===void 0?1:e.zDirection}),this.format_=e.format?e.format:null,this.sourceTileCache=new ye(this.tileCache.highWaterMark),this.overlaps_=e.overlaps==null?!0:e.overlaps,this.tileClass=e.tileClass?e.tileClass:Ae,this.tileGrids_={}}getFeaturesInExtent(e){const t=[],r=this.tileCache;if(r.getCount()===0)return t;const i=me(r.peekFirstKey())[0],o=this.tileGrid;return r.forEach(function(n){if(n.tileCoord[0]!==i||n.getState()!==E.LOADED)return;const c=n.getSourceTiles();for(let s=0,a=c.length;s<a;++s){const l=c[s],p=l.tileCoord;if(O(e,o.getTileCoordExtent(p))){const T=l.getFeatures();if(T)for(let d=0,u=T.length;d<u;++d){const g=T[d],R=g.getGeometry();O(e,R.getExtent())&&t.push(g)}}}}),t}getOverlaps(){return this.overlaps_}clear(){this.tileCache.clear(),this.sourceTileCache.clear()}expireCache(e,t){const r=this.getTileCacheForProjection(e),i=Object.keys(t).reduce((o,n)=>{const c=Se(n),s=r.peek(c);if(s){const a=s.sourceTiles;for(let l=0,p=a.length;l<p;++l)o[a[l].getKey()]=!0}return o},{});super.expireCache(e,t),this.sourceTileCache.expireCache(i)}getSourceTiles(e,t,r){if(r.getState()===E.IDLE){r.setState(E.LOADING);const i=r.wrappedTileCoord,o=this.getTileGridForProjection(t),n=o.getTileCoordExtent(i),c=i[0],s=o.getResolution(c);P(n,-s,n);const a=this.tileGrid,l=a.getExtent();l&&X(n,l,n);const p=a.getZForResolution(s,this.zDirection);a.forEachTileCoord(n,p,T=>{const d=this.tileUrlFunction(T,e,t),u=this.sourceTileCache.containsKey(d)?this.sourceTileCache.get(d):new this.tileClass(T,d?E.IDLE:E.EMPTY,d,this.format_,this.tileLoadFunction);r.sourceTiles.push(u);const g=u.getState();if(g<E.LOADED){const R=x=>{this.handleTileChange(x);const f=u.getState();if(f===E.LOADED||f===E.ERROR){const h=u.getKey();h in r.errorTileKeys?u.getState()===E.LOADED&&delete r.errorTileKeys[h]:r.loadingSourceTiles--,f===E.ERROR?r.errorTileKeys[h]=!0:u.removeEventListener(V.CHANGE,R),r.loadingSourceTiles===0&&r.setState(pe(r.errorTileKeys)?E.LOADED:E.ERROR)}};u.addEventListener(V.CHANGE,R),r.loadingSourceTiles++}g===E.IDLE&&(u.extent=a.getTileCoordExtent(T),u.projection=t,u.resolution=a.getResolution(T[0]),this.sourceTileCache.set(d,u),u.load())}),r.loadingSourceTiles||r.setState(r.sourceTiles.some(T=>T.getState()===E.ERROR)?E.ERROR:E.LOADED)}return r.sourceTiles}getTile(e,t,r,i,o){const n=ve(e,t,r),c=this.getKey();let s;if(this.tileCache.containsKey(n)&&(s=this.tileCache.get(n),s.key===c))return s;const a=[e,t,r];let l=this.getTileCoordForTileUrlFunction(a,o);const p=this.getTileGrid().getExtent(),T=this.getTileGridForProjection(o);if(l&&p){const g=T.getTileCoordExtent(l);P(g,-T.getResolution(e),g),O(p,g)||(l=null)}let d=!0;if(l!==null){const g=this.tileGrid,R=T.getResolution(e),x=g.getZForResolution(R,1),f=T.getTileCoordExtent(l);P(f,-R,f),g.forEachTileCoord(f,x,h=>{d=d&&!this.tileUrlFunction(h,i,o)})}const u=new Pe(a,d?E.EMPTY:E.IDLE,l,this.getSourceTiles.bind(this,i,o));return u.key=c,s?(u.interimTile=s,u.refreshInterimChain(),this.tileCache.replace(n,u)):this.tileCache.set(n,u),u}getTileGridForProjection(e){const t=e.getCode();let r=this.tileGrids_[t];if(!r){const i=this.tileGrid,o=i.getResolutions().slice(),n=o.map(function(a,l){return i.getOrigin(l)}),c=o.map(function(a,l){return i.getTileSize(l)}),s=Re+1;for(let a=o.length;a<s;++a)o.push(o[a-1]/2),n.push(n[a-1]),c.push(c[a-1]);r=new Ge({extent:i.getExtent(),origins:n,resolutions:o,tileSizes:c}),this.tileGrids_[t]=r}return r}getTilePixelRatio(e){return e}getTilePixelSize(e,t,r){const i=this.getTileGridForProjection(r),o=B(i.getTileSize(e),this.tmpSize);return[Math.round(o[0]*t),Math.round(o[1]*t)]}updateCacheSize(e,t){super.updateCacheSize(e*2,t),this.sourceTileCache.highWaterMark=this.getTileCacheForProjection(t).highWaterMark}}const Be=je;function Me(L,e){L.setLoader(function(t,r,i){ee(e,L.getFormat(),t,r,i,L.onLoad.bind(L),L.onError.bind(L))})}export{He as V,Be as a,Ae as b,Me as d};
