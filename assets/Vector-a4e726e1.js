import{c4 as v,a3 as h,a9 as C,aX as g,av as p,c5 as T,a1 as D,u as U,aD as b,bC as G,as as m,c6 as L,K as x,G as S,c7 as w,c8 as y,L as R,b1 as O,c9 as X,aQ as K,aF as Y,ca as N}from"./Layer-3b715193.js";import{x as F,R as _}from"./featureloader-a90a5108.js";class V{constructor(e){this.rbush_=new v(e),this.items_={}}insert(e,t){const s={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(s),this.items_[h(t)]=s}load(e,t){const s=new Array(t.length);for(let n=0,r=t.length;n<r;n++){const a=e[n],i=t[n],o={minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],value:i};s[n]=o,this.items_[h(i)]=o}this.rbush_.load(s)}remove(e){const t=h(e),s=this.items_[t];return delete this.items_[t],this.rbush_.remove(s)!==null}update(e,t){const s=this.items_[h(t)],n=[s.minX,s.minY,s.maxX,s.maxY];C(n,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(n){return n.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let s;for(let n=0,r=e.length;n<r;n++)if(s=t(e[n]),s)return s;return s}isEmpty(){return g(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return p(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const I=V,u={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};function B(l,e){return[[-1/0,-1/0,1/0,1/0]]}function P(l,e){return[l]}function W(l){return function(e,t,s){const n=l.getZForResolution(T(t)),r=l.getTileRangeForExtentAndZ(D(e),n),a=[],i=[n,0,0];for(i[1]=r.minX;i[1]<=r.maxX;++i[1])for(i[2]=r.minY;i[2]<=r.maxY;++i[2])a.push(U(l.getTileCoordExtent(i)));return a}}class f extends Y{constructor(e,t,s){super(e),this.feature=t,this.features=s}}class M extends b{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=G,this.format_=e.format,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(m(this.format_,"`format` must be set when `url` is set"),this.loader_=F(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:B;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new I:null,this.loadedExtentsRtree_=new I,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,n;Array.isArray(e.features)?n=e.features:e.features&&(s=e.features,n=s.getArray()),!t&&s===void 0&&(s=new L(n)),n!==void 0&&this.addFeaturesInternal(n),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=h(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const s=e.getGeometry();if(s){const n=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(n,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new f(u.ADDFEATURE,e))}setupChangeEvents_(e,t){t instanceof _||(this.featureChangeKeys_[e]=[x(t,S.CHANGE,this.handleFeatureChange_,this),x(t,w.PROPERTYCHANGE,this.handleFeatureChange_,this)])}addToIndex_(e,t){let s=!0;if(t.getId()!==void 0){const n=String(t.getId());if(!(n in this.idIndex_))this.idIndex_[n]=t;else if(t instanceof _){const r=this.idIndex_[n];r instanceof _?Array.isArray(r)?r.push(t):this.idIndex_[n]=[r,t]:s=!1}else s=!1}return s&&(m(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),s}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],s=[],n=[];for(let r=0,a=e.length;r<a;r++){const i=e[r],o=h(i);this.addToIndex_(o,i)&&s.push(i)}for(let r=0,a=s.length;r<a;r++){const i=s[r],o=h(i);this.setupChangeEvents_(o,i);const c=i.getGeometry();if(c){const d=c.getExtent();t.push(d),n.push(i)}else this.nullGeometryFeatures_[o]=i}if(this.featuresRtree_&&this.featuresRtree_.load(t,n),this.hasListener(u.ADDFEATURE))for(let r=0,a=s.length;r<a;r++)this.dispatchEvent(new f(u.ADDFEATURE,s[r]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(u.ADDFEATURE,function(s){t||(t=!0,e.push(s.feature),t=!1)}),this.addEventListener(u.REMOVEFEATURE,function(s){t||(t=!0,e.remove(s.feature),t=!1)}),e.addEventListener(y.ADD,s=>{t||(t=!0,this.addFeature(s.element),t=!1)}),e.addEventListener(y.REMOVE,s=>{t||(t=!0,this.removeFeature(s.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(R);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){const s=n=>{this.removeFeatureInternal(n)};this.featuresRtree_.forEach(s);for(const n in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[n])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new f(u.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const s=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(s,function(n){const r=n.getGeometry();if(r instanceof _||r.intersectsCoordinate(e))return t(n)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(s){const n=s.getGeometry();if(n instanceof _||n.intersectsExtent(e)){const r=t(s);if(r)return r}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),g(this.nullGeometryFeatures_)||O(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(s){t.push(s)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const n=X(e,t);return[].concat(...n.map(r=>this.featuresRtree_.getInExtent(r)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const s=e[0],n=e[1];let r=null;const a=[NaN,NaN];let i=1/0;const o=[-1/0,-1/0,1/0,1/0];return t=t||N,this.featuresRtree_.forEachInExtent(o,function(c){if(t(c)){const d=c.getGeometry(),A=i;if(i=d instanceof _?0:d.closestPointXY(s,n,a,i),i<A){r=c;const E=Math.sqrt(i);o[0]=s-E,o[1]=n-E,o[2]=s+E,o[3]=n+E}}}),r}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,s=h(t),n=t.getGeometry();if(!n)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[s]=t);else{const a=n.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(a,t)):this.featuresRtree_&&this.featuresRtree_.update(a,t)}const r=t.getId();if(r!==void 0){const a=r.toString();this.idIndex_[a]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[a]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[s]=t;this.changed(),this.dispatchEvent(new f(u.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:h(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&g(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,s){const n=this.loadedExtentsRtree_,r=this.strategy_(e,t,s);for(let a=0,i=r.length;a<i;++a){const o=r[a];n.forEachInExtent(o,function(d){return K(d.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new f(u.FEATURESLOADSTART)),this.loader_.call(this,o,t,s,d=>{--this.loadingExtentsCount_,this.dispatchEvent(new f(u.FEATURESLOADEND,void 0,d))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new f(u.FEATURESLOADERROR))}),n.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_;let s;t.forEachInExtent(e,function(n){if(C(n.extent,e))return s=n,!0}),s&&t.remove(s)}removeFeature(e){if(!e)return;const t=h(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=h(e),s=this.featureChangeKeys_[t];if(!s)return;s.forEach(R),delete this.featureChangeKeys_[t];const n=e.getId();return n!==void 0&&delete this.idIndex_[n.toString()],delete this.uidIndex_[t],this.dispatchEvent(new f(u.REMOVEFEATURE,e)),e}removeFromIdIndex_(e){let t=!1;for(const s in this.idIndex_){const n=this.idIndex_[s];if(e instanceof _&&Array.isArray(n)&&n.includes(e))n.splice(n.indexOf(e),1);else if(this.idIndex_[s]===e){delete this.idIndex_[s],t=!0;break}}return t}setLoader(e){this.loader_=e}setUrl(e){m(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(F(e,this.format_))}}const Z=M;export{I as R,Z as V,u as a,P as b,W as t};
