import{A as B,D as V,N as k,H as E,c as Q,h as S,C as $,E as q}from"./hitdetect-486e5612.js";import{C as J,c as O}from"./Layer-37ea9c2e.js";import{Y as N,aO as T,e as L,Q as Y,ar as K,cb as Z,a6 as ee,a5 as te,aM as P,a1 as ne,i as re,aQ as G,_ as ie,aP as se,aR as oe,cc as ae,aJ as ce,a3 as he,u as de}from"./Layer-3b715193.js";import{g as j,a as le,r as H,d as ue}from"./vector-4e067f94.js";class pe extends J{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=N(),this.wrappedRenderedExtent_=N(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,n){const l=t.extent,i=t.viewState,u=i.center,p=i.resolution,a=i.projection,r=i.rotation,s=a.getExtent(),c=this.getLayer().getSource(),g=this.getLayer().getDeclutter(),f=t.pixelRatio,h=t.viewHints,d=!(h[T.ANIMATING]||h[T.INTERACTING]),x=this.compositionContext_,o=Math.round(t.size[0]*f),y=Math.round(t.size[1]*f),v=c.getWrapX()&&a.canWrapX(),C=v?L(s):null,w=v?Math.ceil((l[2]-s[2])/C)+1:1;let I=v?Math.floor((l[0]-s[0])/C):0;do{const A=this.getRenderTransform(u,p,r,f,o,y,I*C);e.execute(x,[x.canvas.width,x.canvas.height],A,r,d,n===void 0?B:n?V:k,n?g&&t.declutter[g]:void 0)}while(++I<w)}setupCompositionContext_(){if(this.opacity_!==1){const e=Y(this.context.canvas.width,this.context.canvas.height,O);this.compositionContext_=e}else this.compositionContext_=this.context}releaseCompositionContext_(){if(this.opacity_!==1){const e=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,K(this.compositionContext_),O.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(e){this.getLayer().getDeclutter()&&(this.setupCompositionContext_(),this.renderWorlds(this.replayGroup_,e,!0),this.releaseCompositionContext_())}renderDeferredInternal(e){this.replayGroup_.renderDeferred()}renderFrame(e,t){const n=e.pixelRatio,l=e.layerStatesArray[e.layerIndex];Z(this.pixelTransform,1/n,1/n),ee(this.inversePixelTransform,this.pixelTransform);const i=te(this.pixelTransform);this.useContainer(t,i,this.getBackground(e));const u=this.context,p=u.canvas,a=this.replayGroup_;let r=a&&!a.isEmpty();if(!r&&!(this.getLayer().hasListener(P.PRERENDER)||this.getLayer().hasListener(P.POSTRENDER)))return null;const s=Math.round(e.size[0]*n),c=Math.round(e.size[1]*n);p.width!=s||p.height!=c?(p.width=s,p.height=c,p.style.transform!==i&&(p.style.transform=i)):this.containerReused||u.clearRect(0,0,s,c),this.preRender(u,e);const g=e.viewState;g.projection,this.opacity_=l.opacity,this.setupCompositionContext_();let f=!1;if(r&&l.extent&&this.clipping){const h=ne(l.extent);r=re(h,e.extent),f=r&&!G(h,e.extent),f&&this.clipUnrotated(this.compositionContext_,e,h)}return r&&this.renderWorlds(a,e,this.getLayer().getDeclutter()?!1:void 0),f&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(u,e),this.renderedRotation_!==g.rotation&&(this.renderedRotation_=g.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise(t=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const n=[this.context.canvas.width,this.context.canvas.height];ie(this.pixelTransform,n);const l=this.renderedCenter_,i=this.renderedResolution_,u=this.renderedRotation_,p=this.renderedProjection_,a=this.wrappedRenderedExtent_,r=this.getLayer(),s=[],c=n[0]*E,g=n[1]*E;s.push(this.getRenderTransform(l,i,u,E,c,g,0).slice());const f=r.getSource(),h=p.getExtent();if(f.getWrapX()&&p.canWrapX()&&!G(h,a)){let d=a[0];const x=L(h);let o=0,y;for(;d<h[0];)--o,y=x*o,s.push(this.getRenderTransform(l,i,u,E,c,g,y).slice()),d+=x;for(o=0,d=a[2];d>h[2];)++o,y=x*o,s.push(this.getRenderTransform(l,i,u,E,c,g,y).slice()),d-=x}this.hitDetectionImageData_=Q(n,s,this.renderedFeatures_,r.getStyleFunction(),a,i,u,j(i,this.renderedPixelRatio_),null)}t(S(e,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(e,t,n,l,i){if(!this.replayGroup_)return;const u=t.viewState.resolution,p=t.viewState.rotation,a=this.getLayer(),r={},s=function(h,d,x){const o=he(h),y=r[o];if(y){if(y!==!0&&x<y.distanceSq){if(x===0)return r[o]=!0,i.splice(i.lastIndexOf(y),1),l(h,a,d);y.geometry=d,y.distanceSq=x}}else{if(x===0)return r[o]=!0,l(h,a,d);i.push(r[o]={feature:h,layer:a,geometry:d,distanceSq:x,callback:l})}};let c;const g=[this.replayGroup_],f=this.getLayer().getDeclutter();return g.some(h=>c=h.forEachFeatureAtCoordinate(e,u,p,n,s,f&&t.declutter[f]?t.declutter[f].all().map(d=>d.value):null)),c}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),n=t.getSource();if(!n)return!1;const l=e.viewHints[T.ANIMATING],i=e.viewHints[T.INTERACTING],u=t.getUpdateWhileAnimating(),p=t.getUpdateWhileInteracting();if(this.ready&&!u&&l||!p&&i)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const a=e.extent,r=e.viewState,s=r.projection,c=r.resolution,g=e.pixelRatio,f=t.getRevision(),h=t.getRenderBuffer();let d=t.getRenderOrder();d===void 0&&(d=ue);const x=r.center.slice(),o=se(a,h*c),y=o.slice(),v=[o.slice()],C=s.getExtent();if(n.getWrapX()&&s.canWrapX()&&!G(C,e.extent)){const _=L(C),m=Math.max(L(o)/2,_);o[0]=C[0]-m,o[2]=C[2]+m,oe(x,s);const R=ae(v[0],s);R[0]<C[0]&&R[2]<C[2]?v.push([R[0]+_,R[1],R[2]+_,R[3]]):R[0]>C[0]&&R[2]>C[2]&&v.push([R[0]-_,R[1],R[2]-_,R[3]])}if(this.ready&&this.renderedResolution_==c&&this.renderedRevision_==f&&this.renderedRenderOrder_==d&&G(this.wrappedRenderedExtent_,o))return ce(this.renderedExtent_,y)||(this.hitDetectionImageData_=null,this.renderedExtent_=y),this.renderedCenter_=x,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const w=new $(le(c,g),o,c,g);let I;for(let _=0,m=v.length;_<m;++_)n.loadFeatures(v[_],c,s);const A=j(c,g);let F=!0;const M=(_,m)=>{let R;const W=_.getStyleFunction()||t.getStyleFunction();if(W&&(R=W(_,c)),R){const z=this.renderFeature(_,A,R,w,I,this.getLayer().getDeclutter(),m);F=F&&!z}},X=de(o),D=n.getFeaturesInExtent(X);d&&D.sort(d);for(let _=0,m=D.length;_<m;++_)M(D[_],_);this.renderedFeatures_=D,this.ready=F;const U=w.finish(),b=new q(o,c,g,n.getOverlaps(),U,t.getRenderBuffer(),!!e.declutter);return this.renderedResolution_=c,this.renderedRevision_=f,this.renderedRenderOrder_=d,this.renderedExtent_=y,this.wrappedRenderedExtent_=o,this.renderedCenter_=x,this.renderedProjection_=s,this.renderedPixelRatio_=g,this.replayGroup_=b,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,n,l,i,u,p){if(!n)return!1;let a=!1;if(Array.isArray(n))for(let r=0,s=n.length;r<s;++r)a=H(l,e,n[r],t,this.boundHandleStyleImageChange_,i,u,p)||a;else a=H(l,e,n,t,this.boundHandleStyleImageChange_,i,u,p);return a}}const Re=pe;export{Re as C};
