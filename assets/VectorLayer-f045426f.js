import{H as I,c as k,h as $,C as F,E as A}from"./hitdetect-4f776f31.js";import{C as S,c as O}from"./Layer-8f64fa5e.js";import{Q as N,aM as G,c as D,J as q,aj as J,b_ as Q,$ as Y,_ as K,aE as j,W as Z,i as ee,aO as L,R as te,aN as ne,aP as re,b$ as ie,aB as se,Y as oe,r as ae}from"./Layer-3211d6ef.js";import{a as b,r as H,d as ce,g as he}from"./vector-01534e8d.js";class le extends S{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=N(),this.wrappedRenderedExtent_=N(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,r){const d=t.extent,a=t.viewState,x=a.center,l=a.resolution,h=a.projection,u=a.rotation,o=h.getExtent(),i=this.getLayer().getSource(),c=t.pixelRatio,p=t.viewHints,g=!(p[G.ANIMATING]||p[G.INTERACTING]),s=this.compositionContext_,y=Math.round(t.size[0]*c),n=Math.round(t.size[1]*c),R=i.getWrapX()&&h.canWrapX(),m=R?D(o):null,C=R?Math.ceil((d[2]-o[2])/m)+1:1;let w=R?Math.floor((d[0]-o[0])/m):0;do{const v=this.getRenderTransform(x,l,u,c,y,n,w*m);e.execute(s,1,v,u,g,void 0,r)}while(++w<C)}setupCompositionContext_(){if(this.opacity_!==1){const e=q(this.context.canvas.width,this.context.canvas.height,O);this.compositionContext_=e}else this.compositionContext_=this.context}releaseCompositionContext_(){if(this.opacity_!==1){const e=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,J(this.compositionContext_),O.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(e){this.declutterExecutorGroup&&(this.setupCompositionContext_(),this.renderWorlds(this.declutterExecutorGroup,e,e.declutterTree),this.releaseCompositionContext_())}renderFrame(e,t){const r=e.pixelRatio,d=e.layerStatesArray[e.layerIndex];Q(this.pixelTransform,1/r,1/r),Y(this.inversePixelTransform,this.pixelTransform);const a=K(this.pixelTransform);this.useContainer(t,a,this.getBackground(e));const x=this.context,l=x.canvas,h=this.replayGroup_,u=this.declutterExecutorGroup;let o=h&&!h.isEmpty()||u&&!u.isEmpty();if(!o&&!(this.getLayer().hasListener(j.PRERENDER)||this.getLayer().hasListener(j.POSTRENDER)))return null;const i=Math.round(e.size[0]*r),c=Math.round(e.size[1]*r);l.width!=i||l.height!=c?(l.width=i,l.height=c,l.style.transform!==a&&(l.style.transform=a)):this.containerReused||x.clearRect(0,0,i,c),this.preRender(x,e);const p=e.viewState;p.projection,this.opacity_=d.opacity,this.setupCompositionContext_();let g=!1;if(o&&d.extent&&this.clipping){const s=Z(d.extent);o=ee(s,e.extent),g=o&&!L(s,e.extent),g&&this.clipUnrotated(this.compositionContext_,e,s)}return o&&this.renderWorlds(h,e),g&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(x,e),this.renderedRotation_!==p.rotation&&(this.renderedRotation_=p.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise(t=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const r=[this.context.canvas.width,this.context.canvas.height];te(this.pixelTransform,r);const d=this.renderedCenter_,a=this.renderedResolution_,x=this.renderedRotation_,l=this.renderedProjection_,h=this.wrappedRenderedExtent_,u=this.getLayer(),o=[],i=r[0]*I,c=r[1]*I;o.push(this.getRenderTransform(d,a,x,I,i,c,0).slice());const p=u.getSource(),g=l.getExtent();if(p.getWrapX()&&l.canWrapX()&&!L(g,h)){let s=h[0];const y=D(g);let n=0,R;for(;s<g[0];)--n,R=y*n,o.push(this.getRenderTransform(d,a,x,I,i,c,R).slice()),s+=y;for(n=0,s=h[2];s>g[2];)++n,R=y*n,o.push(this.getRenderTransform(d,a,x,I,i,c,R).slice()),s-=y}this.hitDetectionImageData_=k(r,o,this.renderedFeatures_,u.getStyleFunction(),h,a,x)}t($(e,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(e,t,r,d,a){if(!this.replayGroup_)return;const x=t.viewState.resolution,l=t.viewState.rotation,h=this.getLayer(),u={},o=function(p,g,s){const y=oe(p),n=u[y];if(n){if(n!==!0&&s<n.distanceSq){if(s===0)return u[y]=!0,a.splice(a.lastIndexOf(n),1),d(p,h,g);n.geometry=g,n.distanceSq=s}}else{if(s===0)return u[y]=!0,d(p,h,g);a.push(u[y]={feature:p,layer:h,geometry:g,distanceSq:s,callback:d})}};let i;const c=[this.replayGroup_];return this.declutterExecutorGroup&&c.push(this.declutterExecutorGroup),c.some(p=>i=p.forEachFeatureAtCoordinate(e,x,l,r,o,p===this.declutterExecutorGroup&&t.declutterTree?t.declutterTree.all().map(g=>g.value):null)),i}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),r=t.getSource();if(!r)return!1;const d=e.viewHints[G.ANIMATING],a=e.viewHints[G.INTERACTING],x=t.getUpdateWhileAnimating(),l=t.getUpdateWhileInteracting();if(this.ready&&!x&&d||!l&&a)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const h=e.extent,u=e.viewState,o=u.projection,i=u.resolution,c=e.pixelRatio,p=t.getRevision(),g=t.getRenderBuffer();let s=t.getRenderOrder();s===void 0&&(s=ce);const y=u.center.slice(),n=ne(h,g*i),R=n.slice(),m=[n.slice()],C=o.getExtent();if(r.getWrapX()&&o.canWrapX()&&!L(C,e.extent)){const _=D(C),E=Math.max(D(n)/2,_);n[0]=C[0]-E,n[2]=C[2]+E,re(y,o);const f=ie(m[0],o);f[0]<C[0]&&f[2]<C[2]?m.push([f[0]+_,f[1],f[2]+_,f[3]]):f[0]>C[0]&&f[2]>C[2]&&m.push([f[0]-_,f[1],f[2]-_,f[3]])}if(this.ready&&this.renderedResolution_==i&&this.renderedRevision_==p&&this.renderedRenderOrder_==s&&L(this.wrappedRenderedExtent_,n))return se(this.renderedExtent_,R)||(this.hitDetectionImageData_=null,this.renderedExtent_=R),this.renderedCenter_=y,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const w=new F(b(i,c),n,i,c);let v;this.getLayer().getDeclutter()&&(v=new F(b(i,c),n,i,c));let M;for(let _=0,E=m.length;_<E;++_)r.loadFeatures(m[_],i,o);const P=he(i,c);let W=!0;const X=_=>{let E;const f=_.getStyleFunction()||t.getStyleFunction();if(f&&(E=f(_,i)),E){const V=this.renderFeature(_,P,E,w,M,v);W=W&&!V}},B=ae(n),T=r.getFeaturesInExtent(B);s&&T.sort(s);for(let _=0,E=T.length;_<E;++_)X(T[_]);this.renderedFeatures_=T,this.ready=W;const U=w.finish(),z=new A(n,i,c,r.getOverlaps(),U,t.getRenderBuffer());return v&&(this.declutterExecutorGroup=new A(n,i,c,r.getOverlaps(),v.finish(),t.getRenderBuffer())),this.renderedResolution_=i,this.renderedRevision_=p,this.renderedRenderOrder_=s,this.renderedExtent_=R,this.wrappedRenderedExtent_=n,this.renderedCenter_=y,this.renderedProjection_=o,this.replayGroup_=z,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,r,d,a,x){if(!r)return!1;let l=!1;if(Array.isArray(r))for(let h=0,u=r.length;h<u;++h)l=H(d,e,r[h],t,this.boundHandleStyleImageChange_,a,x)||l;else l=H(d,e,r,t,this.boundHandleStyleImageChange_,a,x);return l}}const _e=le;export{_e as C};
