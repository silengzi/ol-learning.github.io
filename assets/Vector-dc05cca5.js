import{bT as p,N as g,K as y,H as C,aq as m,a1 as l,a7 as A,i as E,at as G,bU as T,$ as S,x as D,aB as b,b0 as U,bV as N,bW as L,bX as F,aO as w,bY as K,c as X,aD as O,bZ as Y}from"./Layer-227d2e40.js";import{R as V,x as R}from"./featureloader-41324978.js";class x extends p{constructor(e){if(super(),this.on,this.once,this.un,this.id_=void 0,this.geometryName_="geometry",this.style_=null,this.styleFunction_=void 0,this.geometryChangeKey_=null,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),e)if(typeof e.getSimplifiedGeometry=="function"){const t=e;this.setGeometry(t)}else{const t=e;this.setProperties(t)}}clone(){const e=new x(this.hasProperties()?this.getProperties():null);e.setGeometryName(this.getGeometryName());const t=this.getGeometry();t&&e.setGeometry(t.clone());const s=this.getStyle();return s&&e.setStyle(s),e}getGeometry(){return this.get(this.geometryName_)}getId(){return this.id_}getGeometryName(){return this.geometryName_}getStyle(){return this.style_}getStyleFunction(){return this.styleFunction_}handleGeometryChange_(){this.changed()}handleGeometryChanged_(){this.geometryChangeKey_&&(g(this.geometryChangeKey_),this.geometryChangeKey_=null);const e=this.getGeometry();e&&(this.geometryChangeKey_=y(e,C.CHANGE,this.handleGeometryChange_,this)),this.changed()}setGeometry(e){this.set(this.geometryName_,e)}setStyle(e){this.style_=e,this.styleFunction_=e?B(e):void 0,this.changed()}setId(e){this.id_=e,this.changed()}setGeometryName(e){this.removeChangeListener(this.geometryName_,this.handleGeometryChanged_),this.geometryName_=e,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),this.handleGeometryChanged_()}}function B(h){if(typeof h=="function")return h;let e;return Array.isArray(h)?e=h:(m(typeof h.getZIndex=="function","Expected an `ol/style/Style` or an array of `ol/style/Style.js`"),e=[h]),function(){return e}}const P=x;class H{constructor(e){this.rbush_=new V(e),this.items_={}}insert(e,t){const s={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(s),this.items_[l(t)]=s}load(e,t){const s=new Array(t.length);for(let n=0,r=t.length;n<r;n++){const a=e[n],i=t[n],o={minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],value:i};s[n]=o,this.items_[l(i)]=o}this.rbush_.load(s)}remove(e){const t=l(e),s=this.items_[t];return delete this.items_[t],this.rbush_.remove(s)!==null}update(e,t){const s=this.items_[l(t)],n=[s.minX,s.minY,s.maxX,s.maxY];A(n,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(n){return n.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let s;for(let n=0,r=e.length;n<r;n++)if(s=t(e[n]),s)return s;return s}isEmpty(){return E(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return G(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const I=H,u={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};function M(h,e){return[[-1/0,-1/0,1/0,1/0]]}function Z(h,e){return[h]}function k(h){return function(e,t,s){const n=h.getZForResolution(T(t)),r=h.getTileRangeForExtentAndZ(S(e),n),a=[],i=[n,0,0];for(i[1]=r.minX;i[1]<=r.maxX;++i[1])for(i[2]=r.minY;i[2]<=r.maxY;++i[2])a.push(D(h.getTileCoordExtent(i)));return a}}class d extends O{constructor(e,t,s){super(e),this.feature=t,this.features=s}}class q extends b{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=U,this.format_=e.format,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(m(this.format_,"`format` must be set when `url` is set"),this.loader_=R(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:M;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new I:null,this.loadedExtentsRtree_=new I,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let s,n;Array.isArray(e.features)?n=e.features:e.features&&(s=e.features,n=s.getArray()),!t&&s===void 0&&(s=new N(n)),n!==void 0&&this.addFeaturesInternal(n),s!==void 0&&this.bindFeaturesCollection_(s)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=l(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const s=e.getGeometry();if(s){const n=s.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(n,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new d(u.ADDFEATURE,e))}setupChangeEvents_(e,t){this.featureChangeKeys_[e]=[y(t,C.CHANGE,this.handleFeatureChange_,this),y(t,L.PROPERTYCHANGE,this.handleFeatureChange_,this)]}addToIndex_(e,t){let s=!0;const n=t.getId();return n!==void 0&&(n.toString()in this.idIndex_?s=!1:this.idIndex_[n.toString()]=t),s&&(m(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),s}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],s=[],n=[];for(let r=0,a=e.length;r<a;r++){const i=e[r],o=l(i);this.addToIndex_(o,i)&&s.push(i)}for(let r=0,a=s.length;r<a;r++){const i=s[r],o=l(i);this.setupChangeEvents_(o,i);const f=i.getGeometry();if(f){const c=f.getExtent();t.push(c),n.push(i)}else this.nullGeometryFeatures_[o]=i}if(this.featuresRtree_&&this.featuresRtree_.load(t,n),this.hasListener(u.ADDFEATURE))for(let r=0,a=s.length;r<a;r++)this.dispatchEvent(new d(u.ADDFEATURE,s[r]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(u.ADDFEATURE,function(s){t||(t=!0,e.push(s.feature),t=!1)}),this.addEventListener(u.REMOVEFEATURE,function(s){t||(t=!0,e.remove(s.feature),t=!1)}),e.addEventListener(F.ADD,s=>{t||(t=!0,this.addFeature(s.element),t=!1)}),e.addEventListener(F.REMOVE,s=>{t||(t=!0,this.removeFeature(s.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const s in this.featureChangeKeys_)this.featureChangeKeys_[s].forEach(g);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){const s=n=>{this.removeFeatureInternal(n)};this.featuresRtree_.forEach(s);for(const n in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[n])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new d(u.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const s=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(s,function(n){if(n.getGeometry().intersectsCoordinate(e))return t(n)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(s){if(s.getGeometry().intersectsExtent(e)){const r=t(s);if(r)return r}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),E(this.nullGeometryFeatures_)||w(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(s){t.push(s)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const n=K(e,t);return[].concat(...n.map(r=>this.featuresRtree_.getInExtent(r)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const s=e[0],n=e[1];let r=null;const a=[NaN,NaN];let i=1/0;const o=[-1/0,-1/0,1/0,1/0];return t=t||Y,this.featuresRtree_.forEachInExtent(o,function(f){if(t(f)){const c=f.getGeometry(),v=i;if(i=c.closestPointXY(s,n,a,i),i<v){r=f;const _=Math.sqrt(i);o[0]=s-_,o[1]=n-_,o[2]=s+_,o[3]=n+_}}}),r}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,s=l(t),n=t.getGeometry();if(!n)s in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[s]=t);else{const a=n.getExtent();s in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[s],this.featuresRtree_&&this.featuresRtree_.insert(a,t)):this.featuresRtree_&&this.featuresRtree_.update(a,t)}const r=t.getId();if(r!==void 0){const a=r.toString();this.idIndex_[a]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[a]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[s]=t;this.changed(),this.dispatchEvent(new d(u.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:l(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&E(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,s){const n=this.loadedExtentsRtree_,r=this.strategy_(e,t,s);for(let a=0,i=r.length;a<i;++a){const o=r[a];n.forEachInExtent(o,function(c){return X(c.extent,o)})||(++this.loadingExtentsCount_,this.dispatchEvent(new d(u.FEATURESLOADSTART)),this.loader_.call(this,o,t,s,c=>{--this.loadingExtentsCount_,this.dispatchEvent(new d(u.FEATURESLOADEND,void 0,c))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new d(u.FEATURESLOADERROR))}),n.insert(o,{extent:o.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_;let s;t.forEachInExtent(e,function(n){if(A(n.extent,e))return s=n,!0}),s&&t.remove(s)}removeFeature(e){if(!e)return;const t=l(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=l(e),s=this.featureChangeKeys_[t];if(!s)return;s.forEach(g),delete this.featureChangeKeys_[t];const n=e.getId();return n!==void 0&&delete this.idIndex_[n.toString()],delete this.uidIndex_[t],this.dispatchEvent(new d(u.REMOVEFEATURE,e)),e}removeFromIdIndex_(e){let t=!1;for(const s in this.idIndex_)if(this.idIndex_[s]===e){delete this.idIndex_[s],t=!0;break}return t}setLoader(e){this.loader_=e}setUrl(e){m(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(R(e,this.format_))}}const z=q;export{P as F,I as R,z as V,u as a,Z as b,k as t};
