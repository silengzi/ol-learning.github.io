import{aF as L,W as b,ca as D,de as j,a3 as x,Y as A,h as F,K as y,G as w,L as G,c8 as P,d9 as p,u as B,aP as K,db as C,dl as O,dc as U,dj as V,t as q}from"./Layer-3b715193.js";import{R as N,a as S}from"./Vector-a4e726e1.js";const k={SNAP:"snap"};class I extends L{constructor(e,t){super(e),this.vertex=t.vertex,this.vertexPixel=t.vertexPixel,this.feature=t.feature,this.segment=t.segment}}function M(m){return m.feature?m.feature:m.element?m.element:null}const v=[];class Y extends b{constructor(e){e=e||{};const t=e;t.handleDownEvent||(t.handleDownEvent=D),t.stopDown||(t.stopDown=j),super(t),this.on,this.once,this.un,this.source_=e.source?e.source:null,this.vertex_=e.vertex!==void 0?e.vertex:!0,this.edge_=e.edge!==void 0?e.edge:!0,this.features_=e.features?e.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.rBush_=new N,this.GEOMETRY_SEGMENTERS_={Point:this.segmentPointGeometry_.bind(this),LineString:this.segmentLineStringGeometry_.bind(this),LinearRing:this.segmentLineStringGeometry_.bind(this),Polygon:this.segmentPolygonGeometry_.bind(this),MultiPoint:this.segmentMultiPointGeometry_.bind(this),MultiLineString:this.segmentMultiLineStringGeometry_.bind(this),MultiPolygon:this.segmentMultiPolygonGeometry_.bind(this),GeometryCollection:this.segmentGeometryCollectionGeometry_.bind(this),Circle:this.segmentCircleGeometry_.bind(this)}}addFeature(e,t){t=t!==void 0?t:!0;const n=x(e),s=e.getGeometry();if(s){const o=this.GEOMETRY_SEGMENTERS_[s.getType()];if(o){this.indexedFeaturesExtents_[n]=s.getExtent(A());const i=[];if(o(i,s),i.length===1)this.rBush_.insert(F(i[0]),{feature:e,segment:i[0]});else if(i.length>1){const r=i.map(l=>F(l)),a=i.map(l=>({feature:e,segment:l}));this.rBush_.load(r,a)}}}t&&(this.featureChangeListenerKeys_[n]=y(e,w.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e}handleEvent(e){const t=this.snapTo(e.pixel,e.coordinate,e.map);return t&&(e.coordinate=t.vertex.slice(0,2),e.pixel=t.vertexPixel,this.dispatchEvent(new I(k.SNAP,{vertex:e.coordinate,vertexPixel:e.pixel,feature:t.feature,segment:t.segment}))),super.handleEvent(e)}handleFeatureAdd_(e){const t=M(e);t&&this.addFeature(t)}handleFeatureRemove_(e){const t=M(e);t&&this.removeFeature(t)}handleFeatureChange_(e){const t=e.target;if(this.handlingDownUpSequence){const n=x(t);n in this.pendingFeatures_||(this.pendingFeatures_[n]=t)}else this.updateFeature_(t)}handleUpEvent(e){const t=Object.values(this.pendingFeatures_);return t.length&&(t.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1}removeFeature(e,t){const n=t!==void 0?t:!0,s=x(e),o=this.indexedFeaturesExtents_[s];if(o){const i=this.rBush_,r=[];i.forEachInExtent(o,function(a){e===a.feature&&r.push(a)});for(let a=r.length-1;a>=0;--a)i.remove(r[a])}n&&(G(this.featureChangeListenerKeys_[s]),delete this.featureChangeListenerKeys_[s])}setMap(e){const t=this.getMap(),n=this.featuresListenerKeys_,s=this.getFeatures_();t&&(n.forEach(G),n.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(G),this.featureChangeListenerKeys_={}),super.setMap(e),e&&(this.features_?n.push(y(this.features_,P.ADD,this.handleFeatureAdd_,this),y(this.features_,P.REMOVE,this.handleFeatureRemove_,this)):this.source_&&n.push(y(this.source_,S.ADDFEATURE,this.handleFeatureAdd_,this),y(this.source_,S.REMOVEFEATURE,this.handleFeatureRemove_,this)),s.forEach(o=>this.addFeature(o)))}snapTo(e,t,n){n.getView().getProjection();const s=p(t),o=B(K(F([s]),n.getView().getResolution()*this.pixelTolerance_)),i=this.rBush_.getInExtent(o),r=i.length;if(r===0)return null;let a,l=1/0,f,E=null;const R=this.pixelTolerance_*this.pixelTolerance_,T=()=>{if(a){const u=n.getPixelFromCoordinate(a);if(C(e,u)<=R)return{vertex:a,vertexPixel:[Math.round(u[0]),Math.round(u[1])],feature:f,segment:E}}return null};if(this.vertex_){for(let c=0;c<r;++c){const h=i[c];h.feature.getGeometry().getType()!=="Circle"&&h.segment.forEach(g=>{const d=p(g),_=C(s,d);_<l&&(a=g,l=_,f=h.feature)})}const u=T();if(u)return u}if(this.edge_){for(let c=0;c<r;++c){let h=null;const g=i[c];if(g.feature.getGeometry().getType()==="Circle"){let d=g.feature.getGeometry();h=O(s,d)}else{const[d,_]=g.segment;_&&(v[0]=p(d),v[1]=p(_),h=U(s,v))}if(h){const d=C(s,h);d<l&&(a=q(h),E=g.feature.getGeometry().getType()==="Circle"?null:g.segment,l=d)}}const u=T();if(u)return u}return null}updateFeature_(e){this.removeFeature(e,!1),this.addFeature(e,!1)}segmentCircleGeometry_(e,t){this.getMap().getView().getProjection();const o=V(t).getCoordinates()[0];for(let i=0,r=o.length-1;i<r;++i)e.push(o.slice(i,i+2))}segmentGeometryCollectionGeometry_(e,t){const n=t.getGeometriesArray();for(let s=0;s<n.length;++s){const o=this.GEOMETRY_SEGMENTERS_[n[s].getType()];o&&o(e,n[s])}}segmentLineStringGeometry_(e,t){const n=t.getCoordinates();for(let s=0,o=n.length-1;s<o;++s)e.push(n.slice(s,s+2))}segmentMultiLineStringGeometry_(e,t){const n=t.getCoordinates();for(let s=0,o=n.length;s<o;++s){const i=n[s];for(let r=0,a=i.length-1;r<a;++r)e.push(i.slice(r,r+2))}}segmentMultiPointGeometry_(e,t){t.getCoordinates().forEach(n=>{e.push([n])})}segmentMultiPolygonGeometry_(e,t){const n=t.getCoordinates();for(let s=0,o=n.length;s<o;++s){const i=n[s];for(let r=0,a=i.length;r<a;++r){const l=i[r];for(let f=0,E=l.length-1;f<E;++f)e.push(l.slice(f,f+2))}}}segmentPointGeometry_(e,t){e.push([t.getCoordinates()])}segmentPolygonGeometry_(e,t){const n=t.getCoordinates();for(let s=0,o=n.length;s<o;++s){const i=n[s];for(let r=0,a=i.length-1;r<a;++r)e.push(i.slice(r,r+2))}}}const $=Y;export{$ as S};
