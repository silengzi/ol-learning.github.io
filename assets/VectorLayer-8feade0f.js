import{c1 as ae,a4 as b,a3 as X,E as z,u as O,m as R,an as Z,i as W,aI as he,c2 as ue,ag as J,U as Q,aQ as le,bE as de,C as ce,c3 as fe,o as H,q as _e,c4 as ge,c as D,B as me,T as ye,F as B,b1 as N,t as S,a8 as Ee,aE as xe,c5 as pe,ak as Re,aj as Ce,aX as M,j as Ie,ad as Fe,w as ve,b2 as Ae,c6 as Ge,aU as Te}from"./Layer-d95863ce.js";import{R as we,x as V,H as w,e as De,h as Le,d as Y,i as j,g as Ne,E as P,r as $,j as Se}from"./featureloader-ea3986d0.js";import{C as Oe,c as k}from"./Layer-4850cb8d.js";class K extends ae{constructor(e){if(super(),this.on,this.once,this.un,this.id_=void 0,this.geometryName_="geometry",this.style_=null,this.styleFunction_=void 0,this.geometryChangeKey_=null,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),e)if(typeof e.getSimplifiedGeometry=="function"){const t=e;this.setGeometry(t)}else{const t=e;this.setProperties(t)}}clone(){const e=new K(this.hasProperties()?this.getProperties():null);e.setGeometryName(this.getGeometryName());const t=this.getGeometry();t&&e.setGeometry(t.clone());const n=this.getStyle();return n&&e.setStyle(n),e}getGeometry(){return this.get(this.geometryName_)}getId(){return this.id_}getGeometryName(){return this.geometryName_}getStyle(){return this.style_}getStyleFunction(){return this.styleFunction_}handleGeometryChange_(){this.changed()}handleGeometryChanged_(){this.geometryChangeKey_&&(b(this.geometryChangeKey_),this.geometryChangeKey_=null);const e=this.getGeometry();e&&(this.geometryChangeKey_=X(e,z.CHANGE,this.handleGeometryChange_,this)),this.changed()}setGeometry(e){this.set(this.geometryName_,e)}setStyle(e){this.style_=e,this.styleFunction_=e?Ue(e):void 0,this.changed()}setId(e){this.id_=e,this.changed()}setGeometryName(e){this.removeChangeListener(this.geometryName_,this.handleGeometryChanged_),this.geometryName_=e,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),this.handleGeometryChanged_()}}function Ue(m){if(typeof m=="function")return m;let e;return Array.isArray(m)?e=m:(O(typeof m.getZIndex=="function","Expected an `ol/style/Style` or an array of `ol/style/Style.js`"),e=[m]),function(){return e}}const Ve=K;class be{constructor(e){this.rbush_=new we(e),this.items_={}}insert(e,t){const n={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(n),this.items_[R(t)]=n}load(e,t){const n=new Array(t.length);for(let s=0,r=t.length;s<r;s++){const o=e[s],i=t[s],a={minX:o[0],minY:o[1],maxX:o[2],maxY:o[3],value:i};n[s]=a,this.items_[R(i)]=a}this.rbush_.load(n)}remove(e){const t=R(e),n=this.items_[t];return delete this.items_[t],this.rbush_.remove(n)!==null}update(e,t){const n=this.items_[R(t)],s=[n.minX,n.minY,n.maxX,n.maxY];Z(s,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(s){return s.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let n;for(let s=0,r=e.length;s<r;s++)if(n=t(e[s]),n)return n;return n}isEmpty(){return W(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return he(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const q=be,C={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};function Xe(m,e){return[[-1/0,-1/0,1/0,1/0]]}function Ye(m,e){return[m]}function je(m){return function(e,t,n){const s=m.getZForResolution(ue(t)),r=m.getTileRangeForExtentAndZ(J(e),s),o=[],i=[s,0,0];for(i[1]=r.minX;i[1]<=r.maxX;++i[1])for(i[2]=r.minY;i[2]<=r.maxY;++i[2])o.push(Q(m.getTileCoordExtent(i)));return o}}class A extends me{constructor(e,t,n){super(e),this.feature=t,this.features=n}}class We extends le{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=de,this.format_=e.format,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(O(this.format_,"`format` must be set when `url` is set"),this.loader_=V(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:Xe;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new q:null,this.loadedExtentsRtree_=new q,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let n,s;Array.isArray(e.features)?s=e.features:e.features&&(n=e.features,s=n.getArray()),!t&&n===void 0&&(n=new ce(s)),s!==void 0&&this.addFeaturesInternal(s),n!==void 0&&this.bindFeaturesCollection_(n)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=R(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const n=e.getGeometry();if(n){const s=n.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(s,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new A(C.ADDFEATURE,e))}setupChangeEvents_(e,t){this.featureChangeKeys_[e]=[X(t,z.CHANGE,this.handleFeatureChange_,this),X(t,fe.PROPERTYCHANGE,this.handleFeatureChange_,this)]}addToIndex_(e,t){let n=!0;const s=t.getId();return s!==void 0&&(s.toString()in this.idIndex_?n=!1:this.idIndex_[s.toString()]=t),n&&(O(!(e in this.uidIndex_),"The passed `feature` was already added to the source"),this.uidIndex_[e]=t),n}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],n=[],s=[];for(let r=0,o=e.length;r<o;r++){const i=e[r],a=R(i);this.addToIndex_(a,i)&&n.push(i)}for(let r=0,o=n.length;r<o;r++){const i=n[r],a=R(i);this.setupChangeEvents_(a,i);const u=i.getGeometry();if(u){const h=u.getExtent();t.push(h),s.push(i)}else this.nullGeometryFeatures_[a]=i}if(this.featuresRtree_&&this.featuresRtree_.load(t,s),this.hasListener(C.ADDFEATURE))for(let r=0,o=n.length;r<o;r++)this.dispatchEvent(new A(C.ADDFEATURE,n[r]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(C.ADDFEATURE,function(n){t||(t=!0,e.push(n.feature),t=!1)}),this.addEventListener(C.REMOVEFEATURE,function(n){t||(t=!0,e.remove(n.feature),t=!1)}),e.addEventListener(H.ADD,n=>{t||(t=!0,this.addFeature(n.element),t=!1)}),e.addEventListener(H.REMOVE,n=>{t||(t=!0,this.removeFeature(n.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const n in this.featureChangeKeys_)this.featureChangeKeys_[n].forEach(b);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){const n=s=>{this.removeFeatureInternal(s)};this.featuresRtree_.forEach(n);for(const s in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[s])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new A(C.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const n=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(n,function(s){if(s.getGeometry().intersectsCoordinate(e))return t(s)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(n){if(n.getGeometry().intersectsExtent(e)){const r=t(n);if(r)return r}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),W(this.nullGeometryFeatures_)||_e(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(n){t.push(n)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const s=ge(e,t);return[].concat(...s.map(r=>this.featuresRtree_.getInExtent(r)))}return this.featuresCollection_?this.featuresCollection_.getArray().slice(0):[]}getClosestFeatureToCoordinate(e,t){const n=e[0],s=e[1];let r=null;const o=[NaN,NaN];let i=1/0;const a=[-1/0,-1/0,1/0,1/0];return t=t||ye,this.featuresRtree_.forEachInExtent(a,function(u){if(t(u)){const h=u.getGeometry(),l=i;if(i=h.closestPointXY(n,s,o,i),i<l){r=u;const d=Math.sqrt(i);a[0]=n-d,a[1]=s-d,a[2]=n+d,a[3]=s+d}}}),r}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,n=R(t),s=t.getGeometry();if(!s)n in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[n]=t);else{const o=s.getExtent();n in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[n],this.featuresRtree_&&this.featuresRtree_.insert(o,t)):this.featuresRtree_&&this.featuresRtree_.update(o,t)}const r=t.getId();if(r!==void 0){const o=r.toString();this.idIndex_[o]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[o]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[n]=t;this.changed(),this.dispatchEvent(new A(C.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:R(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&W(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,n){const s=this.loadedExtentsRtree_,r=this.strategy_(e,t,n);for(let o=0,i=r.length;o<i;++o){const a=r[o];s.forEachInExtent(a,function(h){return D(h.extent,a)})||(++this.loadingExtentsCount_,this.dispatchEvent(new A(C.FEATURESLOADSTART)),this.loader_.call(this,a,t,n,h=>{--this.loadingExtentsCount_,this.dispatchEvent(new A(C.FEATURESLOADEND,void 0,h))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new A(C.FEATURESLOADERROR))}),s.insert(a,{extent:a.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_;let n;t.forEachInExtent(e,function(s){if(Z(s.extent,e))return n=s,!0}),n&&t.remove(n)}removeFeature(e){if(!e)return;const t=R(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=R(e),n=this.featureChangeKeys_[t];if(!n)return;n.forEach(b),delete this.featureChangeKeys_[t];const s=e.getId();return s!==void 0&&delete this.idIndex_[s.toString()],delete this.uidIndex_[t],this.dispatchEvent(new A(C.REMOVEFEATURE,e)),e}removeFromIdIndex_(e){let t=!1;for(const n in this.idIndex_)if(this.idIndex_[n]===e){delete this.idIndex_[n],t=!0;break}return t}setLoader(e){this.loader_=e}setUrl(e){O(this.format_,"`format` must be set when `url` is set"),this.url_=e,this.setLoader(V(e,this.format_))}}const Pe=We;class Ke extends Oe{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=B(),this.wrappedRenderedExtent_=B(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,n){const s=t.extent,r=t.viewState,o=r.center,i=r.resolution,a=r.projection,u=r.rotation,h=a.getExtent(),l=this.getLayer().getSource(),d=t.pixelRatio,_=t.viewHints,g=!(_[N.ANIMATING]||_[N.INTERACTING]),f=this.compositionContext_,E=Math.round(t.size[0]*d),c=Math.round(t.size[1]*d),p=l.getWrapX()&&a.canWrapX(),v=p?S(h):null,I=p?Math.ceil((s[2]-h[2])/v)+1:1;let T=p?Math.floor((s[0]-h[0])/v):0;do{const G=this.getRenderTransform(o,i,u,d,E,c,T*v);e.execute(f,1,G,u,g,void 0,n)}while(++T<I)}setupCompositionContext_(){if(this.opacity_!==1){const e=Ee(this.context.canvas.width,this.context.canvas.height,k);this.compositionContext_=e}else this.compositionContext_=this.context}releaseCompositionContext_(){if(this.opacity_!==1){const e=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,xe(this.compositionContext_),k.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(e){this.declutterExecutorGroup&&(this.setupCompositionContext_(),this.renderWorlds(this.declutterExecutorGroup,e,e.declutterTree),this.releaseCompositionContext_())}renderFrame(e,t){const n=e.pixelRatio,s=e.layerStatesArray[e.layerIndex];pe(this.pixelTransform,1/n,1/n),Re(this.inversePixelTransform,this.pixelTransform);const r=Ce(this.pixelTransform);this.useContainer(t,r,this.getBackground(e));const o=this.context,i=o.canvas,a=this.replayGroup_,u=this.declutterExecutorGroup;let h=a&&!a.isEmpty()||u&&!u.isEmpty();if(!h&&!(this.getLayer().hasListener(M.PRERENDER)||this.getLayer().hasListener(M.POSTRENDER)))return null;const l=Math.round(e.size[0]*n),d=Math.round(e.size[1]*n);i.width!=l||i.height!=d?(i.width=l,i.height=d,i.style.transform!==r&&(i.style.transform=r)):this.containerReused||o.clearRect(0,0,l,d),this.preRender(o,e);const _=e.viewState;_.projection,this.opacity_=s.opacity,this.setupCompositionContext_();let g=!1;if(h&&s.extent&&this.clipping){const f=J(s.extent);h=Ie(f,e.extent),g=h&&!D(f,e.extent),g&&this.clipUnrotated(this.compositionContext_,e,f)}return h&&this.renderWorlds(a,e),g&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(o,e),this.renderedRotation_!==_.rotation&&(this.renderedRotation_=_.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise(t=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const n=[this.context.canvas.width,this.context.canvas.height];Fe(this.pixelTransform,n);const s=this.renderedCenter_,r=this.renderedResolution_,o=this.renderedRotation_,i=this.renderedProjection_,a=this.wrappedRenderedExtent_,u=this.getLayer(),h=[],l=n[0]*w,d=n[1]*w;h.push(this.getRenderTransform(s,r,o,w,l,d,0).slice());const _=u.getSource(),g=i.getExtent();if(_.getWrapX()&&i.canWrapX()&&!D(g,a)){let f=a[0];const E=S(g);let c=0,p;for(;f<g[0];)--c,p=E*c,h.push(this.getRenderTransform(s,r,o,w,l,d,p).slice()),f+=E;for(c=0,f=a[2];f>g[2];)++c,p=E*c,h.push(this.getRenderTransform(s,r,o,w,l,d,p).slice()),f-=E}this.hitDetectionImageData_=De(n,h,this.renderedFeatures_,u.getStyleFunction(),a,r,o)}t(Le(e,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(e,t,n,s,r){if(!this.replayGroup_)return;const o=t.viewState.resolution,i=t.viewState.rotation,a=this.getLayer(),u={},h=function(_,g,f){const E=R(_),c=u[E];if(c){if(c!==!0&&f<c.distanceSq){if(f===0)return u[E]=!0,r.splice(r.lastIndexOf(c),1),s(_,a,g);c.geometry=g,c.distanceSq=f}}else{if(f===0)return u[E]=!0,s(_,a,g);r.push(u[E]={feature:_,layer:a,geometry:g,distanceSq:f,callback:s})}};let l;const d=[this.replayGroup_];return this.declutterExecutorGroup&&d.push(this.declutterExecutorGroup),d.some(_=>l=_.forEachFeatureAtCoordinate(e,o,i,n,h,_===this.declutterExecutorGroup&&t.declutterTree?t.declutterTree.all().map(g=>g.value):null)),l}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),n=t.getSource();if(!n)return!1;const s=e.viewHints[N.ANIMATING],r=e.viewHints[N.INTERACTING],o=t.getUpdateWhileAnimating(),i=t.getUpdateWhileInteracting();if(this.ready&&!o&&s||!i&&r)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const a=e.extent,u=e.viewState,h=u.projection,l=u.resolution,d=e.pixelRatio,_=t.getRevision(),g=t.getRenderBuffer();let f=t.getRenderOrder();f===void 0&&(f=Se);const E=u.center.slice(),c=ve(a,g*l),p=c.slice(),v=[c.slice()],I=h.getExtent();if(n.getWrapX()&&h.canWrapX()&&!D(I,e.extent)){const y=S(I),F=Math.max(S(c)/2,y);c[0]=I[0]-F,c[2]=I[2]+F,Ae(E,h);const x=Ge(v[0],h);x[0]<I[0]&&x[2]<I[2]?v.push([x[0]+y,x[1],x[2]+y,x[3]]):x[0]>I[0]&&x[2]>I[2]&&v.push([x[0]-y,x[1],x[2]-y,x[3]])}if(this.ready&&this.renderedResolution_==l&&this.renderedRevision_==_&&this.renderedRenderOrder_==f&&D(this.wrappedRenderedExtent_,c))return Te(this.renderedExtent_,p)||(this.hitDetectionImageData_=null,this.renderedExtent_=p),this.renderedCenter_=E,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const T=new Y(j(l,d),c,l,d);let G;this.getLayer().getDeclutter()&&(G=new Y(j(l,d),c,l,d));let ee;for(let y=0,F=v.length;y<F;++y)n.loadFeatures(v[y],l,h);const te=Ne(l,d);let U=!0;const ne=y=>{let F;const x=y.getStyleFunction()||t.getStyleFunction();if(x&&(F=x(y,l)),F){const oe=this.renderFeature(y,te,F,T,ee,G);U=U&&!oe}},se=Q(c),L=n.getFeaturesInExtent(se);f&&L.sort(f);for(let y=0,F=L.length;y<F;++y)ne(L[y]);this.renderedFeatures_=L,this.ready=U;const re=T.finish(),ie=new P(c,l,d,n.getOverlaps(),re,t.getRenderBuffer());return G&&(this.declutterExecutorGroup=new P(c,l,d,n.getOverlaps(),G.finish(),t.getRenderBuffer())),this.renderedResolution_=l,this.renderedRevision_=_,this.renderedRenderOrder_=f,this.renderedExtent_=p,this.wrappedRenderedExtent_=c,this.renderedCenter_=E,this.renderedProjection_=h,this.replayGroup_=ie,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,n,s,r,o){if(!n)return!1;let i=!1;if(Array.isArray(n))for(let a=0,u=n.length;a<u;++a)i=$(s,e,n[a],t,this.boundHandleStyleImageChange_,r,o)||i;else i=$(s,e,n,t,this.boundHandleStyleImageChange_,r,o);return i}}const $e=Ke;export{$e as C,Ve as F,q as R,Pe as V,C as a,Ye as b,je as t};
