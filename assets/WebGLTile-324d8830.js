import{ac as b,a8 as Ee,X as W,ax as Le,aE as be,a3 as ht,a4 as Ne,E as M,Y as Ue,a7 as Y,ao as Q,m as w,g as ft,c9 as dt,ca as Tt,u as Et,cb as _t,aT as re,ai as je,p as gt,aS as pt,cc as ze,aX as j,aW as se,ap as Rt,aq as He,cd as mt,b4 as yt,b3 as Oe,ce as xt,b5 as At,cf as St,ag as We,ad as Ct,ae as Pe,G as Lt,cg as bt,ch as Nt,aV as Ut}from"./Layer-d95863ce.js";import{n as Ot,q as ae,r as Pt,s as It,E as Dt,t as vt,k as wt,c as Gt,e as Bt,l as Ft,g as $t,f as Mt,i as Ie,m as le,I as Ye,R as _e,h as V,d as Xt,a as De,L as jt}from"./TileProperty-0dbbd060.js";import{B as zt}from"./BaseTile-0f70055b.js";function ne(n){return n instanceof Image||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageBitmap?n:null}function de(n){return n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Float32Array||n instanceof DataView?n:null}let z=null;function Ht(n){z||(z=Ee(n.width,n.height,void 0,{willReadFrequently:!0}));const e=z.canvas,t=n.width;e.width!==t&&(e.width=t);const r=n.height;return e.height!==r&&(e.height=r),z.clearRect(0,0,t,r),z.drawImage(n,0,0),z.getImageData(0,0,t,r).data}const Wt=[256,256];let Yt=class extends Ot{constructor(e){const t=b.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null}getSize(){if(this.size_)return this.size_;const e=ne(this.data_);return e?[e.width,e.height]:Wt}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=b.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=b.ERROR,e.changed()})}};const ge=Yt;class Kt extends ge{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8Array(4)),interpolate:e.interpolate,transition:e.transition}),this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),r=this.targetTileGrid_.getExtent();let i=this.sourceTileGrid_.getExtent();const o=r?W(t,r):t;if(Le(o)===0){this.state=b.EMPTY;return}const s=e.sourceProj,a=s.getExtent();a&&(i?i=W(i,a):i=a);const f=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),c=e.targetProj,u=It(s,c,o,f);if(!isFinite(u)||u<=0){this.state=b.EMPTY;return}const h=e.errorThreshold!==void 0?e.errorThreshold:Dt;if(this.triangulation_=new vt(s,c,o,i,u*h,f),this.triangulation_.getTriangles().length===0){this.state=b.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let E=this.triangulation_.calculateSourceExtent();if(i&&(s.canWrapX()?(E[1]=Ue(E[1],i[1],i[3]),E[3]=Ue(E[3],i[1],i[3])):E=W(E,i)),!Le(E))this.state=b.EMPTY;else{const d=this.sourceTileGrid_.getTileRangeForExtentAndZ(E,this.sourceZ_),g=e.getTileFunction;for(let L=d.minX;L<=d.maxX;L++)for(let m=d.minY;m<=d.maxY;m++){const C=g(this.sourceZ_,L,m,this.pixelRatio_);C&&this.sourceTiles_.push(C)}this.sourceTiles_.length===0&&(this.state=b.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{if(!t||t.getState()!==b.LOADED)return;const r=t.getSize(),i=this.gutter_;let o;const s=de(t.getData());s?o=s:o=Ht(ne(t.getData()));const a=[r[0]+2*i,r[1]+2*i],f=o instanceof Float32Array,c=a[0]*a[1],u=f?Float32Array:Uint8Array,h=new u(o.buffer),E=u.BYTES_PER_ELEMENT,d=E*h.length/c,g=h.byteLength/a[1],L=Math.floor(g/E/a[0]),m=c*L;let C=h;if(h.length!==m){C=new u(m);let p=0,A=0;const x=a[0]*L;for(let S=0;S<a[1];++S){for(let y=0;y<x;++y)C[p++]=h[A+y];A+=g/E}}e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),data:new Uint8Array(C.buffer),dataType:u,bytesPerPixel:d,pixelSize:a})}),this.sourceTiles_.length=0,e.length===0)this.state=b.ERROR;else{const t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),i=typeof r=="number"?r:r[0],o=typeof r=="number"?r:r[1],s=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),f=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);let c,u;const h=e[0].bytesPerPixel,E=Math.ceil(h/3);for(let d=E-1;d>=0;--d){const g=[];for(let x=0,S=e.length;x<S;++x){const y=e[x],N=y.data,O=y.pixelSize,v=O[0],D=O[1],B=Ee(v,D,ae),Ce=B.createImageData(v,D),K=Ce.data;let J=d*3;for(let X=0,ut=K.length;X<ut;X+=4)K[X]=N[J],K[X+1]=N[J+1],K[X+2]=N[J+2],K[X+3]=255,J+=h;B.putImageData(Ce,0,0),g.push({extent:y.extent,image:B.canvas})}const L=Pt(i,o,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),s,f,this.triangulation_,g,this.gutter_,!1,!1);for(let x=0,S=g.length;x<S;++x){const N=g[x].image.getContext("2d");be(N),ae.push(N.canvas)}const m=L.getContext("2d"),C=m.getImageData(0,0,L.width,L.height);be(m),ae.push(L),c||(u=new Uint8Array(h*C.width*C.height),c=new e[0].dataType(u.buffer));const p=C.data;let A=d*3;for(let x=0,S=p.length;x<S;x+=4)p[x+3]===255?(u[A]=p[x],u[A+1]=p[x+1],u[A+2]=p[x+2]):(u[A]=0,u[A+1]=0,u[A+2]=0),A+=h}this.reprojData_=c,this.reprojSize_=[Math.round(i*this.pixelRatio_),Math.round(o*this.pixelRatio_)],this.state=b.LOADED}this.changed()}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(t=>{const r=t.getState();if(r!==b.IDLE&&r!==b.LOADING)return;e++;const i=ht(t,M.CHANGE,function(){const o=t.getState();(o==b.LOADED||o==b.ERROR||o==b.EMPTY)&&(Ne(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(t){t.getState()==b.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Ne),this.sourcesListenerKeys_=null}}const pe=Kt;class Vt extends wt{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Gt({extent:Bt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,opaque:e.opaque,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?Y(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.tileCacheForProjection_={}}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?Y(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return!t||Q(t,e)?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,i,o){const s=this.getTileCacheForProjection(i),a=Ie(e,t,r);if(s.containsKey(a)){const m=s.get(a);if(m&&m.key==this.getKey())return m}const f=this.getTileGrid(),c=Math.max.apply(null,f.getResolutions().map((m,C)=>{const p=Y(f.getTileSize(C)),A=this.getTileSize(C);return Math.max(A[0]/p[0],A[1]/p[1])})),u=this.getTileGridForProjection(o),h=this.getTileGridForProjection(i),E=[e,t,r],d=this.getTileCoordForTileUrlFunction(E,i),g=Object.assign({sourceProj:o,sourceTileGrid:u,targetProj:i,targetTileGrid:h,tileCoord:E,wrappedTileCoord:d,pixelRatio:c,gutter:this.getGutterForProjection(o),getTileFunction:(m,C,p,A)=>this.getTile(m,C,p,A,o)},this.tileOptions),L=new pe(g);return L.key=this.getKey(),L}getTile(e,t,r,i,o){const s=this.getProjection();if(s&&o&&!Q(s,o))return this.getReprojTile_(e,t,r,o,s);const a=this.getTileSize(e),f=Ie(e,t,r);if(this.tileCache.containsKey(f))return this.tileCache.get(f);const c=this.loader_;function u(){return dt(function(){return c(e,t,r)})}const h=Object.assign({tileCoord:[e,t,r],loader:u,size:a},this.tileOptions),E=new ge(h);return E.key=this.getKey(),E.addEventListener(M.CHANGE,this.handleTileChange_),this.tileCache.set(f,E),E}handleTileChange_(e){const t=e.target,r=w(t),i=t.getState();let o;i==b.LOADING?(this.tileLoadingKeys_[r]=!0,o=le.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],o=i==b.ERROR?le.TILELOADERROR:i==b.LOADED?le.TILELOADEND:void 0),o&&this.dispatchEvent(new Ft(o,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Q(t,e)))return this.tileGrid;const r=w(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=$t(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=ft(e);if(r){const i=w(r);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}getTileCacheForProjection(e){const t=this.getProjection();if(!t||Q(t,e))return this.tileCache;const r=w(e);return r in this.tileCacheForProjection_||(this.tileCacheForProjection_[r]=new Mt(.1)),this.tileCacheForProjection_[r]}expireCache(e,t){const r=this.getTileCacheForProjection(e);this.tileCache.expireCache(this.tileCache==r?t:{});for(const i in this.tileCacheForProjection_){const o=this.tileCacheForProjection_[i];o.expireCache(o==r?t:{})}}clear(){super.clear();for(const e in this.tileCacheForProjection_)this.tileCacheForProjection_[e].clear()}}const Mr=Vt,Re=34962,me=34963,Zt=35040,ye=35044,kt=35048,qt=5121,Jt=5123,Qt=5125,Ke=5126,ve=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function er(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Tt},e);const t=ve.length;for(let r=0;r<t;++r)try{const i=n.getContext(ve[r],e);if(i)return i}catch{}return null}const tr={STATIC_DRAW:ye,STREAM_DRAW:Zt,DYNAMIC_DRAW:kt};class rr{constructor(e,t){this.array=null,this.type=e,Et(e===Re||e===me,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage=t!==void 0?t:tr.STATIC_DRAW}ofSize(e){return this.array=new(ce(this.type))(e),this}fromArray(e){return this.array=ce(this.type).from(e),this}fromArrayBuffer(e){return this.array=new(ce(this.type))(e),this}getType(){return this.type}getArray(){return this.array}getUsage(){return this.usage}getSize(){return this.array?this.array.length:0}}function ce(n){switch(n){case Re:return Float32Array;case me:return Uint32Array;default:return Float32Array}}const Ve=rr,ee={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},nr=`
  precision mediump float;
  
  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;
  
  uniform vec2 u_screenSize;
   
  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,ir=`
  precision mediump float;
   
  uniform sampler2D u_image;
  uniform float u_opacity;
   
  varying vec2 v_texCoord;
   
  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class or{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||nr),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||ir),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const o=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(s=>{this.uniforms_.push({value:e.uniforms[s],location:t.getUniformLocation(this.renderTargetProgram_,s)})})}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,o=t.RGBA,s=0,a=t.RGBA,f=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,o,r[0],r[1],s,a,f,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,i){const o=this.getGL(),s=e.size;if(o.bindFramebuffer(o.FRAMEBUFFER,t?t.getFrameBuffer():null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.renderTargetTexture_),!t){const f=w(o.canvas);if(!e.renderTargets[f]){const c=o.getContextAttributes();c&&c.preserveDrawingBuffer&&(o.clearColor(0,0,0,0),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)),e.renderTargets[f]=!0}}o.disable(o.DEPTH_TEST),o.enable(o.BLEND),o.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.bindBuffer(o.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),o.useProgram(this.renderTargetProgram_),o.enableVertexAttribArray(this.renderTargetAttribLocation_),o.vertexAttribPointer(this.renderTargetAttribLocation_,2,o.FLOAT,!1,0,0),o.uniform2f(this.renderTargetUniformLocation_,s[0],s[1]),o.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;o.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(o,e),o.drawArrays(o.TRIANGLES,0,6),i&&i(o,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(o){if(r=typeof o.value=="function"?o.value(e):o.value,r instanceof HTMLCanvasElement||r instanceof ImageData)o.texture||(o.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,o.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(o.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(o.location,r[0],r[1]);return;case 3:t.uniform3f(o.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(o.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(o.location,r)})}}const we=or;function Ze(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ke(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}const F={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},Z={UNSIGNED_BYTE:qt,UNSIGNED_SHORT:Jt,UNSIGNED_INT:Qt,FLOAT:Ke},ie={};function Ge(n){return"shared/"+n}let Be=0;function sr(){const n="unique/"+Be;return Be+=1,n}function ar(n){let e=ie[n];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:er(t)},ie[n]=e}return e.users+=1,e.context}function lr(n){const e=ie[n];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const i=t.canvas;i.width=1,i.height=1,delete ie[n]}class cr extends _t{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Ge(e.canvasCacheKey):sr(),this.gl_=ar(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(ee.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(ee.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=re(),this.offsetScaleMatrix_=re(),this.tmpMat4_=Ze(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new we({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new we({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Ge(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=w(e);let i=this.bufferCache_[r];if(!i){const o=t.createBuffer();i={buffer:e,webGlBuffer:o},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=this.gl_,r=w(e),i=this.bufferCache_[r];i&&!t.isContextLost()&&t.deleteBuffer(i.webGlBuffer),delete this.bufferCache_[r]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(ee.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(ee.RESTORED,this.boundHandleWebGLContextRestored_),lr(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const i=this.gl_,o=this.getCanvas(),s=e.size,a=e.pixelRatio;(o.width!==s[0]*a||o.height!==s[1]*a)&&(o.width=s[0]*a,o.height=s[1]*a,o.style.width=s[0]+"px",o.style.height=s[1]+"px");for(let f=this.postProcessPasses_.length-1;f>=0;f--)this.postProcessPasses_[f].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),r?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindTexture(e,t,r){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(r),t)}prepareDrawToRenderTarget(e,t,r,i){const o=this.gl_,s=t.getSize();o.bindFramebuffer(o.FRAMEBUFFER,t.getFramebuffer()),o.bindRenderbuffer(o.RENDERBUFFER,t.getDepthbuffer()),o.viewport(0,0,s[0],s[1]),o.bindTexture(o.TEXTURE_2D,t.getTexture()),o.clearColor(0,0,0,0),o.depthRange(0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),o.blendFunc(o.ONE,r?o.ZERO:o.ONE_MINUS_SRC_ALPHA),i?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,o=4,s=t-e,a=e*o;r.drawElements(r.TRIANGLES,s,i,a)}finalizeDraw(e,t,r){for(let i=0,o=this.postProcessPasses_.length;i<o;i++)i===o-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(F.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(F.ZOOM,e.viewState.zoom),this.setUniformFloatValue(F.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(F.PIXEL_RATIO,i),this.setUniformFloatVec2(F.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(F.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(F.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(F.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,i=0;this.uniforms_.forEach(o=>{if(r=typeof o.value=="function"?o.value(e):o.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData)o.texture||(o.prevValue=void 0,o.texture=t.createTexture()),this.bindTexture(o.texture,i,o.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(!(r instanceof HTMLImageElement)||r.complete)&&o.prevValue!==r&&(o.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),i++;else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(o.name,ke(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(o.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(o.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(o.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(o.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,this.applyFrameState(t),this.applyUniforms(t)}compileShader(e,t){const r=this.gl_,i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.gl_,i=this.compileShader(e,r.FRAGMENT_SHADER),o=this.compileShader(t,r.VERTEX_SHADER),s=r.createProgram();if(r.attachShader(s,i),r.attachShader(s,o),r.linkProgram(s),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(o,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(o)}`;throw new Error(a)}if(r.deleteShader(o),!r.getProgramParameter(s,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(s)}`;throw new Error(a)}return s}getUniformLocation(e){const t=w(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=w(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,o=e.viewState.resolution,s=e.viewState.center;return je(t,0,0,2/(o*r[0]),2/(o*r[1]),-i,-s[0],-s[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,i,o){const s=this.getAttributeLocation(e);s<0||(this.gl_.enableVertexAttribArray(s),this.gl_.vertexAttribPointer(s,t,r,!1,i,o))}enableAttributes(e){const t=ur(e);let r=0;for(let i=0;i<e.length;i++){const o=e[i];this.enableAttributeArray_(o.name,o.size,o.type||Ke,t,r),r+=o.size*qe(o.type)}}handleWebGLContextLost(e){gt(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r){const i=this.gl_;r=r||i.createTexture();const o=0,s=i.RGBA,a=0,f=i.RGBA,c=i.UNSIGNED_BYTE;return i.bindTexture(i.TEXTURE_2D,r),t?i.texImage2D(i.TEXTURE_2D,o,s,f,c,t):i.texImage2D(i.TEXTURE_2D,o,s,e[0],e[1],a,f,c,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r}}function ur(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*qe(r.type)}return e}function qe(n){switch(n){case Z.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case Z.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case Z.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case Z.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class xe extends pt{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=re(),this.pixelContext_=null,this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,e.addChangeListener(ze.MAP,this.removeHelper.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(j.PRECOMPOSE)){const i=new se(j.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(j.POSTCOMPOSE)){const i=new se(j.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let s=0,a=e.layerStatesArray.length;s<a;s++){const f=e.layerStatesArray[s].layer,c=f.getRenderer();if(!(c instanceof xe)){t=!0;continue}const u=f.getClassName();if((t||u!==i)&&(r+=1,t=!1),i=u,c===this)break}const o="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(o)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new cr({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:o}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){je(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const o=new se(e,this.inversePixelTransform_,r,t);i.dispatchEvent(o)}}preRender(e,t){this.dispatchRenderEvent_(j.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(j.POSTRENDER,e,t)}}const hr=xe;class fr{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}}const dr=fr;class Tr extends Rt{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter_=e.gutter||0,this.helper_=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(M.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===b.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Ye){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(M.CHANGE,this.handleTileChange_)}}uploadTile(){He()}setReady(){this.ready=!0,this.dispatchEvent(M.CHANGE)}handleTileChange_(){this.tile.getState()===b.LOADED&&(this.loaded=!0,this.uploadTile())}disposeInternal(){this.tile.removeEventListener(M.CHANGE,this.handleTileChange_)}}const Er=Tr;function Je(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function _r(n,e,t,r){Je(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function Fe(n,e,t,r,i,o){const s=n.getGL();let a,f;t instanceof Float32Array?(a=s.FLOAT,n.getExtension("OES_texture_float"),f=n.getExtension("OES_texture_float_linear")!==null):(a=s.UNSIGNED_BYTE,f=!0),Je(s,e,o&&f);const c=t.byteLength/r[1];let u=1;c%8===0?u=8:c%4===0?u=4:c%2===0&&(u=2);let h;switch(i){case 1:{h=s.LUMINANCE;break}case 2:{h=s.LUMINANCE_ALPHA;break}case 3:{h=s.RGB;break}case 4:{h=s.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const E=s.getParameter(s.UNPACK_ALIGNMENT);s.pixelStorei(s.UNPACK_ALIGNMENT,u),s.texImage2D(s.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),s.pixelStorei(s.UNPACK_ALIGNMENT,E)}let H=null;function gr(){H=Ee(1,1,void 0,{willReadFrequently:!0})}class pr extends Er{constructor(e){super(e),this.textures=[],this.renderSize_=Y(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Ve(Re,ye);t.fromArray([0,1,1,1,1,0,0,0]),this.helper_.flushBufferData(t),this.coords=t,this.setTile(e.tile)}uploadTile(){const e=this.helper_,t=e.getGL(),r=this.tile;this.textures.length=0;let i;r instanceof Ye||r instanceof _e?i=r.getImage():i=r.getData();const o=ne(i);if(o){const p=t.createTexture();this.textures.push(p),this.bandCount=4,_r(t,p,o,r.interpolate),this.setReady();return}i=de(i);const s=r.getSize(),a=[s[0]+2*this.gutter_,s[1]+2*this.gutter_],f=i instanceof Float32Array,c=a[0]*a[1],u=f?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,E=i.byteLength/a[1];this.bandCount=Math.floor(E/h/a[0]);const d=Math.ceil(this.bandCount/4);if(d===1){const p=t.createTexture();this.textures.push(p),Fe(e,p,i,a,this.bandCount,r.interpolate),this.setReady();return}const g=new Array(d);for(let p=0;p<d;++p){const A=t.createTexture();this.textures.push(A);const x=p<d-1?4:(this.bandCount-1)%4+1;g[p]=new u(c*x)}let L=0,m=0;const C=a[0]*this.bandCount;for(let p=0;p<a[1];++p){for(let A=0;A<C;++A){const x=i[m+A],S=Math.floor(L/this.bandCount),y=A%this.bandCount,N=Math.floor(y/4),O=g[N],v=O.length/c,D=y%4;O[S*v+D]=x,++L}m+=E/h}for(let p=0;p<d;++p){const A=this.textures[p],x=g[p],S=x.length/c;Fe(e,A,x,a,S,r.interpolate)}this.setReady()}disposeInternal(){const e=this.helper_.getGL();this.helper_.deleteBuffer(this.coords);for(let t=0;t<this.textures.length;++t)e.deleteTexture(this.textures[t]);this.tile.removeEventListener(M.CHANGE,this.handleTileChange_)}getImagePixelData_(e,t,r){const i=this.gutter_,o=this.renderSize_[0],s=this.renderSize_[1];H||gr(),H.clearRect(0,0,1,1);const a=e.width,f=e.height,c=a-2*i,u=f-2*i,h=i+Math.floor(c*(t/o)),E=i+Math.floor(u*(r/s));let d;try{H.drawImage(e,h,E,1,1,0,0,1,1),d=H.getImageData(0,0,1,1).data}catch{return H=null,null}return d}getArrayPixelData_(e,t,r,i){const o=this.gutter_,s=this.renderSize_[0],a=this.renderSize_[1],f=t[0],c=t[1],u=f+2*o,h=c+2*o,E=o+Math.floor(f*(r/s)),d=o+Math.floor(c*(i/a));if(e instanceof DataView){const L=e.byteLength/(u*h),m=L*(d*u+E),C=e.buffer.slice(m,m+L);return new DataView(C)}const g=this.bandCount*(d*u+E);return e.slice(g,g+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof ge){const r=this.tile.getData(),i=de(r);if(i){const o=this.tile.getSize();return this.getArrayPixelData_(i,o,e,t)}return this.getImagePixelData_(ne(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const Rr=pr,mr={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"},yr={};function xr(n){return 1/(n+2)}function Ar(){return{tileIds:new Set,representationsByZ:{}}}function $e(n,e){return n.tileIds.has(w(e))}function Me(n,e,t){const r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(w(e.tile))}function ue(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=W(e,We(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=W(e,i))}return e}function Te(n,e){return`${n.getKey()},${V(e)}`}class Sr extends hr{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=re(),this.tempMat4=Ze(),this.tempTileRange_=new Xt(0,0,0,0),this.tempTileCoord_=De(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new jt(r),this.frameState=null,this.projection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}isDrawableTile_(e){const t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return r==b.LOADED||r==b.EMPTY||r==b.ERROR&&!i}prepareFrameInternal(e){this.projection_?e.viewState.projection!==this.projection_&&(this.clearCache(),this.projection_=e.viewState.projection):this.projection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||mt(ue(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return He()}enqueueTiles(e,t,r,i,o){const s=e.viewState,a=this.getLayer(),f=a.getRenderSource(),c=f.getTileGridForProjection(s.projection),u=f.getGutterForProjection(s.projection),h=w(f);h in e.wantedTiles||(e.wantedTiles[h]={});const E=e.wantedTiles[h],d=this.tileRepresentationCache,g=a.getMapInternal(),L=Math.max(r-o,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),g?g.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),f.zDirection));for(let m=r;m>=L;--m){const C=c.getTileRangeForExtentAndZ(t,m,this.tempTileRange_),p=c.getResolution(m);for(let A=C.minX;A<=C.maxX;++A)for(let x=C.minY;x<=C.maxY;++x){const S=De(m,A,x,this.tempTileCoord_),y=Te(f,S);let N,O;if(d.containsKey(y)&&(N=d.get(y),O=N.tile),(!N||N.tile.key!==f.getKey())&&(O=f.getTile(m,A,x,e.pixelRatio,s.projection)),$e(i,O))continue;if(!N)N=this.createTileRepresentation({tile:O,grid:c,helper:this.helper,gutter:u}),d.set(y,N);else if(this.isDrawableTile_(O))N.setTile(O);else{const D=O.getInterimTile();N.setTile(D)}Me(i,N,m);const v=O.getKey();E[v]=!0,O.getState()===b.IDLE&&(e.tileQueue.isKeyQueued(v)||e.tileQueue.enqueue([O,h,c.getTileCoordCenter(S),p]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}renderTile(e,t,r,i,o,s,a,f,c,u,h){}drawTile_(e,t,r,i,o,s,a){if(!t.loaded)return;const c=t.tile.tileCoord,u=V(c),h=u in s?s[u]:1,E=a.getResolution(r),d=Y(a.getTileSize(r),this.tempSize_),g=a.getOrigin(r),L=a.getTileCoordExtent(c),m=h<1?-1:xr(r);h<1&&(e.animate=!0);const C=e.viewState,p=C.center[0],A=C.center[1],x=d[0]+2*i,S=d[1]+2*i,y=x/S,N=(p-g[0])/(d[0]*E),O=(g[1]-A)/(d[1]*E),v=C.resolution/E,D=c[1],B=c[2];yt(this.tileTransform_),Oe(this.tileTransform_,2/(e.size[0]*v/x),-2/(e.size[1]*v/x)),xt(this.tileTransform_,C.rotation),Oe(this.tileTransform_,1,1/y),At(this.tileTransform_,(d[0]*(D-N)-i)/x,(d[1]*(B-O)-i)/S),this.renderTile(t,this.tileTransform_,e,o,E,d,g,L,m,i,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),o=i.getRenderSource(),s=o.getTileGridForProjection(r.projection),a=o.getGutterForProjection(r.projection),f=ue(e,e.extent),c=s.getZForResolution(r.resolution,o.zDirection),u=Ar(),h=i.getPreload();if(e.nextExtent){const S=s.getZForResolution(r.nextResolution,o.zDirection),y=ue(e,e.nextExtent);this.enqueueTiles(e,y,S,u,h)}this.enqueueTiles(e,f,c,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,f,c-1,u,h-1)},0);const E={},d=w(this),g=e.time;let L=!1;for(const S of u.representationsByZ[c]){const y=S.tile;if((y instanceof _e||y instanceof pe)&&y.getState()===b.EMPTY)continue;const N=y.tileCoord;if(S.loaded){const D=y.getAlpha(d,g);if(D===1){y.endTransition(d);continue}L=!0;const B=V(N);E[B]=D}if(this.renderComplete=!1,this.findAltTiles_(s,N,c+1,u))continue;const v=s.getMinZoom();for(let D=c-1;D>=v&&!this.findAltTiles_(s,N,D,u);--D);}this.beforeTilesRender(e,L);const m=u.representationsByZ,C=Object.keys(m).map(Number).sort(St);for(let S=0,y=C.length;S<y;++S){const N=C[S];for(const O of m[N]){const v=O.tile.tileCoord;V(v)in E||this.drawTile_(e,O,N,a,f,E,s)}}for(const S of m[c]){const y=S.tile.tileCoord;V(y)in E&&this.drawTile_(e,S,c,a,f,E,s)}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const p=this.helper.getCanvas(),A=this.tileRepresentationCache;for(;A.canExpireCache();)A.pop().dispose();const x=function(S,y){o.updateCacheSize(.1,y.viewState.projection),o.expireCache(y.viewState.projection,yr)};return e.postRenderFunctions.push(x),this.postRender(t,e),p}findAltTiles_(e,t,r,i){const o=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!o)return!1;let s=!0;const a=this.tileRepresentationCache,f=this.getLayer().getRenderSource();for(let c=o.minX;c<=o.maxX;++c)for(let u=o.minY;u<=o.maxY;++u){const h=Te(f,[r,c,u]);let E=!1;if(a.containsKey(h)){const d=a.get(h);d.loaded&&!$e(i,d.tile)&&(Me(i,d,r),E=!0)}E||(s=!1)}return s}clearCache(){const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}removeHelper(){this.helper&&this.clearCache(),super.removeHelper()}disposeInternal(){super.disposeInternal(),delete this.frameState}}const Cr=Sr,R={...mr,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},te={TEXTURE_COORD:"a_textureCoord"},Lr=[{name:te.TEXTURE_COORD,size:2,type:Z.FLOAT}];class br extends Cr{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Ve(me,ye),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){super.reset(e),this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}createTileRepresentation(e){return new Rr(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,i,o,s,a,f,c,u,h){const E=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Lr);let d=0;for(;d<e.textures.length;){const y=`${R.TILE_TEXTURE_ARRAY}[${d}]`;this.helper.bindTexture(e.textures[d],d,y),++d}for(let y=0;y<this.paletteTextures_.length;++y){const N=this.paletteTextures_[y],O=N.getTexture(E);this.helper.bindTexture(O,d,N.name),++d}const g=r.viewState,L=s[0]+2*u,m=s[1]+2*u,p=e.tile.tileCoord,A=p[1],x=p[2];this.helper.setUniformMatrixValue(R.TILE_TRANSFORM,ke(this.tempMat4,t)),this.helper.setUniformFloatValue(R.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(R.DEPTH,c);let S=i;u>0&&(S=f,W(S,i,S)),this.helper.setUniformFloatVec4(R.RENDER_EXTENT,S),this.helper.setUniformFloatValue(R.RESOLUTION,g.resolution),this.helper.setUniformFloatValue(R.ZOOM,g.zoom),this.helper.setUniformFloatValue(R.TEXTURE_PIXEL_WIDTH,L),this.helper.setUniformFloatValue(R.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(R.TEXTURE_RESOLUTION,o),this.helper.setUniformFloatValue(R.TEXTURE_ORIGIN_X,a[0]+A*s[0]*o-u*o),this.helper.setUniformFloatValue(R.TEXTURE_ORIGIN_Y,a[1]-x*s[1]*o+u*o),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const i=this.getLayer(),o=Ct(r.pixelToCoordinateTransform,e.slice()),s=r.viewState,a=i.getExtent();if(a&&!Pe(We(a,s.projection),o))return null;const f=i.getSources(Lt([o]),s.resolution);let c,u,h;for(c=f.length-1;c>=0;--c)if(u=f[c],u.getState()==="ready"){if(h=u.getTileGridForProjection(s.projection),u.getWrapX())break;const d=h.getExtent();if(!d||Pe(d,o))break}if(c<0)return null;const E=this.tileRepresentationCache;for(let d=h.getZForResolution(s.resolution);d>=h.getMinZoom();--d){const g=h.getTileCoordForCoordAndZ(o,d),L=Te(u,g);if(!E.containsKey(L))continue;const m=E.get(L),C=m.tile;if((C instanceof _e||C instanceof pe)&&C.getState()===b.EMPTY)return null;if(!m.loaded)continue;const p=h.getOrigin(d),A=Y(h.getTileSize(d)),x=h.getResolution(d),S=(o[0]-p[0])/x-g[1]*A[0],y=(p[1]-o[1])/x-g[2]*A[1];return m.getPixelData(S,y)}return null}disposeInternal(){const e=this.helper;e&&(e.getGL().deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)),super.disposeInternal(),delete this.indices_}}const Nr=br,l={NUMBER:1,STRING:2,COLOR:4,BOOLEAN:8,NUMBER_ARRAY:16,ANY:31,NONE:0};function Ur(n){switch(n){case"string":return l.STRING;case"color":return l.COLOR;case"number":return l.NUMBER;case"boolean":return l.BOOLEAN;case"number[]":return l.NUMBER_ARRAY;default:throw new Error(`Unrecognized type hint: ${n}`)}}const _={};function I(n){if(typeof n=="number")return l.NUMBER;if(typeof n=="boolean")return l.BOOLEAN;if(typeof n=="string")return Nt(n)?l.COLOR|l.STRING:l.STRING;if(!Array.isArray(n))throw new Error(`Unhandled value type: ${JSON.stringify(n)}`);const e=n;if(e.every(function(i){return typeof i=="number"}))return e.length===3||e.length===4?l.COLOR|l.NUMBER_ARRAY:l.NUMBER_ARRAY;if(typeof e[0]!="string")throw new Error(`Expected an expression operator but received: ${JSON.stringify(e)}`);const r=_[e[0]];if(r===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return r.getReturnType(e.slice(1))}function Or(n){return Math.log2(n)%1===0}function $(n){const e=[];return(n&l.NUMBER)>0&&e.push("number"),(n&l.COLOR)>0&&e.push("color"),(n&l.BOOLEAN)>0&&e.push("boolean"),(n&l.NUMBER_ARRAY)>0&&e.push("number[]"),(n&l.STRING)>0&&e.push("string"),e.length>0?e.join(", "):"(no type)"}function Pr(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function oe(n){const e=n.toString();return e.includes(".")?e:e+".0"}function Qe(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(oe).join(", ")})`}function Ir(n){const e=Ut(n),t=e.length>3?e[3]:1;return Qe([e[0]/255*t,e[1]/255*t,e[2]/255*t,t])}const he={};let Dr=0;function et(n){return n in he||(he[n]=Dr++),he[n]}function vr(n){return oe(et(n))}function T(n,e,t){const r=t!==void 0?t:l.NUMBER;if(Array.isArray(e)&&typeof e[0]=="string"){const o=_[e[0]];if(o===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return o.toGlsl(n,e.slice(1),r)}const i=I(e)&r;if(it(e,i,""),(i&l.NUMBER)>0)return oe(e);if((i&l.BOOLEAN)>0)return e.toString();if((i&l.STRING)>0)return vr(e.toString());if((i&l.COLOR)>0)return Ir(e);if((i&l.NUMBER_ARRAY)>0)return Qe(e);throw new Error(`Unexpected expression ${e} (expected type ${$(r)})`)}function tt(n){if(!(I(n)&l.NUMBER))throw new Error(`A numeric value was expected, got ${JSON.stringify(n)} instead`)}function P(n){for(let e=0;e<n.length;e++)tt(n[e])}function rt(n){if(!(I(n)&l.STRING))throw new Error(`A string value was expected, got ${JSON.stringify(n)} instead`)}function Ae(n){if(!(I(n)&l.BOOLEAN))throw new Error(`A boolean value was expected, got ${JSON.stringify(n)} instead`)}function U(n,e){if(n.length!==e)throw new Error(`Exactly ${e} arguments were expected, got ${n.length} instead`)}function G(n,e){if(n.length<e)throw new Error(`At least ${e} arguments were expected, got ${n.length} instead`)}function k(n,e){if(n.length>e)throw new Error(`At most ${e} arguments were expected, got ${n.length} instead`)}function nt(n){if(n.length%2!==0)throw new Error(`An even amount of arguments was expected, got ${JSON.stringify(n)} instead`)}function wr(n){if(n.length%2===0)throw new Error(`An odd amount of arguments was expected, got ${JSON.stringify(n)} instead`)}function it(n,e,t){if(e===l.NONE)throw new Error(`No matching type was found for the following expression ${t}: ${JSON.stringify(n)}`)}function q(n,e,t){if(it(n,e,t),!Or(e))throw new Error(`Expected to have a unique type for the following expression ${t}: ${JSON.stringify(n)}
Got the following types instead: ${$(e)}`)}function Se(n,e,t,r){if((e&t)===l.NONE)throw new Error(`Expected the ${r} type of the following expression: ${JSON.stringify(n)} to be of the following types: ${$(t)}
Got these types instead: ${$(e)}`)}_.get={getReturnType:function(n){if(n.length===2){const e=n[1];return Ur(e)}return l.ANY},toGlsl:function(n,e,t){G(e,1),k(e,2),rt(e[0]);const r=t&_.get.getReturnType(e);q(["get",...e],r,"");const i=e[0].toString(),o=n.attributes.find(a=>a.name===i);if(!o)n.attributes.push({name:i,type:r});else if(r!==o.type)throw new Error(`The following attribute was used in different places with incompatible types: ${i}
Types were: ${$(o.type)} and ${$(r)}`);return(n.inFragmentShader?"v_":"a_")+i}};function ot(n){return"u_var_"+n}_.var={getReturnType:function(){return l.ANY},toGlsl:function(n,e,t){U(e,1),rt(e[0]);const r=e[0].toString();if(!n.style.variables||n.style.variables[r]===void 0)throw new Error(`The following variable is missing from the style: ${r}`);const i=n.style.variables[r],o=t&I(i);q(["var",...e],o,"");const s=n.variables.find(a=>a.name===r);if(!s)n.variables.push({name:r,type:o});else if(o!==s.type)throw new Error(`The following variable was used in different places with incompatible types: ${r}
Types were: ${$(s.type)} and ${$(o)}`);return ot(r)}};const st="u_paletteTextures";_.palette={getReturnType:function(){return l.COLOR},toGlsl:function(n,e){U(e,2),tt(e[0]);const t=T(n,e[0]),r=e[1];if(!Array.isArray(r))throw new Error("The second argument of palette must be an array");const i=r.length,o=new Uint8Array(i*4);for(let f=0;f<i;f++){const c=r[f];let u;if(typeof c=="string")u=bt(c);else{if(!Array.isArray(c))throw new Error("The second argument of palette must be an array of strings or colors");const E=c.length;if(E===4)u=c;else{if(E!==3)throw new Error(`Expected palette color to have 3 or 4 values, got ${E}`);u=[c[0],c[1],c[2],1]}}const h=f*4;o[h]=u[0],o[h+1]=u[1],o[h+2]=u[2],o[h+3]=u[3]*255}n.paletteTextures||(n.paletteTextures=[]);const s=`${st}[${n.paletteTextures.length}]`,a=new dr(s,o);return n.paletteTextures.push(a),`texture2D(${s}, vec2((${t} + 0.5) / ${i}.0, 0.5))`}};const fe="getBandValue";_.band={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){G(e,1),k(e,3);const t=e[0];if(!(fe in n.functions)){let s="";const a=n.bandCount||1;for(let f=0;f<a;f++){const c=Math.floor(f/4);let u=f%4;f===a-1&&u===1&&(u=3);const h=`${R.TILE_TEXTURE_ARRAY}[${c}]`;s+=`
          if (band == ${f+1}.0) {
            return texture2D(${h}, v_textureCoord + vec2(dx, dy))[${u}];
          }
        `}n.functions[fe]=`
        float getBandValue(float band, float xOffset, float yOffset) {
          float dx = xOffset / ${R.TEXTURE_PIXEL_WIDTH};
          float dy = yOffset / ${R.TEXTURE_PIXEL_HEIGHT};
          ${s}
        }
      `}const r=T(n,t),i=T(n,e[1]||0),o=T(n,e[2]||0);return`${fe}(${r}, ${i}, ${o})`}};_.time={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,0),"u_time"}};_.zoom={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,0),"u_zoom"}};_.resolution={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,0),"u_resolution"}};_["geometry-type"]={getReturnType:function(){return l.STRING},toGlsl:function(n,e){U(e,0);const t="geometryType",r=s=>{const a=s.getType();switch(a){case"Point":case"LineString":case"Polygon":return a;case"MultiPoint":case"MultiLineString":case"MultiPolygon":return a.substring(5);case"Circle":return"Polygon";case"GeometryCollection":return r(s.getGeometries()[0])}};return n.attributes.find(s=>s.name===t)||n.attributes.push({name:t,type:l.STRING,callback:s=>r(s.getGeometry())}),(n.inFragmentShader?"v_":"a_")+t}};_["*"]={getReturnType:function(n){let e=l.NUMBER|l.COLOR;for(let t=0;t<n.length;t++)e=e&I(n[t]);return e},toGlsl:function(n,e,t){G(e,2);let r=t;for(let i=0;i<e.length;i++)r=r&I(e[i]);return Se(e,r,l.NUMBER|l.COLOR,"output"),`(${e.map(i=>T(n,i,r)).join(" * ")})`}};_["/"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} / ${T(n,e[1])})`}};_["+"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return G(e,2),P(e),`(${e.map(t=>T(n,t)).join(" + ")})`}};_["-"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} - ${T(n,e[1])})`}};_.clamp={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){U(e,3),P(e);const t=T(n,e[1]),r=T(n,e[2]);return`clamp(${T(n,e[0])}, ${t}, ${r})`}};_["%"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,2),P(e),`mod(${T(n,e[0])}, ${T(n,e[1])})`}};_["^"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,2),P(e),`pow(${T(n,e[0])}, ${T(n,e[1])})`}};_.abs={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`abs(${T(n,e[0])})`}};_.floor={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`floor(${T(n,e[0])})`}};_.round={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`floor(${T(n,e[0])} + 0.5)`}};_.ceil={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`ceil(${T(n,e[0])})`}};_.sin={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`sin(${T(n,e[0])})`}};_.cos={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`cos(${T(n,e[0])})`}};_.atan={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return G(e,1),k(e,2),P(e),e.length===2?`atan(${T(n,e[0])}, ${T(n,e[1])})`:`atan(${T(n,e[0])})`}};_.sqrt={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return U(e,1),P(e),`sqrt(${T(n,e[0])})`}};_[">"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} > ${T(n,e[1])})`}};_[">="]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} >= ${T(n,e[1])})`}};_["<"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} < ${T(n,e[1])})`}};_["<="]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return U(e,2),P(e),`(${T(n,e[0])} <= ${T(n,e[1])})`}};function at(n){return{getReturnType:function(){return l.BOOLEAN},toGlsl:function(e,t){U(t,2);let r=l.ANY;for(let i=0;i<t.length;i++)r&=I(t[i]);if(r===l.NONE)throw new Error(`All arguments should be of compatible type, got ${JSON.stringify(t)} instead`);return r&=~l.COLOR,`(${T(e,t[0],r)} ${n} ${T(e,t[1],r)})`}}}_["=="]=at("==");_["!="]=at("!=");_["!"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return U(e,1),Ae(e[0]),`(!${T(n,e[0],l.BOOLEAN)})`}};function lt(n){return{getReturnType:function(){return l.BOOLEAN},toGlsl:function(e,t){G(t,2);for(let i=0;i<t.length;i++)Ae(t[i]);let r=t.map(i=>T(e,i,l.BOOLEAN)).join(` ${n} `);return r=`(${r})`,r}}}_.all=lt("&&");_.any=lt("||");_.between={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){U(e,3),P(e);const t=T(n,e[1]),r=T(n,e[2]),i=T(n,e[0]);return`(${i} >= ${t} && ${i} <= ${r})`}};_.array={getReturnType:function(){return l.NUMBER_ARRAY},toGlsl:function(n,e){G(e,2),k(e,4),P(e);const t=e.map(function(r){return T(n,r)});return`vec${e.length}(${t.join(", ")})`}};_.color={getReturnType:function(){return l.COLOR},toGlsl:function(n,e){G(e,3),k(e,4),P(e);const t=e.slice(0,3).map(i=>`${T(n,i)} / 255.0`);return e.length===3?`vec4(${t.join(", ")}, 1.0)`:`(${T(n,e[3])} * vec4(${t.join(", ")}, 1.0))`}};_.interpolate={getReturnType:function(n){let e=l.COLOR|l.NUMBER;for(let t=3;t<n.length;t+=2)e=e&I(n[t]);return e},toGlsl:function(n,e,t){nt(e),G(e,6);const r=e[0];let i;switch(r[0]){case"linear":i=1;break;case"exponential":i=r[1];break;default:i=null}if(!i)throw new Error(`Invalid interpolation type for "interpolate" operator, received: ${JSON.stringify(r)}`);const o=l.NUMBER,s=_.interpolate.getReturnType(e)&t;q(["interpolate",...e],s,"output");const a=T(n,e[1],o),f=oe(i);let c="";for(let u=2;u<e.length-2;u+=2){const h=T(n,e[u],o),E=c||T(n,e[u+1],s),d=T(n,e[u+2],o),g=T(n,e[u+3],s);let L;i===1?L=`(${a} - ${h}) / (${d} - ${h})`:L=`(pow(${f}, (${a} - ${h})) - 1.0) / (pow(${f}, (${d} - ${h})) - 1.0)`,c=`mix(${E}, ${g}, clamp(${L}, 0.0, 1.0))`}return c}};_.match={getReturnType:function(n){let e=l.ANY;for(let t=2;t<n.length;t+=2)e=e&I(n[t]);return e=e&I(n[n.length-1]),e},toGlsl:function(n,e,t){nt(e),G(e,4);let r=I(e[0]);for(let f=1;f<e.length-1;f+=2)r=r&I(e[f]);Se(["match",...e],r,l.STRING|l.NUMBER|l.BOOLEAN,"input"),r=(l.STRING|l.NUMBER|l.BOOLEAN)&r;const i=_.match.getReturnType(e)&t;q(["match",...e],i,"output");const o=T(n,e[0],r),s=T(n,e[e.length-1],i);let a=null;for(let f=e.length-3;f>=1;f-=2){const c=T(n,e[f],r),u=T(n,e[f+1],i);a=`(${o} == ${c} ? ${u} : ${a||s})`}return a}};_.case={getReturnType:function(n){let e=l.ANY;for(let t=1;t<n.length;t+=2)e=e&I(n[t]);return e=e&I(n[n.length-1]),e},toGlsl:function(n,e,t){wr(e),G(e,3);const r=_.case.getReturnType(e)&t;q(["case",...e],r,"output");for(let s=0;s<e.length-1;s+=2)Ae(e[s]);const i=T(n,e[e.length-1],r);let o=null;for(let s=e.length-3;s>=0;s-=2){const a=T(n,e[s],l.BOOLEAN),f=T(n,e[s+1],r);o=`(${a} ? ${f} : ${o||i})`}return o}};_.in={getReturnType:function(n){return l.BOOLEAN},toGlsl:function(n,e){U(e,2);const t=e[0];let r=e[1];if(!Array.isArray(r))throw new Error('The "in" operator expects an array literal as its second argument.');if(typeof r[0]=="string"){if(r[0]!=="literal")throw new Error('For the "in" operator, a string array should be wrapped in a "literal" operator to disambiguate from expressions.');if(!Array.isArray(r[1]))throw new Error('The "in" operator was provided a literal value which was not an array as second argument.');r=r[1]}let i=I(t);for(let a=0;a<r.length-1;a+=1)i=i&I(r[a]);Se(["match",...e],i,l.STRING|l.NUMBER|l.BOOLEAN,"input"),i=(l.STRING|l.NUMBER|l.BOOLEAN)&i;const o=Pr("in",n),s=[];for(let a=0;a<r.length;a+=1)s.push(`  if (inputValue == ${T(n,r[a],i)}) { return true; }`);return n.functions[o]=`bool ${o}(float inputValue) {
${s.join(`
`)}
  return false;
}`,`${o}(${T(n,t,i)})`}};function Xe(n,e){const t=`
    attribute vec2 ${te.TEXTURE_COORD};
    uniform mat4 ${R.TILE_TRANSFORM};
    uniform float ${R.TEXTURE_PIXEL_WIDTH};
    uniform float ${R.TEXTURE_PIXEL_HEIGHT};
    uniform float ${R.TEXTURE_RESOLUTION};
    uniform float ${R.TEXTURE_ORIGIN_X};
    uniform float ${R.TEXTURE_ORIGIN_Y};
    uniform float ${R.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${te.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${R.TEXTURE_ORIGIN_X} + ${R.TEXTURE_RESOLUTION} * ${R.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${R.TEXTURE_ORIGIN_Y} - ${R.TEXTURE_RESOLUTION} * ${R.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${R.TILE_TRANSFORM} * vec4(${te.TEXTURE_COORD}, ${R.DEPTH}, 1.0);
    }
  `,r={inFragmentShader:!0,variables:[],attributes:[],functions:{},bandCount:e,style:n},i=[];if(n.color!==void 0){const h=T(r,n.color,l.COLOR);i.push(`color = ${h};`)}if(n.contrast!==void 0){const h=T(r,n.contrast,l.NUMBER);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.exposure!==void 0){const h=T(r,n.exposure,l.NUMBER);i.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.saturation!==void 0){const h=T(r,n.saturation,l.NUMBER);i.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(n.gamma!==void 0){const h=T(r,n.gamma,l.NUMBER);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(n.brightness!==void 0){const h=T(r,n.brightness,l.NUMBER);i.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const o={},s=r.variables.length;if(s>1&&!n.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<s;++h){const E=r.variables[h];if(!(E.name in n.variables))throw new Error(`Missing '${E.name}' in style variables`);const d=ot(E.name);o[d]=function(){let g=n.variables[E.name];return typeof g=="string"&&(g=et(g)),g!==void 0?g:-9999999}}const a=Object.keys(o).map(function(h){return`uniform float ${h};`}),f=Math.ceil(e/4);a.push(`uniform sampler2D ${R.TILE_TEXTURE_ARRAY}[${f}];`),r.paletteTextures&&a.push(`uniform sampler2D ${st}[${r.paletteTextures.length}];`);const c=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${R.RENDER_EXTENT};
    uniform float ${R.TRANSITION_ALPHA};
    uniform float ${R.TEXTURE_PIXEL_WIDTH};
    uniform float ${R.TEXTURE_PIXEL_HEIGHT};
    uniform float ${R.RESOLUTION};
    uniform float ${R.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${R.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${R.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${R.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${R.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${R.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${R.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:o,paletteTextures:r.paletteTextures}}class ct extends zt{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style;const r=e.cacheSize;delete e.cacheSize,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.cacheSize_=r,this.styleVariables_=this.style_.variables||{},this.addChangeListener(ze.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache(),this.getSource()&&this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Xe(this.style_,this.getSourceBandCount_());return new Nr(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.cacheSize_,paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let i;for(let o=0,s=t.length;o<s;++o)this.renderedSource_=t[o],r.prepareFrame(e)&&(i=r.renderFrame(e));return i}render(e,t){this.rendered=!0;const r=e.viewState,i=this.getSources(e.extent,r.resolution);let o=!0;for(let a=0,f=i.length;a<f;++a){const c=i[a],u=c.getState();if(u=="loading"){const h=()=>{c.getState()=="ready"&&(c.removeEventListener("change",h),this.changed())};c.addEventListener("change",h)}o=o&&u=="ready"}const s=this.renderSources(e,i);if(this.getRenderer().renderComplete&&o)return this.renderedResolution_=r.resolution,s;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(f=>!i.includes(f));if(a.length>0)return this.renderSources(e,a)}return s}setStyle(e){this.styleVariables_=e.variables||{},this.style_=e;const t=Xe(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms}),this.changed()}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}ct.prototype.dispose;const Xr=ct;export{Mr as D,Xr as T};
