import{aI as ee,Z as y,aO as P,a3 as D,w as $,aP as N,a9 as te,i as j,h as re,_ as ie,aQ as oe,aR as ne,a8 as se,O as q,a7 as le,aS as ae,aT as U,aU as V,aV as ce,aW as de,as as ue,Q as he,ar as ge,G as H,aX as Te,aC as fe}from"./Layer-3b715193.js";import{C as pe,E as xe,H as K,c as Ce,h as Re,D as X}from"./hitdetect-486e5612.js";import{C as ye}from"./TileLayer-7c629c64.js";import{Z as Ee}from"./Layer-37ea9c2e.js";import{r as B,g as me}from"./vector-4e067f94.js";import{b as z,n as Q,e as Se,c as Ge,f as ve,o as _e,p as Ie,T as Le,i as De}from"./TileProperty-e33ea24b.js";import{U as we}from"./UrlTile-dc2c26ed.js";import{l as Fe}from"./featureloader-a90a5108.js";const Oe={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},W={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class be extends ye{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.renderedOpacity_=1,this.tmpTransform_=ee(),this.tileClipContexts_=null}prepareTile(e,t,r){let i;const s=e.getState();return(s===y.LOADED||s===y.ERROR)&&(this.updateExecutorGroup_(e,t,r),this.tileImageNeedsRender_(e)&&(i=!0)),i}getTile(e,t,r,i){const s=i.pixelRatio,n=i.viewState,c=n.resolution,o=n.projection,a=this.getLayer(),l=a.getSource().getTile(e,t,r,s,o),f=i.viewHints,d=!(f[P.ANIMATING]||f[P.INTERACTING]);return(d||!l.wantedResolution)&&(l.wantedResolution=c),this.prepareTile(l,s,o)&&(d||Date.now()-i.time<8)&&a.getRenderMode()!=="vector"&&this.renderTileImage_(l,i),super.getTile(e,t,r,i)}isDrawableTile(e){const t=this.getLayer();return super.isDrawableTile(e)&&(t.getRenderMode()==="vector"?D(t)in e.executorGroups:e.hasContext(t))}getTileImage(e){return e.getImage(this.getLayer())}prepareFrame(e){const t=this.getLayer().getRevision();return this.renderedLayerRevision_!==t&&(this.renderedLayerRevision_=t,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,t,r){var p;const i=this.getLayer(),s=i.getRevision(),n=i.getRenderOrder()||null,c=e.wantedResolution,o=e.getReplayState(i);if(!o.dirty&&o.renderedResolution===c&&o.renderedRevision==s&&o.renderedRenderOrder==n)return;const a=i.getSource(),l=!!i.getDeclutter(),f=a.getTileGrid(),u=a.getTileGridForProjection(r).getTileCoordExtent(e.wrappedTileCoord),h=a.getSourceTiles(t,r,e),T=D(i);delete e.hitDetectionImageData[T],e.executorGroups[T]=[],o.dirty=!1;for(let C=0,x=h.length;C<x;++C){const g=h[C];if(g.getState()!=y.LOADED)continue;const R=g.tileCoord,S=f.getTileCoordExtent(R),G=$(u,S),_=N(G,i.getRenderBuffer()*c,this.tmpExtent),F=te(S,G)?null:_,I=new pe(0,G,c,t),E=me(c,t),m=function(O,Z){let A;const k=O.getStyleFunction()||i.getStyleFunction();if(k&&(A=k(O,c)),A){const J=this.renderFeature(O,E,A,I,l,Z);o.dirty=o.dirty||J}},b=g.getFeatures();n&&n!==o.renderedRenderOrder&&b.sort(n);for(let O=0,Z=b.length;O<Z;++O){const A=b[O];(!F||j(F,A.getGeometry().getExtent()))&&m.call(this,A,O)}const L=I.finish(),M=i.getRenderMode()!=="vector"&&l&&h.length===1?null:G,v=new xe(M,c,t,a.getOverlaps(),L,i.getRenderBuffer(),!!((p=this.frameState)!=null&&p.declutter));e.executorGroups[T].push(v)}o.renderedRevision=s,o.renderedRenderOrder=n,o.renderedResolution=c}forEachFeatureAtCoordinate(e,t,r,i,s){const n=t.viewState.resolution,c=t.viewState.rotation;r=r??0;const o=this.getLayer(),l=o.getSource().getTileGridForProjection(t.viewState.projection),f=re([e]);N(f,n*r,f);const d={},u=function(p,C,x){let g=p.getId();g===void 0&&(g=D(p));const R=d[g];if(R){if(R!==!0&&x<R.distanceSq){if(x===0)return d[g]=!0,s.splice(s.lastIndexOf(R),1),i(p,o,C);R.geometry=C,R.distanceSq=x}}else{if(x===0)return d[g]=!0,i(p,o,C);s.push(d[g]={feature:p,layer:o,geometry:C,distanceSq:x,callback:i})}},h=this.renderedTiles;let T;for(let p=0,C=h.length;!T&&p<C;++p){const x=h[p],g=l.getTileCoordExtent(x.wrappedTileCoord);if(!j(g,f))continue;const R=D(o),S=[x.executorGroups[R]],G=o.getDeclutter();S.some(_=>{const F=G?t.declutter[G].all().map(I=>I.value):null;for(let I=0,E=_.length;I<E;++I)if(T=_[I].forEachFeatureAtCoordinate(e,n,c,r,u,F),T)return!0})}return T}getFeatures(e){return new Promise((t,r)=>{const i=this.getLayer(),s=D(i),n=i.getSource(),c=this.renderedProjection,o=c.getExtent(),a=this.renderedResolution,l=n.getTileGridForProjection(c),f=ie(this.renderedPixelToCoordinateTransform_,e.slice()),d=l.getTileCoordForCoordAndResolution(f,a);let u;for(let g=0,R=this.renderedTiles.length;g<R;++g)if(d.toString()===this.renderedTiles[g].tileCoord.toString()){if(u=this.renderedTiles[g],u.getState()===y.LOADED){const S=l.getTileCoordExtent(u.tileCoord);n.getWrapX()&&c.canWrapX()&&!oe(o,S)&&ne(f,c);break}u=void 0}if(!u||u.loadingSourceTiles>0){t([]);return}const h=l.getTileCoordExtent(u.wrappedTileCoord),T=se(h),p=[(f[0]-T[0])/a,(T[1]-f[1])/a],C=u.getSourceTiles().reduce(function(g,R){return g.concat(R.getFeatures())},[]);let x=u.hitDetectionImageData[s];if(!x){const g=q(l.getTileSize(l.getZForResolution(a,n.zDirection))),R=this.renderedRotation_,S=[this.getRenderTransform(l.getTileCoordCenter(u.wrappedTileCoord),a,0,K,g[0]*K,g[1]*K,0)];x=Ce(g,S,C,i.getStyleFunction(),l.getTileCoordExtent(u.wrappedTileCoord),u.getReplayState(i).renderedResolution,R),u.hitDetectionImageData[s]=x}t(Re(p,C,x))})}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e,t){const r=this.context,i=r.globalAlpha;r.globalAlpha=t.opacity;const s=e.viewHints,n=!(s[P.ANIMATING]||s[P.INTERACTING]),c=this.renderedTiles;for(let o=0,a=c.length;o<a;++o){const l=c[o],f=l.executorGroups[D(this.getLayer())],d=this.getLayer().getDeclutter();if(f)for(let u=f.length-1;u>=0;--u)f[u].execute(this.context,[this.context.canvas.width,this.context.canvas.height],this.getTileRenderTransform(l,e),e.viewState.rotation,n,X,d?e.declutter[d]:void 0)}r.globalAlpha=i}renderDeferredInternal(e){const r=this.renderedTiles.reduce((n,c,o)=>(c.executorGroups[D(this.getLayer())].forEach(a=>n.push({executorGroup:a,index:o})),n),[]),i=r.map(({executorGroup:n})=>n.getDeferredZIndexContexts());i.map(n=>Object.keys(n)).flat().sort(le).map(Number).forEach(n=>{i.forEach((c,o)=>{c[n]&&c[n].forEach(a=>{const{executorGroup:l,index:f}=r[o],d=l.getRenderedContext(),u=d.globalAlpha;d.globalAlpha=this.renderedOpacity_;const h=this.tileClipContexts_[f];h&&h.draw(d),a.draw(d),h&&d.restore(),d.globalAlpha=u,a.clear()})})})}getTileRenderTransform(e,t){const r=t.pixelRatio,i=t.viewState,s=i.center,n=i.resolution,c=i.rotation,o=t.size,a=Math.round(o[0]*r),l=Math.round(o[1]*r),d=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),u=e.tileCoord,h=d.getTileCoordExtent(e.wrappedTileCoord),T=d.getTileCoordExtent(u,this.tmpExtent)[0]-h[0];return ae(U(this.inversePixelTransform.slice(),1/r,1/r),this.getRenderTransform(s,n,c,r,a,l,T))}postRender(e,t){const r=t.viewHints,i=!(r[P.ANIMATING]||r[P.INTERACTING]);this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation,this.renderedOpacity_=t.layerStatesArray[t.layerIndex].opacity;const s=this.getLayer(),n=s.getRenderMode(),c=e.globalAlpha;e.globalAlpha=this.renderedOpacity_;const o=s.getDeclutter(),a=o?W[n].filter(R=>!X.includes(R)):W[n],l=t.viewState,f=l.rotation,d=s.getSource(),h=d.getTileGridForProjection(l.projection).getZForResolution(l.resolution,d.zDirection),T=this.renderedTiles,p=[],C=[],x=[];let g=!0;for(let R=T.length-1;R>=0;--R){const S=T[R];g=g&&!S.getReplayState(s).dirty;const G=S.executorGroups[D(s)].filter(L=>L.hasExecutors(a));if(G.length===0)continue;const _=this.getTileRenderTransform(S,t),F=S.tileCoord[0];let I=!1;const E=G[0].getClipCoords(_);let m=e,b;if(E){o&&(b=new Ee,m=b.getContext());for(let L=0,M=p.length;L<M;++L)if(h!==F&&F<C[L]){const v=p[L];j([E[0],E[3],E[4],E[7]],[v[0],v[3],v[4],v[7]])&&(I||(m.save(),I=!0),m.beginPath(),m.moveTo(E[0],E[1]),m.lineTo(E[2],E[3]),m.lineTo(E[4],E[5]),m.lineTo(E[6],E[7]),m.moveTo(v[6],v[7]),m.lineTo(v[4],v[5]),m.lineTo(v[2],v[3]),m.lineTo(v[0],v[1]),m.clip())}p.push(E),C.push(F)}for(let L=0,M=G.length;L<M;++L)G[L].execute(e,[e.canvas.width,e.canvas.height],_,f,i,a);I&&(m===e?m.restore():x[R]=b)}e.globalAlpha=c,this.ready=g,this.tileClipContexts_=x,super.postRender(e,t)}renderFeature(e,t,r,i,s,n){if(!r)return!1;let c=!1;if(Array.isArray(r))for(let o=0,a=r.length;o<a;++o)c=B(i,e,r[o],t,this.boundHandleStyleImageChange_,void 0,s,n)||c;else c=B(i,e,r,t,this.boundHandleStyleImageChange_,void 0,s,n);return c}tileImageNeedsRender_(e){const t=this.getLayer();if(t.getRenderMode()==="vector")return!1;const r=e.getReplayState(t),i=t.getRevision(),s=e.wantedResolution;return r.renderedTileResolution!==s||r.renderedTileRevision!==i}renderTileImage_(e,t){const r=this.getLayer(),i=e.getReplayState(r),s=r.getRevision(),n=e.executorGroups[D(r)];i.renderedTileRevision=s;const c=e.wrappedTileCoord,o=c[0],a=r.getSource();let l=t.pixelRatio;const d=t.viewState.projection,u=a.getTileGridForProjection(d),h=u.getResolution(e.tileCoord[0]),T=t.pixelRatio/e.wantedResolution*h,p=u.getResolution(o),C=e.getContext(r);l=Math.round(Math.max(l,T/l));const x=a.getTilePixelSize(o,l,d);C.canvas.width=x[0],C.canvas.height=x[1];const g=l/T;if(g!==1){const _=V(this.tmpTransform_);U(_,g,g),C.setTransform.apply(C,_)}const R=u.getTileCoordExtent(c,this.tmpExtent),S=T/p,G=V(this.tmpTransform_);U(G,S,-S),ce(G,-R[0],-R[3]);for(let _=0,F=n.length;_<F;++_)n[_].execute(C,[C.canvas.width*g,C.canvas.height*g],G,0,!0,Oe[r.getRenderMode()],null);i.renderedTileResolution=e.wantedResolution}}const Ae=be;class Pe extends de{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un;const r=e.renderMode||"hybrid";ue(r=="hybrid"||r=="vector","`renderMode` must be `'hybrid'` or `'vector'`"),this.renderMode_=r,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new Ae(this)}getFeatures(e){return super.getFeatures(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(z.PRELOAD)}getUseInterimTilesOnError(){return this.get(z.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(z.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(z.USE_INTERIM_TILES_ON_ERROR,e)}}const $e=Pe;let je=class extends Q{constructor(e,t,r,i,s,n){super(e,t,n),this.extent=null,this.format_=i,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=s,this.url_=r,this.key=r}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==y.IDLE&&(this.setState(y.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(e,t){this.setFeatures(e)}onError(){this.setState(y.ERROR)}setFeatures(e){this.features_=e,this.setState(y.LOADED)}setLoader(e){this.loader_=e}};const Me=je,Y=[];class Ne extends Q{constructor(e,t,r,i){super(e,t,{transition:0}),this.context_={},this.executorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=i.bind(void 0,this),this.wrappedTileCoord=r}getContext(e){const t=D(e);return t in this.context_||(this.context_[t]=he(1,1,Y)),this.context_[t]}hasContext(e){return D(e)in this.context_}getImage(e){return this.hasContext(e)?this.getContext(e).canvas:null}getReplayState(e){const t=D(e);return t in this.replayState_||(this.replayState_[t]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[t]}load(){this.getSourceTiles()}release(){for(const e in this.context_){const t=this.context_[e];ge(t),Y.push(t.canvas),delete this.context_[e]}super.release()}}const ze=Ne;class Ze extends we{constructor(e){const t=e.projection||"EPSG:3857",r=e.extent||Se(t),i=e.tileGrid||Ge({extent:r,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,opaque:!1,projection:t,state:e.state,tileGrid:i,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:Ue,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX===void 0?!0:e.wrapX,transition:e.transition,zDirection:e.zDirection===void 0?1:e.zDirection}),this.format_=e.format?e.format:null,this.sourceTileCache=new ve(this.tileCache.highWaterMark),this.overlaps_=e.overlaps==null?!0:e.overlaps,this.tileClass=e.tileClass?e.tileClass:Me,this.tileGrids_={}}getFeaturesInExtent(e){const t=[],r=this.tileCache;if(r.getCount()===0)return t;const i=_e(r.peekFirstKey())[0],s=this.tileGrid;return r.forEach(function(n){if(n.tileCoord[0]!==i||n.getState()!==y.LOADED)return;const c=n.getSourceTiles();for(let o=0,a=c.length;o<a;++o){const l=c[o],f=l.tileCoord;if(j(e,s.getTileCoordExtent(f))){const d=l.getFeatures();if(d)for(let u=0,h=d.length;u<h;++u){const T=d[u],p=T.getGeometry();j(e,p.getExtent())&&t.push(T)}}}}),t}getOverlaps(){return this.overlaps_}clear(){this.tileCache.clear(),this.sourceTileCache.clear()}expireCache(e,t){const r=this.getTileCacheForProjection(e),i=Object.keys(t).reduce((s,n)=>{const c=Ie(n),o=r.peek(c);if(o){const a=o.sourceTiles;for(let l=0,f=a.length;l<f;++l)s[a[l].getKey()]=!0}return s},{});super.expireCache(e,t),this.sourceTileCache.expireCache(i)}getSourceTiles(e,t,r){if(r.getState()===y.IDLE){r.setState(y.LOADING);const i=r.wrappedTileCoord,s=this.getTileGridForProjection(t),n=s.getTileCoordExtent(i),c=i[0],o=s.getResolution(c);N(n,-o,n);const a=this.tileGrid,l=a.getExtent();l&&$(n,l,n);const f=a.getZForResolution(o,this.zDirection);a.forEachTileCoord(n,f,d=>{const u=this.tileUrlFunction(d,e,t),h=this.sourceTileCache.containsKey(u)?this.sourceTileCache.get(u):new this.tileClass(d,u?y.IDLE:y.EMPTY,u,this.format_,this.tileLoadFunction);r.sourceTiles.push(h);const T=h.getState();if(T<y.LOADED){const p=C=>{this.handleTileChange(C);const x=h.getState();if(x===y.LOADED||x===y.ERROR){const g=h.getKey();g in r.errorTileKeys?h.getState()===y.LOADED&&delete r.errorTileKeys[g]:r.loadingSourceTiles--,x===y.ERROR?r.errorTileKeys[g]=!0:h.removeEventListener(H.CHANGE,p),r.loadingSourceTiles===0&&r.setState(Te(r.errorTileKeys)?y.LOADED:y.ERROR)}};h.addEventListener(H.CHANGE,p),r.loadingSourceTiles++}T===y.IDLE&&(h.extent=a.getTileCoordExtent(d),h.projection=t,h.resolution=a.getResolution(d[0]),this.sourceTileCache.set(u,h),h.load())}),r.loadingSourceTiles||r.setState(r.sourceTiles.some(d=>d.getState()===y.ERROR)?y.ERROR:y.LOADED)}return r.sourceTiles}getTile(e,t,r,i,s){const n=De(e,t,r),c=this.getKey();let o;if(this.tileCache.containsKey(n)&&(o=this.tileCache.get(n),o.key===c))return o;const a=[e,t,r];let l=this.getTileCoordForTileUrlFunction(a,s);const f=this.getTileGrid().getExtent(),d=this.getTileGridForProjection(s);if(l&&f){const T=d.getTileCoordExtent(l);N(T,-d.getResolution(e),T),j(f,T)||(l=null)}let u=!0;if(l!==null){const T=this.tileGrid,p=d.getResolution(e),C=T.getZForResolution(p,1),x=d.getTileCoordExtent(l);N(x,-p,x),T.forEachTileCoord(x,C,g=>{u=u&&!this.tileUrlFunction(g,i,s)})}const h=new ze(a,u?y.EMPTY:y.IDLE,l,this.getSourceTiles.bind(this,i,s));return h.key=c,o?(h.interimTile=o,h.refreshInterimChain(),this.tileCache.replace(n,h)):this.tileCache.set(n,h),h}getTileGridForProjection(e){const t=e.getCode();let r=this.tileGrids_[t];if(!r){const i=this.tileGrid,s=i.getResolutions().slice(),n=s.map(function(a,l){return i.getOrigin(l)}),c=s.map(function(a,l){return i.getTileSize(l)}),o=fe+1;for(let a=s.length;a<o;++a)s.push(s[a-1]/2),n.push(n[a-1]),c.push(c[a-1]);r=new Le({extent:i.getExtent(),origins:n,resolutions:s,tileSizes:c}),this.tileGrids_[t]=r}return r}getTilePixelRatio(e){return e}getTilePixelSize(e,t,r){const i=this.getTileGridForProjection(r),s=q(i.getTileSize(e),this.tmpSize);return[Math.round(s[0]*t),Math.round(s[1]*t)]}updateCacheSize(e,t){super.updateCacheSize(e*2,t),this.sourceTileCache.highWaterMark=this.getTileCacheForProjection(t).highWaterMark}}const Qe=Ze;function Ue(w,e){w.setLoader(function(t,r,i){Fe(e,w.getFormat(),t,r,i,w.onLoad.bind(w),w.onError.bind(w))})}export{$e as V,Qe as a,Me as b,Ue as d};
