import{cI as N,w as U,s as D,cm as z,c2 as m,e as y,a0 as x,K as Q,G as O,L as K,aD as k,aw as $,aa as T,a9 as L,aQ as j,ay as R,cJ as J,aF as W,X,cK as V,aI as q,a3 as Y,Q as S,ck as Z}from"./Layer-3b715193.js";import{f as A,C as ee,I as te}from"./ImageLayer-d46d3fc0.js";import{u as se,r as ne,t as ie,E as ae,k as re}from"./TileProperty-e33ea24b.js";import{D as E}from"./common-c2bf7a3a.js";import{T as oe}from"./Tile-70490af9.js";class ue extends N{constructor(e,s,t,n,i,a,o){let u=e.getExtent();u&&e.canWrapX()&&(u=u.slice(),u[0]=-1/0,u[2]=1/0);let h=s.getExtent();h&&s.canWrapX()&&(h=h.slice(),h[0]=-1/0,h[2]=1/0);const d=h?U(t,h):t,g=D(d),p=se(e,s,g,n),_=ae,c=new ne(e,s,d,u,p*_,n),f=c.calculateSourceExtent(),l=z(f)?null:a(f,p,i),w=l?m.IDLE:m.EMPTY,C=l?l.getPixelRatio():1;super(t,n,C,w),this.targetProj_=s,this.maxSourceExtent_=u,this.triangulation_=c,this.targetResolution_=n,this.targetExtent_=t,this.sourceImage_=l,this.sourcePixelRatio_=C,this.interpolate_=o,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==m.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==m.LOADED){const s=y(this.targetExtent_)/this.targetResolution_,t=x(this.targetExtent_)/this.targetResolution_;this.canvas_=ie(s,t,this.sourcePixelRatio_,A(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==m.IDLE){this.state=m.LOADING,this.changed();const e=this.sourceImage_.getState();e==m.LOADED||e==m.ERROR?this.reproject_():(this.sourceListenerKey_=Q(this.sourceImage_,O.CHANGE,function(s){const t=this.sourceImage_.getState();(t==m.LOADED||t==m.ERROR)&&(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load())}}unlistenSource_(){K(this.sourceListenerKey_),this.sourceListenerKey_=null}}const he=ue,b={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class ce extends W{constructor(e,s){super(e),this.image=s}}class le extends k{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const s=this.getResolutions();if(s){const t=$(s,e,0);e=s[t]}return e}getImage(e,s,t,n){const i=this.getProjection();if(!i||!n||T(i,n))return i&&(n=i),this.getImageInternal(e,s,t,n);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&T(this.reprojectedImage_.getProjection(),n)&&this.reprojectedImage_.getResolution()==s&&L(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new he(i,n,e,s,t,(a,o,u)=>this.getImageInternal(a,o,u,i),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,s,t,n){if(this.loader){const i=de(e,s,t,1),a=this.findNearestResolution(s);if(this.image&&(this.static_||this.wantedProjection_===n&&(this.wantedExtent_&&j(this.wantedExtent_,i)||j(this.image.getExtent(),i))&&(this.wantedResolution_&&A(this.wantedResolution_)===a||A(this.image.getResolution())===a)))return this.image;this.wantedProjection_=n,this.wantedExtent_=i,this.wantedResolution_=a,this.image=new N(i,a,t,this.loader),this.image.addEventListener(O.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const s=e.target;let t;switch(s.getState()){case m.LOADING:this.loading=!0,t=b.IMAGELOADSTART;break;case m.LOADED:this.loading=!1,t=b.IMAGELOADEND;break;case m.ERROR:this.loading=!1,t=b.IMAGELOADERROR;break;default:return}this.hasListener(t)&&this.dispatchEvent(new ce(t,s))}}function de(r,e,s,t){const n=e/s,i=D(r),a=R(y(r)/n,E),o=R(x(r)/n,E),u=R((t-1)*a/2,E),h=a+2*u,d=R((t-1)*o/2,E),g=o+2*d;return J(i,n,0,[h,g])}const G=le;class ge extends X{constructor(e){e=e||{},super(e)}}const me=ge;class _e extends me{constructor(e){super(e)}createRenderer(){return new ee(this)}getData(e){return super.getData(e)}}const fe=_e;let P=!0;try{new ImageData(10,10)}catch{P=!1}let v;function pe(r,e,s){if(P)return new ImageData(r,e,s);v||(v=document.createElement("canvas").getContext("2d"));const t=v.createImageData(e,s);return t.data.set(r),t}function H(r){let e=!0;try{new ImageData(10,10)}catch{e=!1}function s(t,n,i){return e?new ImageData(t,n,i):{data:t,width:n,height:i}}return function(t){const n=t.buffers,i=t.meta,a=t.imageOps,o=t.width,u=t.height,h=n.length,d=n[0].byteLength;if(a){const c=new Array(h);for(let l=0;l<h;++l)c[l]=s(new Uint8ClampedArray(n[l]),o,u);return r(c,i).data.buffer}const g=new Uint8ClampedArray(d),p=new Array(h),_=new Array(h);for(let c=0;c<h;++c)p[c]=new Uint8ClampedArray(n[c]),_[c]=[0,0,0,0];for(let c=0;c<d;c+=4){for(let l=0;l<h;++l){const w=p[l];_[l][0]=w[c],_[l][1]=w[c+1],_[l][2]=w[c+2],_[l][3]=w[c+3]}const f=r(_,i);g[c]=f[0],g[c+1]=f[1],g[c+2]=f[2],g[c+3]=f[3]}return g.buffer}}function Ie(r,e){const t=Object.keys(r.lib||{}).map(function(i){return"const "+i+" = "+r.lib[i].toString()+";"}).concat(["const __minion__ = ("+H.toString()+")(",r.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(t.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(t,{type:"text/javascript"})));return n.addEventListener("message",e),n}function we(r,e){const s=H(r.operation);let t=!1;return{postMessage:function(n){setTimeout(function(){t||e({data:{buffer:s(n),meta:n.meta}})},0)},terminate:function(){t=!0}}}class Re extends Z{constructor(e){super(),this._imageOps=!!e.imageOps;let s;e.threads===0?s=0:this._imageOps?s=1:s=e.threads||1;const t=new Array(s);if(s)for(let n=0;n<s;++n)t[n]=Ie(e,this._onWorkerMessage.bind(this,n));else t[0]=we(e,this._onWorkerMessage.bind(this,0));this._workers=t,this._queue=[],this._maxQueueLength=e.queue||1/0,this._running=0,this._dataLookup={},this._job=null}process(e,s,t){this._enqueue({inputs:e,meta:s,callback:t}),this._dispatch()}_enqueue(e){for(this._queue.push(e);this._queue.length>this._maxQueueLength;)this._queue.shift().callback(null,null)}_dispatch(){if(this._running||this._queue.length===0)return;const e=this._queue.shift();this._job=e;const s=e.inputs[0].width,t=e.inputs[0].height,n=e.inputs.map(function(u){return u.data.buffer}),i=this._workers.length;if(this._running=i,i===1){this._workers[0].postMessage({buffers:n,meta:e.meta,imageOps:this._imageOps,width:s,height:t},n);return}const a=e.inputs[0].data.length,o=4*Math.ceil(a/4/i);for(let u=0;u<i;++u){const h=u*o,d=[];for(let g=0,p=n.length;g<p;++g)d.push(n[g].slice(h,h+o));this._workers[u].postMessage({buffers:d,meta:e.meta,imageOps:this._imageOps,width:s,height:t},d)}}_onWorkerMessage(e,s){this.disposed||(this._dataLookup[e]=s.data,--this._running,this._running===0&&this._resolveJob())}_resolveJob(){const e=this._job,s=this._workers.length;let t,n;if(s===1)t=new Uint8ClampedArray(this._dataLookup[0].buffer),n=this._dataLookup[0].meta;else{const i=e.inputs[0].data.length;t=new Uint8ClampedArray(i),n=new Array(s);const a=4*Math.ceil(i/4/s);for(let o=0;o<s;++o){const u=this._dataLookup[o].buffer,h=o*a;t.set(new Uint8ClampedArray(u),h),n[o]=this._dataLookup[o].meta}}this._job=null,this._dataLookup={},e.callback(null,pe(t,e.inputs[0].width,e.inputs[0].height),n),this._dispatch()}disposeInternal(){for(let e=0;e<this._workers.length;++e)this._workers[e].terminate();this._workers.length=0}}const M={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class F extends W{constructor(e,s,t){super(e),this.extent=s.extent,this.resolution=s.viewState.resolution/s.pixelRatio,this.data=t}}class B extends G{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=xe(e.sources);const s=this.changed.bind(this);for(let t=0,n=this.layers_.length;t<n;++t)this.layers_[t].addEventListener(O.CHANGE,s);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new V(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:q(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:ye(this.layers_),pixelRatio:1,pixelToCoordinateTransform:q(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:Y(this),renderTargets:{}},this.setAttributions(function(t){const n=[];for(let i=0,a=e.sources.length;i<a;++i){const o=e.sources[i],u=o instanceof k?o:o.getSource();if(!u)continue;const h=u.getAttributions();if(typeof h=="function"){const d=h(t);n.push.apply(n,d)}}return n.length!==0?n:null}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,s){this.processor_&&this.processor_.dispose(),this.processor_=new Re({operation:e,imageOps:this.operationType_==="image",queue:1,lib:s,threads:this.threads_}),this.changed()}updateFrameState_(e,s,t){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const i=D(e);n.size[0]=Math.ceil(y(e)/s),n.size[1]=Math.ceil(x(e)/s),n.extent=[i[0]-n.size[0]*s/2,i[1]-n.size[1]*s/2,i[0]+n.size[0]*s/2,i[1]+n.size[1]*s/2],n.time=Date.now();const a=n.viewState;return a.center=i,a.projection=t,a.resolution=s,n}allSourcesReady_(){let e=!0,s;for(let t=0,n=this.layers_.length;t<n;++t)if(s=this.layers_[t].getSource(),!s||s.getState()!=="ready"){e=!1;break}return e}getImage(e,s,t,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),s=this.findNearestResolution(s);const i=this.updateFrameState_(e,s,n);if(this.requestedFrameState_=i,this.renderedImageCanvas_){const a=this.renderedImageCanvas_.getResolution(),o=this.renderedImageCanvas_.getExtent();(s!==a||!L(i.extent,o))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),i.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,s=this.layers_.length,t=new Array(s);for(let i=0;i<s;++i){e.layerIndex=i,e.renderTargets={};const a=Ee(this.layers_[i],e);if(a)t[i]=a;else return}const n={};this.dispatchEvent(new F(M.BEFOREOPERATIONS,e,n)),this.processor_.process(t,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,s,t,n){if(s||!t)return;const i=e.extent,a=e.viewState.resolution;if(a!==this.requestedFrameState_.viewState.resolution||!L(i,this.requestedFrameState_.extent))return;let o;if(this.renderedImageCanvas_)o=this.renderedImageCanvas_.getImage().getContext("2d");else{const u=Math.round(y(i)/a),h=Math.round(x(i)/a);o=S(u,h),this.renderedImageCanvas_=new te(i,a,1,o.canvas)}o.putImageData(t,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new F(M.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let s=super.getResolutions();if(!s)for(let t=0,n=this.layers_.length;t<n&&(s=this.layers_[t].getSource().getResolutions(e),!s);++t);return s}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}B.prototype.dispose;let I=null;function Ee(r,e){const s=r.getRenderer();if(!s)throw new Error("Unsupported layer type: "+r);if(!s.prepareFrame(e))return null;const t=e.size[0],n=e.size[1];if(t===0||n===0)return null;const i=s.renderFrame(e,null);let a;if(i instanceof HTMLCanvasElement)a=i;else{if(i&&(a=i.firstElementChild),!(a instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+a);if(a.width===t&&a.height===n)return a.getContext("2d").getImageData(0,0,t,n)}if(!I)I=S(t,n,void 0,{willReadFrequently:!0});else{const o=I.canvas;o.width!==t||o.height!==n?I=S(t,n,void 0,{willReadFrequently:!0}):I.clearRect(0,0,t,n)}return I.drawImage(a,0,0,t,n),I.getImageData(0,0,t,n)}function ye(r){return r.map(function(e){return e.getLayerState()})}function xe(r){const e=r.length,s=new Array(e);for(let t=0;t<e;++t)s[t]=be(r[t]);return s}function be(r){let e;return r instanceof k?r instanceof re?e=new oe({source:r}):r instanceof G&&(e=new fe({source:r})):e=r,e}const Oe=B;export{fe as I,Oe as R};
