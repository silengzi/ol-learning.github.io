import{cl as P,X as se,z,cg as ne,ac as m,t as y,ap as E,a3 as le,E as B,a4 as ue,aX as U,aQ as ge,ay as K,ax as N,c as W,aS as T,cm as de,B as ie,al as me,aq as Y,b7 as J,an as fe,ao as _e,as as V,au as pe,at as Ie,j as Re,cn as we,a_ as Z,m as xe,a8 as G,ce as ye}from"./Layer-bb290663.js";import{C as Ee}from"./Layer-1eda306a.js";import{u as ve,t as be,r as Ae,E as Le,k as Se}from"./TileProperty-b28dfc34.js";import{D as C}from"./common-c2bf7a3a.js";import{T as De}from"./Tile-ca35e04d.js";function H(o){return Array.isArray(o)?Math.min(...o):o}class Te extends P{constructor(e,s,t,n,i,a,r){let h=e.getExtent();h&&e.canWrapX()&&(h=h.slice(),h[0]=-1/0,h[2]=1/0);let c=s.getExtent();c&&s.canWrapX()&&(c=c.slice(),c[0]=-1/0,c[2]=1/0);const l=c?se(t,c):t,g=z(l),p=ve(e,s,g,n),_=Le,u=new be(e,s,l,h,p*_,n),I=u.calculateSourceExtent(),d=ne(I)?null:a(I,p,i),R=d?m.IDLE:m.EMPTY,S=d?d.getPixelRatio():1;super(t,n,S,R),this.targetProj_=s,this.maxSourceExtent_=h,this.triangulation_=u,this.targetResolution_=n,this.targetExtent_=t,this.sourceImage_=d,this.sourcePixelRatio_=S,this.interpolate_=r,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==m.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==m.LOADED){const s=y(this.targetExtent_)/this.targetResolution_,t=E(this.targetExtent_)/this.targetResolution_;this.canvas_=Ae(s,t,this.sourcePixelRatio_,H(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_)}this.state=e,this.changed()}load(){if(this.state==m.IDLE){this.state=m.LOADING,this.changed();const e=this.sourceImage_.getState();e==m.LOADED||e==m.ERROR?this.reproject_():(this.sourceListenerKey_=le(this.sourceImage_,B.CHANGE,function(s){const t=this.sourceImage_.getState();(t==m.LOADED||t==m.ERROR)&&(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load())}}unlistenSource_(){ue(this.sourceListenerKey_),this.sourceListenerKey_=null}}const Ce=Te,q={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class Oe extends ie{constructor(e,s){super(e),this.image=s}}class ke extends U{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const s=this.getResolutions();if(s){const t=ge(s,e,0);e=s[t]}return e}getImage(e,s,t,n){const i=this.getProjection();if(!i||!n||K(i,n))return i&&(n=i),this.getImageInternal(e,s,t,n);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&K(this.reprojectedImage_.getProjection(),n)&&this.reprojectedImage_.getResolution()==s&&N(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new Ce(i,n,e,s,t,(a,r,h)=>this.getImageInternal(a,r,h,i),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,s,t,n){if(this.loader){const i=je(e,s,t,1),a=this.findNearestResolution(s);if(this.image&&(this.static_||(this.wantedExtent_&&W(this.wantedExtent_,i)||W(this.image.getExtent(),i))&&(this.wantedResolution_&&H(this.wantedResolution_)===a||H(this.image.getResolution())===a)))return this.image;this.wantedExtent_=i,this.wantedResolution_=a,this.image=new P(i,a,t,this.loader),this.image.addEventListener(B.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const s=e.target;let t;switch(s.getState()){case m.LOADING:this.loading=!0,t=q.IMAGELOADSTART;break;case m.LOADED:this.loading=!1,t=q.IMAGELOADEND;break;case m.ERROR:this.loading=!1,t=q.IMAGELOADERROR;break;default:return}this.hasListener(t)&&this.dispatchEvent(new Oe(t,s))}}function je(o,e,s,t){const n=e/s,i=z(o),a=T(y(o)/n,C),r=T(E(o)/n,C),h=T((t-1)*a/2,C),c=a+2*h,l=T((t-1)*r/2,C),g=r+2*l;return de(i,n,0,[c,g])}const ae=ke;class Me extends P{constructor(e,s,t,n,i){const a=i!==void 0?m.IDLE:m.LOADED;super(e,s,t,a),this.loader_=i!==void 0?i:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=m.ERROR):this.state=m.LOADED,this.changed()}load(){this.state==m.IDLE&&(this.state=m.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}const qe=Me;class Fe extends me{constructor(e){e=e||{},super(e)}}const Ne=Fe;class We extends Ee{constructor(e){super(e),this.image_=null}getImage(){return this.image_?this.image_.getImage():null}prepareFrame(e){const s=e.layerStatesArray[e.layerIndex],t=e.pixelRatio,n=e.viewState,i=n.resolution,a=this.getLayer().getSource(),r=e.viewHints;let h=e.extent;if(s.extent!==void 0&&(h=se(h,Y(s.extent,n.projection))),!r[J.ANIMATING]&&!r[J.INTERACTING]&&!ne(h))if(a){const c=n.projection,l=a.getImage(h,i,t,c);l&&(this.loadImage(l)?this.image_=l:l.getState()===m.EMPTY&&(this.image_=null))}else this.image_=null;return!!this.image_}getData(e){const s=this.frameState;if(!s)return null;const t=this.getLayer(),n=fe(s.pixelToCoordinateTransform,e.slice()),i=t.getExtent();if(i&&!_e(i,n))return null;const a=this.image_.getExtent(),r=this.image_.getImage(),h=y(a),c=Math.floor(r.width*((n[0]-a[0])/h));if(c<0||c>=r.width)return null;const l=E(a),g=Math.floor(r.height*((a[3]-n[1])/l));return g<0||g>=r.height?null:this.getImageData(r,c,g)}renderFrame(e,s){const t=this.image_,n=t.getExtent(),i=t.getResolution(),[a,r]=Array.isArray(i)?i:[i,i],h=t.getPixelRatio(),c=e.layerStatesArray[e.layerIndex],l=e.pixelRatio,g=e.viewState,p=g.center,_=g.resolution,u=l*a/(_*h),I=l*r/(_*h),d=e.extent,R=g.resolution,S=g.rotation,v=Math.round(y(d)/R*l),b=Math.round(E(d)/R*l);V(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/l,1/l,S,-v/2,-b/2),pe(this.inversePixelTransform,this.pixelTransform);const O=Ie(this.pixelTransform);this.useContainer(s,O,this.getBackground(e));const f=this.context,x=f.canvas;x.width!=v||x.height!=b?(x.width=v,x.height=b):this.containerReused||f.clearRect(0,0,v,b);let k=!1,j=!0;if(c.extent){const L=Y(c.extent,g.projection);j=Re(L,e.extent),k=j&&!W(L,e.extent),k&&this.clipUnrotated(f,e,L)}const A=t.getImage(),D=V(this.tempTransform,v/2,b/2,u,I,0,h*(n[0]-p[0])/a,h*(p[1]-n[3])/r);this.renderedResolution=r*l/h;const Q=A.width*D[0],X=A.height*D[3];if(this.getLayer().getSource().getInterpolate()||(f.imageSmoothingEnabled=!1),this.preRender(f,e),j&&Q>=.5&&X>=.5){const L=D[4],ce=D[5],M=c.opacity;let $;M!==1&&($=f.globalAlpha,f.globalAlpha=M),f.drawImage(A,0,0,+A.width,+A.height,L,ce,Q,X),M!==1&&(f.globalAlpha=$)}return this.postRender(f,e),k&&f.restore(),f.imageSmoothingEnabled=!0,O!==x.style.transform&&(x.style.transform=O),this.container}}const Ge=We;class He extends Ne{constructor(e){super(e)}createRenderer(){return new Ge(this)}getData(e){return super.getData(e)}}const Pe=He;let re=!0;try{new ImageData(10,10)}catch{re=!1}let F;function ze(o,e,s){if(re)return new ImageData(o,e,s);F||(F=document.createElement("canvas").getContext("2d"));const t=F.createImageData(e,s);return t.data.set(o),t}function oe(o){let e=!0;try{new ImageData(10,10)}catch{e=!1}function s(t,n,i){return e?new ImageData(t,n,i):{data:t,width:n,height:i}}return function(t){const n=t.buffers,i=t.meta,a=t.imageOps,r=t.width,h=t.height,c=n.length,l=n[0].byteLength;if(a){const u=new Array(c);for(let d=0;d<c;++d)u[d]=s(new Uint8ClampedArray(n[d]),r,h);return o(u,i).data.buffer}const g=new Uint8ClampedArray(l),p=new Array(c),_=new Array(c);for(let u=0;u<c;++u)p[u]=new Uint8ClampedArray(n[u]),_[u]=[0,0,0,0];for(let u=0;u<l;u+=4){for(let d=0;d<c;++d){const R=p[d];_[d][0]=R[u],_[d][1]=R[u+1],_[d][2]=R[u+2],_[d][3]=R[u+3]}const I=o(_,i);g[u]=I[0],g[u+1]=I[1],g[u+2]=I[2],g[u+3]=I[3]}return g.buffer}}function Be(o,e){const t=Object.keys(o.lib||{}).map(function(i){return"const "+i+" = "+o.lib[i].toString()+";"}).concat(["const __minion__ = ("+oe.toString()+")(",o.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(t.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(t,{type:"text/javascript"})));return n.addEventListener("message",e),n}function Ue(o,e){const s=oe(o.operation);let t=!1;return{postMessage:function(n){setTimeout(function(){t||e({data:{buffer:s(n),meta:n.meta}})},0)},terminate:function(){t=!0}}}class Qe extends ye{constructor(e){super(),this._imageOps=!!e.imageOps;let s;e.threads===0?s=0:this._imageOps?s=1:s=e.threads||1;const t=new Array(s);if(s)for(let n=0;n<s;++n)t[n]=Be(e,this._onWorkerMessage.bind(this,n));else t[0]=Ue(e,this._onWorkerMessage.bind(this,0));this._workers=t,this._queue=[],this._maxQueueLength=e.queue||1/0,this._running=0,this._dataLookup={},this._job=null}process(e,s,t){this._enqueue({inputs:e,meta:s,callback:t}),this._dispatch()}_enqueue(e){for(this._queue.push(e);this._queue.length>this._maxQueueLength;)this._queue.shift().callback(null,null)}_dispatch(){if(this._running||this._queue.length===0)return;const e=this._queue.shift();this._job=e;const s=e.inputs[0].width,t=e.inputs[0].height,n=e.inputs.map(function(h){return h.data.buffer}),i=this._workers.length;if(this._running=i,i===1){this._workers[0].postMessage({buffers:n,meta:e.meta,imageOps:this._imageOps,width:s,height:t},n);return}const a=e.inputs[0].data.length,r=4*Math.ceil(a/4/i);for(let h=0;h<i;++h){const c=h*r,l=[];for(let g=0,p=n.length;g<p;++g)l.push(n[g].slice(c,c+r));this._workers[h].postMessage({buffers:l,meta:e.meta,imageOps:this._imageOps,width:s,height:t},l)}}_onWorkerMessage(e,s){this.disposed||(this._dataLookup[e]=s.data,--this._running,this._running===0&&this._resolveJob())}_resolveJob(){const e=this._job,s=this._workers.length;let t,n;if(s===1)t=new Uint8ClampedArray(this._dataLookup[0].buffer),n=this._dataLookup[0].meta;else{const i=e.inputs[0].data.length;t=new Uint8ClampedArray(i),n=new Array(s);const a=4*Math.ceil(i/4/s);for(let r=0;r<s;++r){const h=this._dataLookup[r].buffer,c=r*a;t.set(new Uint8ClampedArray(h),c),n[r]=this._dataLookup[r].meta}}this._job=null,this._dataLookup={},e.callback(null,ze(t,e.inputs[0].width,e.inputs[0].height),n),this._dispatch()}disposeInternal(){for(let e=0;e<this._workers.length;++e)this._workers[e].terminate();this._workers.length=0}}const ee={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class te extends ie{constructor(e,s,t){super(e),this.extent=s.extent,this.resolution=s.viewState.resolution/s.pixelRatio,this.data=t}}class he extends ae{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=Ke(e.sources);const s=this.changed.bind(this);for(let t=0,n=this.layers_.length;t<n;++t)this.layers_[t].addEventListener(B.CHANGE,s);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new we(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Z(),declutterTree:null,extent:null,index:0,layerIndex:0,layerStatesArray:$e(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Z(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:xe(this),renderTargets:{}},this.setAttributions(function(t){const n=[];for(let i=0,a=e.sources.length;i<a;++i){const r=e.sources[i],h=r instanceof U?r:r.getSource();if(!h)continue;const c=h.getAttributions();if(typeof c=="function"){const l=c(t);n.push.apply(n,l)}}return n.length!==0?n:null}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,s){this.processor_&&this.processor_.dispose(),this.processor_=new Qe({operation:e,imageOps:this.operationType_==="image",queue:1,lib:s,threads:this.threads_}),this.changed()}updateFrameState_(e,s,t){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const i=z(e);n.size[0]=Math.ceil(y(e)/s),n.size[1]=Math.ceil(E(e)/s),n.extent=[i[0]-n.size[0]*s/2,i[1]-n.size[1]*s/2,i[0]+n.size[0]*s/2,i[1]+n.size[1]*s/2],n.time=Date.now();const a=n.viewState;return a.center=i,a.projection=t,a.resolution=s,n}allSourcesReady_(){let e=!0,s;for(let t=0,n=this.layers_.length;t<n;++t)if(s=this.layers_[t].getSource(),!s||s.getState()!=="ready"){e=!1;break}return e}getImage(e,s,t,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),s=this.findNearestResolution(s);const i=this.updateFrameState_(e,s,n);if(this.requestedFrameState_=i,this.renderedImageCanvas_){const a=this.renderedImageCanvas_.getResolution(),r=this.renderedImageCanvas_.getExtent();(s!==a||!N(i.extent,r))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),i.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,s=this.layers_.length,t=new Array(s);for(let i=0;i<s;++i){e.layerIndex=i,e.renderTargets={};const a=Xe(this.layers_[i],e);if(a)t[i]=a;else return}const n={};this.dispatchEvent(new te(ee.BEFOREOPERATIONS,e,n)),this.processor_.process(t,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,s,t,n){if(s||!t)return;const i=e.extent,a=e.viewState.resolution;if(a!==this.requestedFrameState_.viewState.resolution||!N(i,this.requestedFrameState_.extent))return;let r;if(this.renderedImageCanvas_)r=this.renderedImageCanvas_.getImage().getContext("2d");else{const h=Math.round(y(i)/a),c=Math.round(E(i)/a);r=G(h,c),this.renderedImageCanvas_=new qe(i,a,1,r.canvas)}r.putImageData(t,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new te(ee.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let s=super.getResolutions();if(!s)for(let t=0,n=this.layers_.length;t<n&&(s=this.layers_[t].getSource().getResolutions(e),!s);++t);return s}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}he.prototype.dispose;let w=null;function Xe(o,e){const s=o.getRenderer();if(!s)throw new Error("Unsupported layer type: "+o);if(!s.prepareFrame(e))return null;const t=e.size[0],n=e.size[1];if(t===0||n===0)return null;const i=s.renderFrame(e,null);let a;if(i instanceof HTMLCanvasElement)a=i;else{if(i&&(a=i.firstElementChild),!(a instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+a);if(a.width===t&&a.height===n)return a.getContext("2d").getImageData(0,0,t,n)}if(!w)w=G(t,n,void 0,{willReadFrequently:!0});else{const r=w.canvas;r.width!==t||r.height!==n?w=G(t,n,void 0,{willReadFrequently:!0}):w.clearRect(0,0,t,n)}return w.drawImage(a,0,0,t,n),w.getImageData(0,0,t,n)}function $e(o){return o.map(function(e){return e.getLayerState()})}function Ke(o){const e=o.length,s=new Array(e);for(let t=0;t<e;++t)s[t]=Ye(o[t]);return s}function Ye(o){let e;return o instanceof U?o instanceof Se?e=new De({source:o}):o instanceof ae&&(e=new Pe({source:o})):e=o,e}const st=he;export{Pe as I,st as R};
