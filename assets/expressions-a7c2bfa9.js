import{n as tt,q as ne,r as rt,s as nt,E as it,t as ot,I as Be,R as he,h as V,d as st,a as ye,L as at}from"./TileProperty-f0a52f17.js";import{T as b,J as fe,u as j,ac as xe,aj as Ae,F as lt,G as Le,E as W,v as Ce,c4 as ct,al as ut,Y as G,c5 as ht,aA as Q,Z as Ge,c6 as ft,az as Tt,c3 as dt,aE as X,aD as ie,a4 as Et,a5 as ve,I as Te,c7 as _t,aS as pt,aR as Ue,c8 as gt,aT as Rt,c9 as mt,W as Me,R as yt,S as be,e as xt,aC as At,ca as Lt,cb as Ct}from"./Layer-3211d6ef.js";function ee(n){return n instanceof Image||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageBitmap?n:null}function ce(n){return n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Float32Array||n instanceof DataView?n:null}let z=null;function Ut(n){z||(z=fe(n.width,n.height,void 0,{willReadFrequently:!0}));const e=z.canvas,t=n.width;e.width!==t&&(e.width=t);const r=n.height;return e.height!==r&&(e.height=r),z.clearRect(0,0,t,r),z.drawImage(n,0,0),z.getImageData(0,0,t,r).data}const bt=[256,256];class Nt extends tt{constructor(e){const t=b.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null}getSize(){if(this.size_)return this.size_;const e=ee(this.data_);return e?[e.width,e.height]:bt}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=b.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=b.ERROR,e.changed()})}}const Fe=Nt;class St extends Fe{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8Array(4)),interpolate:e.interpolate,transition:e.transition}),this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),r=this.targetTileGrid_.getExtent();let i=this.sourceTileGrid_.getExtent();const o=r?j(t,r):t;if(xe(o)===0){this.state=b.EMPTY;return}const s=e.sourceProj,a=s.getExtent();a&&(i?i=j(i,a):i=a);const h=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,c=nt(s,u,o,h);if(!isFinite(c)||c<=0){this.state=b.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:it;if(this.triangulation_=new ot(s,u,o,i,c*f,h),this.triangulation_.getTriangles().length===0){this.state=b.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(c);let E=this.triangulation_.calculateSourceExtent();if(i&&(s.canWrapX()?(E[1]=Ce(E[1],i[1],i[3]),E[3]=Ce(E[3],i[1],i[3])):E=j(E,i)),!xe(E))this.state=b.EMPTY;else{const T=this.sourceTileGrid_.getTileRangeForExtentAndZ(E,this.sourceZ_),y=e.getTileFunction;for(let L=T.minX;L<=T.maxX;L++)for(let x=T.minY;x<=T.maxY;x++){const C=y(this.sourceZ_,L,x,this.pixelRatio_);C&&this.sourceTiles_.push(C)}this.sourceTiles_.length===0&&(this.state=b.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{if(!t||t.getState()!==b.LOADED)return;const r=t.getSize(),i=this.gutter_;let o;const s=ce(t.getData());s?o=s:o=Ut(ee(t.getData()));const a=[r[0]+2*i,r[1]+2*i],h=o instanceof Float32Array,u=a[0]*a[1],c=h?Float32Array:Uint8Array,f=new c(o.buffer),E=c.BYTES_PER_ELEMENT,T=E*f.length/u,y=f.byteLength/a[1],L=Math.floor(y/E/a[0]),x=u*L;let C=f;if(f.length!==x){C=new c(x);let m=0,A=0;const g=a[0]*L;for(let R=0;R<a[1];++R){for(let p=0;p<g;++p)C[m++]=f[A+p];A+=y/E}}e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),data:new Uint8Array(C.buffer),dataType:c,bytesPerPixel:T,pixelSize:a})}),this.sourceTiles_.length=0,e.length===0)this.state=b.ERROR;else{const t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),i=typeof r=="number"?r:r[0],o=typeof r=="number"?r:r[1],s=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);let u,c;const f=e[0].bytesPerPixel,E=Math.ceil(f/3);for(let T=E-1;T>=0;--T){const y=[];for(let g=0,R=e.length;g<R;++g){const p=e[g],U=p.data,S=p.pixelSize,I=S[0],D=S[1],v=fe(I,D,ne),me=v.createImageData(I,D),Y=me.data;let J=T*3;for(let $=0,et=Y.length;$<et;$+=4)Y[$]=U[J],Y[$+1]=U[J+1],Y[$+2]=U[J+2],Y[$+3]=255,J+=f;v.putImageData(me,0,0),y.push({extent:p.extent,image:v.canvas})}const L=rt(i,o,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),s,h,this.triangulation_,y,this.gutter_,!1,!1);for(let g=0,R=y.length;g<R;++g){const U=y[g].image.getContext("2d");Ae(U),ne.push(U.canvas)}const x=L.getContext("2d"),C=x.getImageData(0,0,L.width,L.height);Ae(x),ne.push(L),u||(c=new Uint8Array(f*C.width*C.height),u=new e[0].dataType(c.buffer));const m=C.data;let A=T*3;for(let g=0,R=m.length;g<R;g+=4)m[g+3]===255?(c[A]=m[g],c[A+1]=m[g+1],c[A+2]=m[g+2]):(c[A]=0,c[A+1]=0,c[A+2]=0),A+=f}this.reprojData_=u,this.reprojSize_=[Math.round(i*this.pixelRatio_),Math.round(o*this.pixelRatio_)],this.state=b.LOADED}this.changed()}load(){if(this.state!==b.IDLE&&this.state!==b.ERROR)return;this.state=b.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(t=>{const r=t.getState();if(r!==b.IDLE&&r!==b.LOADING)return;e++;const i=lt(t,W.CHANGE,function(){const o=t.getState();(o==b.LOADED||o==b.ERROR||o==b.EMPTY)&&(Le(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(t){t.getState()==b.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Le),this.sourcesListenerKeys_=null}}const $e=St,de=34962,Ee=34963,Pt=35040,_e=35044,Ot=35048,Dt=5121,wt=5123,It=5125,Xe=5126,Ne=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Bt(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!ct},e);const t=Ne.length;for(let r=0;r<t;++r)try{const i=n.getContext(Ne[r],e);if(i)return i}catch{}return null}const Gt={STATIC_DRAW:_e,STREAM_DRAW:Pt,DYNAMIC_DRAW:Ot};class vt{constructor(e,t){this.array=null,this.type=e,ut(e===de||e===Ee,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage=t!==void 0?t:Gt.STATIC_DRAW}ofSize(e){return this.array=new(oe(this.type))(e),this}fromArray(e){return this.array=oe(this.type).from(e),this}fromArrayBuffer(e){return this.array=new(oe(this.type))(e),this}getType(){return this.type}getArray(){return this.array}getUsage(){return this.usage}getSize(){return this.array?this.array.length:0}}function oe(n){switch(n){case de:return Float32Array;case Ee:return Uint32Array;default:return Float32Array}}const ze=vt,q={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Mt=`
  precision mediump float;
  
  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;
  
  uniform vec2 u_screenSize;
   
  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Ft=`
  precision mediump float;
   
  uniform sampler2D u_image;
  uniform float u_opacity;
   
  varying vec2 v_texCoord;
   
  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class $t{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Mt),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||Ft),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const o=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(s=>{this.uniforms_.push({value:e.uniforms[s],location:t.getUniformLocation(this.renderTargetProgram_,s)})})}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,o=t.RGBA,s=0,a=t.RGBA,h=t.UNSIGNED_BYTE,u=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,o,r[0],r[1],s,a,h,u),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,i){const o=this.getGL(),s=e.size;if(o.bindFramebuffer(o.FRAMEBUFFER,t?t.getFrameBuffer():null),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.renderTargetTexture_),!t){const h=G(o.canvas);if(!e.renderTargets[h]){const u=o.getContextAttributes();u&&u.preserveDrawingBuffer&&(o.clearColor(0,0,0,0),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)),e.renderTargets[h]=!0}}o.disable(o.DEPTH_TEST),o.enable(o.BLEND),o.blendFunc(o.ONE,o.ONE_MINUS_SRC_ALPHA),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.bindBuffer(o.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),o.useProgram(this.renderTargetProgram_),o.enableVertexAttribArray(this.renderTargetAttribLocation_),o.vertexAttribPointer(this.renderTargetAttribLocation_,2,o.FLOAT,!1,0,0),o.uniform2f(this.renderTargetUniformLocation_,s[0],s[1]),o.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;o.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(o,e),o.drawArrays(o.TRIANGLES,0,6),i&&i(o,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(o){if(r=typeof o.value=="function"?o.value(e):o.value,r instanceof HTMLCanvasElement||r instanceof ImageData)o.texture||(o.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,o.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(o.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(o.location,r[0],r[1]);return;case 3:t.uniform3f(o.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(o.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(o.location,r)})}}const Se=$t;function He(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function We(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}const M={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},K={UNSIGNED_BYTE:Dt,UNSIGNED_SHORT:wt,UNSIGNED_INT:It,FLOAT:Xe},te={};function Pe(n){return"shared/"+n}let Oe=0;function Xt(){const n="unique/"+Oe;return Oe+=1,n}function zt(n){let e=te[n];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Bt(t)},te[n]=e}return e.users+=1,e.context}function Ht(n){const e=te[n];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const i=t.canvas;i.width=1,i.height=1,delete te[n]}class Wt extends ht{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Pe(e.canvasCacheKey):Xt(),this.gl_=zt(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(q.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(q.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Q(),this.offsetScaleMatrix_=Q(),this.tmpMat4_=He(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new Se({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new Se({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Pe(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=G(e);let i=this.bufferCache_[r];if(!i){const o=t.createBuffer();i={buffer:e,webGlBuffer:o},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=this.gl_,r=G(e),i=this.bufferCache_[r];i&&!t.isContextLost()&&t.deleteBuffer(i.webGlBuffer),delete this.bufferCache_[r]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(q.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(q.RESTORED,this.boundHandleWebGLContextRestored_),Ht(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const i=this.gl_,o=this.getCanvas(),s=e.size,a=e.pixelRatio;(o.width!==s[0]*a||o.height!==s[1]*a)&&(o.width=s[0]*a,o.height=s[1]*a,o.style.width=s[0]+"px",o.style.height=s[1]+"px");for(let h=this.postProcessPasses_.length-1;h>=0;h--)this.postProcessPasses_[h].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),r?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindTexture(e,t,r){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(r),t)}prepareDrawToRenderTarget(e,t,r,i){const o=this.gl_,s=t.getSize();o.bindFramebuffer(o.FRAMEBUFFER,t.getFramebuffer()),o.bindRenderbuffer(o.RENDERBUFFER,t.getDepthbuffer()),o.viewport(0,0,s[0],s[1]),o.bindTexture(o.TEXTURE_2D,t.getTexture()),o.clearColor(0,0,0,0),o.depthRange(0,1),o.clearDepth(1),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),o.blendFunc(o.ONE,r?o.ZERO:o.ONE_MINUS_SRC_ALPHA),i?(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)):o.disable(o.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,o=4,s=t-e,a=e*o;r.drawElements(r.TRIANGLES,s,i,a)}finalizeDraw(e,t,r){for(let i=0,o=this.postProcessPasses_.length;i<o;i++)i===o-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(M.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(M.ZOOM,e.viewState.zoom),this.setUniformFloatValue(M.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(M.PIXEL_RATIO,i),this.setUniformFloatVec2(M.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(M.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(M.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(M.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,i=0;this.uniforms_.forEach(o=>{if(r=typeof o.value=="function"?o.value(e):o.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData)o.texture||(o.prevValue=void 0,o.texture=t.createTexture()),this.bindTexture(o.texture,i,o.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(!(r instanceof HTMLImageElement)||r.complete)&&o.prevValue!==r&&(o.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),i++;else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(o.name,We(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(o.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(o.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(o.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(o.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,this.applyFrameState(t),this.applyUniforms(t)}compileShader(e,t){const r=this.gl_,i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.gl_,i=this.compileShader(e,r.FRAGMENT_SHADER),o=this.compileShader(t,r.VERTEX_SHADER),s=r.createProgram();if(r.attachShader(s,i),r.attachShader(s,o),r.linkProgram(s),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(o,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(o)}`;throw new Error(a)}if(r.deleteShader(o),!r.getProgramParameter(s,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(s)}`;throw new Error(a)}return s}getUniformLocation(e){const t=G(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=G(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,o=e.viewState.resolution,s=e.viewState.center;return Ge(t,0,0,2/(o*r[0]),2/(o*r[1]),-i,-s[0],-s[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,i,o){const s=this.getAttributeLocation(e);s<0||(this.gl_.enableVertexAttribArray(s),this.gl_.vertexAttribPointer(s,t,r,!1,i,o))}enableAttributes(e){const t=jt(e);let r=0;for(let i=0;i<e.length;i++){const o=e[i];this.enableAttributeArray_(o.name,o.size,o.type||Xe,t,r),r+=o.size*je(o.type)}}handleWebGLContextLost(e){ft(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r){const i=this.gl_;r=r||i.createTexture();const o=0,s=i.RGBA,a=0,h=i.RGBA,u=i.UNSIGNED_BYTE;return i.bindTexture(i.TEXTURE_2D,r),t?i.texImage2D(i.TEXTURE_2D,o,s,h,u,t):i.texImage2D(i.TEXTURE_2D,o,s,e[0],e[1],a,h,u,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r}}function jt(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*je(r.type)}return e}function je(n){switch(n){case K.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case K.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case K.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case K.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class pe extends Tt{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Q(),this.pixelContext_=null,this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,e.addChangeListener(dt.MAP,this.removeHelper.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(X.PRECOMPOSE)){const i=new ie(X.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(X.POSTCOMPOSE)){const i=new ie(X.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let s=0,a=e.layerStatesArray.length;s<a;s++){const h=e.layerStatesArray[s].layer,u=h.getRenderer();if(!(u instanceof pe)){t=!0;continue}const c=h.getClassName();if((t||c!==i)&&(r+=1,t=!1),i=c,u===this)break}const o="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(o)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Wt({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:o}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){Ge(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const o=new ie(e,this.inversePixelTransform_,r,t);i.dispatchEvent(o)}}preRender(e,t){this.dispatchRenderEvent_(X.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(X.POSTRENDER,e,t)}}const Yt=pe;class Vt{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}}const Kt=Vt;class Zt extends Et{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter_=e.gutter||0,this.helper_=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(W.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===b.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Be){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(W.CHANGE,this.handleTileChange_)}}uploadTile(){ve()}setReady(){this.ready=!0,this.dispatchEvent(W.CHANGE)}handleTileChange_(){this.tile.getState()===b.LOADED&&(this.loaded=!0,this.uploadTile())}disposeInternal(){this.tile.removeEventListener(W.CHANGE,this.handleTileChange_)}}const kt=Zt;function Ye(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function Jt(n,e,t,r){Ye(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function De(n,e,t,r,i,o){const s=n.getGL();let a,h;t instanceof Float32Array?(a=s.FLOAT,n.getExtension("OES_texture_float"),h=n.getExtension("OES_texture_float_linear")!==null):(a=s.UNSIGNED_BYTE,h=!0),Ye(s,e,o&&h);const u=t.byteLength/r[1];let c=1;u%8===0?c=8:u%4===0?c=4:u%2===0&&(c=2);let f;switch(i){case 1:{f=s.LUMINANCE;break}case 2:{f=s.LUMINANCE_ALPHA;break}case 3:{f=s.RGB;break}case 4:{f=s.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const E=s.getParameter(s.UNPACK_ALIGNMENT);s.pixelStorei(s.UNPACK_ALIGNMENT,c),s.texImage2D(s.TEXTURE_2D,0,f,r[0],r[1],0,f,a,t),s.pixelStorei(s.UNPACK_ALIGNMENT,E)}let H=null;function qt(){H=fe(1,1,void 0,{willReadFrequently:!0})}class Qt extends kt{constructor(e){super(e),this.textures=[],this.renderSize_=Te(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new ze(de,_e);t.fromArray([0,1,1,1,1,0,0,0]),this.helper_.flushBufferData(t),this.coords=t,this.setTile(e.tile)}uploadTile(){const e=this.helper_,t=e.getGL(),r=this.tile;this.textures.length=0;let i;r instanceof Be||r instanceof he?i=r.getImage():i=r.getData();const o=ee(i);if(o){const m=t.createTexture();this.textures.push(m),this.bandCount=4,Jt(t,m,o,r.interpolate),this.setReady();return}i=ce(i);const s=r.getSize(),a=[s[0]+2*this.gutter_,s[1]+2*this.gutter_],h=i instanceof Float32Array,u=a[0]*a[1],c=h?Float32Array:Uint8Array,f=c.BYTES_PER_ELEMENT,E=i.byteLength/a[1];this.bandCount=Math.floor(E/f/a[0]);const T=Math.ceil(this.bandCount/4);if(T===1){const m=t.createTexture();this.textures.push(m),De(e,m,i,a,this.bandCount,r.interpolate),this.setReady();return}const y=new Array(T);for(let m=0;m<T;++m){const A=t.createTexture();this.textures.push(A);const g=m<T-1?4:(this.bandCount-1)%4+1;y[m]=new c(u*g)}let L=0,x=0;const C=a[0]*this.bandCount;for(let m=0;m<a[1];++m){for(let A=0;A<C;++A){const g=i[x+A],R=Math.floor(L/this.bandCount),p=A%this.bandCount,U=Math.floor(p/4),S=y[U],I=S.length/u,D=p%4;S[R*I+D]=g,++L}x+=E/f}for(let m=0;m<T;++m){const A=this.textures[m],g=y[m],R=g.length/u;De(e,A,g,a,R,r.interpolate)}this.setReady()}disposeInternal(){const e=this.helper_.getGL();this.helper_.deleteBuffer(this.coords);for(let t=0;t<this.textures.length;++t)e.deleteTexture(this.textures[t]);this.tile.removeEventListener(W.CHANGE,this.handleTileChange_)}getImagePixelData_(e,t,r){const i=this.gutter_,o=this.renderSize_[0],s=this.renderSize_[1];H||qt(),H.clearRect(0,0,1,1);const a=e.width,h=e.height,u=a-2*i,c=h-2*i,f=i+Math.floor(u*(t/o)),E=i+Math.floor(c*(r/s));let T;try{H.drawImage(e,f,E,1,1,0,0,1,1),T=H.getImageData(0,0,1,1).data}catch{return H=null,null}return T}getArrayPixelData_(e,t,r,i){const o=this.gutter_,s=this.renderSize_[0],a=this.renderSize_[1],h=t[0],u=t[1],c=h+2*o,f=u+2*o,E=o+Math.floor(h*(r/s)),T=o+Math.floor(u*(i/a));if(e instanceof DataView){const L=e.byteLength/(c*f),x=L*(T*c+E),C=e.buffer.slice(x,x+L);return new DataView(C)}const y=this.bandCount*(T*c+E);return e.slice(y,y+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Fe){const r=this.tile.getData(),i=ce(r);if(i){const o=this.tile.getSize();return this.getArrayPixelData_(i,o,e,t)}return this.getImagePixelData_(ee(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const er=Qt,tr={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"},rr={};function nr(n){return 1/(n+2)}function ir(){return{tileIds:new Set,representationsByZ:{}}}function we(n,e){return n.tileIds.has(G(e))}function Ie(n,e,t){const r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(G(e.tile))}function se(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=j(e,Me(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=j(e,i))}return e}function ue(n,e){return`${n.getKey()},${V(e)}`}class or extends Yt{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Q(),this.tempMat4=He(),this.tempTileRange_=new st(0,0,0,0),this.tempTileCoord_=ye(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new at(r),this.frameState=null,this.projection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}isDrawableTile_(e){const t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return r==b.LOADED||r==b.EMPTY||r==b.ERROR&&!i}prepareFrameInternal(e){this.projection_?e.viewState.projection!==this.projection_&&(this.clearCache(),this.projection_=e.viewState.projection):this.projection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||_t(se(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return ve()}enqueueTiles(e,t,r,i,o){const s=e.viewState,a=this.getLayer(),h=a.getRenderSource(),u=h.getTileGridForProjection(s.projection),c=h.getGutterForProjection(s.projection),f=G(h);f in e.wantedTiles||(e.wantedTiles[f]={});const E=e.wantedTiles[f],T=this.tileRepresentationCache,y=a.getMapInternal(),L=Math.max(r-o,u.getMinZoom(),u.getZForResolution(Math.min(a.getMaxResolution(),y?y.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):u.getResolution(0)),h.zDirection));for(let x=r;x>=L;--x){const C=u.getTileRangeForExtentAndZ(t,x,this.tempTileRange_),m=u.getResolution(x);for(let A=C.minX;A<=C.maxX;++A)for(let g=C.minY;g<=C.maxY;++g){const R=ye(x,A,g,this.tempTileCoord_),p=ue(h,R);let U,S;if(T.containsKey(p)&&(U=T.get(p),S=U.tile),(!U||U.tile.key!==h.getKey())&&(S=h.getTile(x,A,g,e.pixelRatio,s.projection)),we(i,S))continue;if(!U)U=this.createTileRepresentation({tile:S,grid:u,helper:this.helper,gutter:c}),T.set(p,U);else if(this.isDrawableTile_(S))U.setTile(S);else{const D=S.getInterimTile();U.setTile(D)}Ie(i,U,x);const I=S.getKey();E[I]=!0,S.getState()===b.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([S,f,u.getTileCoordCenter(R),m]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}renderTile(e,t,r,i,o,s,a,h,u,c,f){}drawTile_(e,t,r,i,o,s,a){if(!t.loaded)return;const u=t.tile.tileCoord,c=V(u),f=c in s?s[c]:1,E=a.getResolution(r),T=Te(a.getTileSize(r),this.tempSize_),y=a.getOrigin(r),L=a.getTileCoordExtent(u),x=f<1?-1:nr(r);f<1&&(e.animate=!0);const C=e.viewState,m=C.center[0],A=C.center[1],g=T[0]+2*i,R=T[1]+2*i,p=g/R,U=(m-y[0])/(T[0]*E),S=(y[1]-A)/(T[1]*E),I=C.resolution/E,D=u[1],v=u[2];pt(this.tileTransform_),Ue(this.tileTransform_,2/(e.size[0]*I/g),-2/(e.size[1]*I/g)),gt(this.tileTransform_,C.rotation),Ue(this.tileTransform_,1,1/p),Rt(this.tileTransform_,(T[0]*(D-U)-i)/g,(T[1]*(v-S)-i)/R),this.renderTile(t,this.tileTransform_,e,o,E,T,y,L,x,i,f)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),o=i.getRenderSource(),s=o.getTileGridForProjection(r.projection),a=o.getGutterForProjection(r.projection),h=se(e,e.extent),u=s.getZForResolution(r.resolution,o.zDirection),c=ir(),f=i.getPreload();if(e.nextExtent){const R=s.getZForResolution(r.nextResolution,o.zDirection),p=se(e,e.nextExtent);this.enqueueTiles(e,p,R,c,f)}this.enqueueTiles(e,h,u,c,0),f>0&&setTimeout(()=>{this.enqueueTiles(e,h,u-1,c,f-1)},0);const E={},T=G(this),y=e.time;let L=!1;for(const R of c.representationsByZ[u]){const p=R.tile;if((p instanceof he||p instanceof $e)&&p.getState()===b.EMPTY)continue;const U=p.tileCoord;if(R.loaded){const D=p.getAlpha(T,y);if(D===1){p.endTransition(T);continue}L=!0;const v=V(U);E[v]=D}if(this.renderComplete=!1,this.findAltTiles_(s,U,u+1,c))continue;const I=s.getMinZoom();for(let D=u-1;D>=I&&!this.findAltTiles_(s,U,D,c);--D);}this.beforeTilesRender(e,L);const x=c.representationsByZ,C=Object.keys(x).map(Number).sort(mt);for(let R=0,p=C.length;R<p;++R){const U=C[R];for(const S of x[U]){const I=S.tile.tileCoord;V(I)in E||this.drawTile_(e,S,U,a,h,E,s)}}for(const R of x[u]){const p=R.tile.tileCoord;V(p)in E&&this.drawTile_(e,R,u,a,h,E,s)}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const m=this.helper.getCanvas(),A=this.tileRepresentationCache;for(;A.canExpireCache();)A.pop().dispose();const g=function(R,p){o.updateCacheSize(.1,p.viewState.projection),o.expireCache(p.viewState.projection,rr)};return e.postRenderFunctions.push(g),this.postRender(t,e),m}findAltTiles_(e,t,r,i){const o=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!o)return!1;let s=!0;const a=this.tileRepresentationCache,h=this.getLayer().getRenderSource();for(let u=o.minX;u<=o.maxX;++u)for(let c=o.minY;c<=o.maxY;++c){const f=ue(h,[r,u,c]);let E=!1;if(a.containsKey(f)){const T=a.get(f);T.loaded&&!we(i,T.tile)&&(Ie(i,T,r),E=!0)}E||(s=!1)}return s}clearCache(){const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}removeHelper(){this.helper&&this.clearCache(),super.removeHelper()}disposeInternal(){super.disposeInternal(),delete this.frameState}}const sr=or,w={...tr,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},ar={TEXTURE_COORD:"a_textureCoord"},lr=[{name:ar.TEXTURE_COORD,size:2,type:K.FLOAT}];class cr extends sr{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new ze(Ee,_e),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){super.reset(e),this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}createTileRepresentation(e){return new er(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,i,o,s,a,h,u,c,f){const E=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(lr);let T=0;for(;T<e.textures.length;){const p=`${w.TILE_TEXTURE_ARRAY}[${T}]`;this.helper.bindTexture(e.textures[T],T,p),++T}for(let p=0;p<this.paletteTextures_.length;++p){const U=this.paletteTextures_[p],S=U.getTexture(E);this.helper.bindTexture(S,T,U.name),++T}const y=r.viewState,L=s[0]+2*c,x=s[1]+2*c,m=e.tile.tileCoord,A=m[1],g=m[2];this.helper.setUniformMatrixValue(w.TILE_TRANSFORM,We(this.tempMat4,t)),this.helper.setUniformFloatValue(w.TRANSITION_ALPHA,f),this.helper.setUniformFloatValue(w.DEPTH,u);let R=i;c>0&&(R=h,j(R,i,R)),this.helper.setUniformFloatVec4(w.RENDER_EXTENT,R),this.helper.setUniformFloatValue(w.RESOLUTION,y.resolution),this.helper.setUniformFloatValue(w.ZOOM,y.zoom),this.helper.setUniformFloatValue(w.TEXTURE_PIXEL_WIDTH,L),this.helper.setUniformFloatValue(w.TEXTURE_PIXEL_HEIGHT,x),this.helper.setUniformFloatValue(w.TEXTURE_RESOLUTION,o),this.helper.setUniformFloatValue(w.TEXTURE_ORIGIN_X,a[0]+A*s[0]*o-c*o),this.helper.setUniformFloatValue(w.TEXTURE_ORIGIN_Y,a[1]-g*s[1]*o+c*o),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const i=this.getLayer(),o=yt(r.pixelToCoordinateTransform,e.slice()),s=r.viewState,a=i.getExtent();if(a&&!be(Me(a,s.projection),o))return null;const h=i.getSources(xt([o]),s.resolution);let u,c,f;for(u=h.length-1;u>=0;--u)if(c=h[u],c.getState()==="ready"){if(f=c.getTileGridForProjection(s.projection),c.getWrapX())break;const T=f.getExtent();if(!T||be(T,o))break}if(u<0)return null;const E=this.tileRepresentationCache;for(let T=f.getZForResolution(s.resolution);T>=f.getMinZoom();--T){const y=f.getTileCoordForCoordAndZ(o,T),L=ue(c,y);if(!E.containsKey(L))continue;const x=E.get(L),C=x.tile;if((C instanceof he||C instanceof $e)&&C.getState()===b.EMPTY)return null;if(!x.loaded)continue;const m=f.getOrigin(T),A=Te(f.getTileSize(T)),g=f.getResolution(T),R=(o[0]-m[0])/g-y[1]*A[0],p=(m[1]-o[1])/g-y[2]*A[1];return x.getPixelData(R,p)}return null}disposeInternal(){const e=this.helper;e&&(e.getGL().deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)),super.disposeInternal(),delete this.indices_}}const xr=cr,l={NUMBER:1,STRING:2,COLOR:4,BOOLEAN:8,NUMBER_ARRAY:16,ANY:31,NONE:0};function ur(n){switch(n){case"string":return l.STRING;case"color":return l.COLOR;case"number":return l.NUMBER;case"boolean":return l.BOOLEAN;case"number[]":return l.NUMBER_ARRAY;default:throw new Error(`Unrecognized type hint: ${n}`)}}const _={};function O(n){if(typeof n=="number")return l.NUMBER;if(typeof n=="boolean")return l.BOOLEAN;if(typeof n=="string")return Ct(n)?l.COLOR|l.STRING:l.STRING;if(!Array.isArray(n))throw new Error(`Unhandled value type: ${JSON.stringify(n)}`);const e=n;if(e.every(function(i){return typeof i=="number"}))return e.length===3||e.length===4?l.COLOR|l.NUMBER_ARRAY:l.NUMBER_ARRAY;if(typeof e[0]!="string")throw new Error(`Expected an expression operator but received: ${JSON.stringify(e)}`);const r=_[e[0]];if(r===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return r.getReturnType(e.slice(1))}function hr(n){return Math.log2(n)%1===0}function F(n){const e=[];return(n&l.NUMBER)>0&&e.push("number"),(n&l.COLOR)>0&&e.push("color"),(n&l.BOOLEAN)>0&&e.push("boolean"),(n&l.NUMBER_ARRAY)>0&&e.push("number[]"),(n&l.STRING)>0&&e.push("string"),e.length>0?e.join(", "):"(no type)"}function fr(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function re(n){const e=n.toString();return e.includes(".")?e:e+".0"}function Ve(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(re).join(", ")})`}function Tr(n){const e=At(n),t=e.length>3?e[3]:1;return Ve([e[0]/255*t,e[1]/255*t,e[2]/255*t,t])}const ae={};let dr=0;function Er(n){return n in ae||(ae[n]=dr++),ae[n]}function _r(n){return re(Er(n))}function d(n,e,t){const r=t!==void 0?t:l.NUMBER;if(Array.isArray(e)&&typeof e[0]=="string"){const o=_[e[0]];if(o===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return o.toGlsl(n,e.slice(1),r)}const i=O(e)&r;if(Je(e,i,""),(i&l.NUMBER)>0)return re(e);if((i&l.BOOLEAN)>0)return e.toString();if((i&l.STRING)>0)return _r(e.toString());if((i&l.COLOR)>0)return Tr(e);if((i&l.NUMBER_ARRAY)>0)return Ve(e);throw new Error(`Unexpected expression ${e} (expected type ${F(r)})`)}function Ke(n){if(!(O(n)&l.NUMBER))throw new Error(`A numeric value was expected, got ${JSON.stringify(n)} instead`)}function P(n){for(let e=0;e<n.length;e++)Ke(n[e])}function Ze(n){if(!(O(n)&l.STRING))throw new Error(`A string value was expected, got ${JSON.stringify(n)} instead`)}function ge(n){if(!(O(n)&l.BOOLEAN))throw new Error(`A boolean value was expected, got ${JSON.stringify(n)} instead`)}function N(n,e){if(n.length!==e)throw new Error(`Exactly ${e} arguments were expected, got ${n.length} instead`)}function B(n,e){if(n.length<e)throw new Error(`At least ${e} arguments were expected, got ${n.length} instead`)}function Z(n,e){if(n.length>e)throw new Error(`At most ${e} arguments were expected, got ${n.length} instead`)}function ke(n){if(n.length%2!==0)throw new Error(`An even amount of arguments was expected, got ${JSON.stringify(n)} instead`)}function pr(n){if(n.length%2===0)throw new Error(`An odd amount of arguments was expected, got ${JSON.stringify(n)} instead`)}function Je(n,e,t){if(e===l.NONE)throw new Error(`No matching type was found for the following expression ${t}: ${JSON.stringify(n)}`)}function k(n,e,t){if(Je(n,e,t),!hr(e))throw new Error(`Expected to have a unique type for the following expression ${t}: ${JSON.stringify(n)}
Got the following types instead: ${F(e)}`)}function Re(n,e,t,r){if((e&t)===l.NONE)throw new Error(`Expected the ${r} type of the following expression: ${JSON.stringify(n)} to be of the following types: ${F(t)}
Got these types instead: ${F(e)}`)}_.get={getReturnType:function(n){if(n.length===2){const e=n[1];return ur(e)}return l.ANY},toGlsl:function(n,e,t){B(e,1),Z(e,2),Ze(e[0]);const r=t&_.get.getReturnType(e);k(["get",...e],r,"");const i=e[0].toString(),o=n.attributes.find(a=>a.name===i);if(!o)n.attributes.push({name:i,type:r});else if(r!==o.type)throw new Error(`The following attribute was used in different places with incompatible types: ${i}
Types were: ${F(o.type)} and ${F(r)}`);return(n.inFragmentShader?"v_":"a_")+i}};function gr(n){return"u_var_"+n}_.var={getReturnType:function(){return l.ANY},toGlsl:function(n,e,t){N(e,1),Ze(e[0]);const r=e[0].toString();if(!n.style.variables||n.style.variables[r]===void 0)throw new Error(`The following variable is missing from the style: ${r}`);const i=n.style.variables[r],o=t&O(i);k(["var",...e],o,"");const s=n.variables.find(a=>a.name===r);if(!s)n.variables.push({name:r,type:o});else if(o!==s.type)throw new Error(`The following variable was used in different places with incompatible types: ${r}
Types were: ${F(s.type)} and ${F(o)}`);return gr(r)}};const Rr="u_paletteTextures";_.palette={getReturnType:function(){return l.COLOR},toGlsl:function(n,e){N(e,2),Ke(e[0]);const t=d(n,e[0]),r=e[1];if(!Array.isArray(r))throw new Error("The second argument of palette must be an array");const i=r.length,o=new Uint8Array(i*4);for(let h=0;h<i;h++){const u=r[h];let c;if(typeof u=="string")c=Lt(u);else{if(!Array.isArray(u))throw new Error("The second argument of palette must be an array of strings or colors");const E=u.length;if(E===4)c=u;else{if(E!==3)throw new Error(`Expected palette color to have 3 or 4 values, got ${E}`);c=[u[0],u[1],u[2],1]}}const f=h*4;o[f]=c[0],o[f+1]=c[1],o[f+2]=c[2],o[f+3]=c[3]*255}n.paletteTextures||(n.paletteTextures=[]);const s=`${Rr}[${n.paletteTextures.length}]`,a=new Kt(s,o);return n.paletteTextures.push(a),`texture2D(${s}, vec2((${t} + 0.5) / ${i}.0, 0.5))`}};const le="getBandValue";_.band={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){B(e,1),Z(e,3);const t=e[0];if(!(le in n.functions)){let s="";const a=n.bandCount||1;for(let h=0;h<a;h++){const u=Math.floor(h/4);let c=h%4;h===a-1&&c===1&&(c=3);const f=`${w.TILE_TEXTURE_ARRAY}[${u}]`;s+=`
          if (band == ${h+1}.0) {
            return texture2D(${f}, v_textureCoord + vec2(dx, dy))[${c}];
          }
        `}n.functions[le]=`
        float getBandValue(float band, float xOffset, float yOffset) {
          float dx = xOffset / ${w.TEXTURE_PIXEL_WIDTH};
          float dy = yOffset / ${w.TEXTURE_PIXEL_HEIGHT};
          ${s}
        }
      `}const r=d(n,t),i=d(n,e[1]||0),o=d(n,e[2]||0);return`${le}(${r}, ${i}, ${o})`}};_.time={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,0),"u_time"}};_.zoom={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,0),"u_zoom"}};_.resolution={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,0),"u_resolution"}};_["geometry-type"]={getReturnType:function(){return l.STRING},toGlsl:function(n,e){N(e,0);const t="geometryType",r=s=>{const a=s.getType();switch(a){case"Point":case"LineString":case"Polygon":return a;case"MultiPoint":case"MultiLineString":case"MultiPolygon":return a.substring(5);case"Circle":return"Polygon";case"GeometryCollection":return r(s.getGeometries()[0])}};return n.attributes.find(s=>s.name===t)||n.attributes.push({name:t,type:l.STRING,callback:s=>r(s.getGeometry())}),(n.inFragmentShader?"v_":"a_")+t}};_["*"]={getReturnType:function(n){let e=l.NUMBER|l.COLOR;for(let t=0;t<n.length;t++)e=e&O(n[t]);return e},toGlsl:function(n,e,t){B(e,2);let r=t;for(let i=0;i<e.length;i++)r=r&O(e[i]);return Re(e,r,l.NUMBER|l.COLOR,"output"),`(${e.map(i=>d(n,i,r)).join(" * ")})`}};_["/"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} / ${d(n,e[1])})`}};_["+"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return B(e,2),P(e),`(${e.map(t=>d(n,t)).join(" + ")})`}};_["-"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} - ${d(n,e[1])})`}};_.clamp={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){N(e,3),P(e);const t=d(n,e[1]),r=d(n,e[2]);return`clamp(${d(n,e[0])}, ${t}, ${r})`}};_["%"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,2),P(e),`mod(${d(n,e[0])}, ${d(n,e[1])})`}};_["^"]={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,2),P(e),`pow(${d(n,e[0])}, ${d(n,e[1])})`}};_.abs={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`abs(${d(n,e[0])})`}};_.floor={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`floor(${d(n,e[0])})`}};_.round={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`floor(${d(n,e[0])} + 0.5)`}};_.ceil={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`ceil(${d(n,e[0])})`}};_.sin={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`sin(${d(n,e[0])})`}};_.cos={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`cos(${d(n,e[0])})`}};_.atan={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return B(e,1),Z(e,2),P(e),e.length===2?`atan(${d(n,e[0])}, ${d(n,e[1])})`:`atan(${d(n,e[0])})`}};_.sqrt={getReturnType:function(){return l.NUMBER},toGlsl:function(n,e){return N(e,1),P(e),`sqrt(${d(n,e[0])})`}};_[">"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} > ${d(n,e[1])})`}};_[">="]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} >= ${d(n,e[1])})`}};_["<"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} < ${d(n,e[1])})`}};_["<="]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return N(e,2),P(e),`(${d(n,e[0])} <= ${d(n,e[1])})`}};function qe(n){return{getReturnType:function(){return l.BOOLEAN},toGlsl:function(e,t){N(t,2);let r=l.ANY;for(let i=0;i<t.length;i++)r&=O(t[i]);if(r===l.NONE)throw new Error(`All arguments should be of compatible type, got ${JSON.stringify(t)} instead`);return r&=~l.COLOR,`(${d(e,t[0],r)} ${n} ${d(e,t[1],r)})`}}}_["=="]=qe("==");_["!="]=qe("!=");_["!"]={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){return N(e,1),ge(e[0]),`(!${d(n,e[0],l.BOOLEAN)})`}};function Qe(n){return{getReturnType:function(){return l.BOOLEAN},toGlsl:function(e,t){B(t,2);for(let i=0;i<t.length;i++)ge(t[i]);let r=t.map(i=>d(e,i,l.BOOLEAN)).join(` ${n} `);return r=`(${r})`,r}}}_.all=Qe("&&");_.any=Qe("||");_.between={getReturnType:function(){return l.BOOLEAN},toGlsl:function(n,e){N(e,3),P(e);const t=d(n,e[1]),r=d(n,e[2]),i=d(n,e[0]);return`(${i} >= ${t} && ${i} <= ${r})`}};_.array={getReturnType:function(){return l.NUMBER_ARRAY},toGlsl:function(n,e){B(e,2),Z(e,4),P(e);const t=e.map(function(r){return d(n,r)});return`vec${e.length}(${t.join(", ")})`}};_.color={getReturnType:function(){return l.COLOR},toGlsl:function(n,e){B(e,3),Z(e,4),P(e);const t=e.slice(0,3).map(i=>`${d(n,i)} / 255.0`);return e.length===3?`vec4(${t.join(", ")}, 1.0)`:`(${d(n,e[3])} * vec4(${t.join(", ")}, 1.0))`}};_.interpolate={getReturnType:function(n){let e=l.COLOR|l.NUMBER;for(let t=3;t<n.length;t+=2)e=e&O(n[t]);return e},toGlsl:function(n,e,t){ke(e),B(e,6);const r=e[0];let i;switch(r[0]){case"linear":i=1;break;case"exponential":i=r[1];break;default:i=null}if(!i)throw new Error(`Invalid interpolation type for "interpolate" operator, received: ${JSON.stringify(r)}`);const o=l.NUMBER,s=_.interpolate.getReturnType(e)&t;k(["interpolate",...e],s,"output");const a=d(n,e[1],o),h=re(i);let u="";for(let c=2;c<e.length-2;c+=2){const f=d(n,e[c],o),E=u||d(n,e[c+1],s),T=d(n,e[c+2],o),y=d(n,e[c+3],s);let L;i===1?L=`(${a} - ${f}) / (${T} - ${f})`:L=`(pow(${h}, (${a} - ${f})) - 1.0) / (pow(${h}, (${T} - ${f})) - 1.0)`,u=`mix(${E}, ${y}, clamp(${L}, 0.0, 1.0))`}return u}};_.match={getReturnType:function(n){let e=l.ANY;for(let t=2;t<n.length;t+=2)e=e&O(n[t]);return e=e&O(n[n.length-1]),e},toGlsl:function(n,e,t){ke(e),B(e,4);let r=O(e[0]);for(let h=1;h<e.length-1;h+=2)r=r&O(e[h]);Re(["match",...e],r,l.STRING|l.NUMBER|l.BOOLEAN,"input"),r=(l.STRING|l.NUMBER|l.BOOLEAN)&r;const i=_.match.getReturnType(e)&t;k(["match",...e],i,"output");const o=d(n,e[0],r),s=d(n,e[e.length-1],i);let a=null;for(let h=e.length-3;h>=1;h-=2){const u=d(n,e[h],r),c=d(n,e[h+1],i);a=`(${o} == ${u} ? ${c} : ${a||s})`}return a}};_.case={getReturnType:function(n){let e=l.ANY;for(let t=1;t<n.length;t+=2)e=e&O(n[t]);return e=e&O(n[n.length-1]),e},toGlsl:function(n,e,t){pr(e),B(e,3);const r=_.case.getReturnType(e)&t;k(["case",...e],r,"output");for(let s=0;s<e.length-1;s+=2)ge(e[s]);const i=d(n,e[e.length-1],r);let o=null;for(let s=e.length-3;s>=0;s-=2){const a=d(n,e[s],l.BOOLEAN),h=d(n,e[s+1],r);o=`(${a} ? ${h} : ${o||i})`}return o}};_.in={getReturnType:function(n){return l.BOOLEAN},toGlsl:function(n,e){N(e,2);const t=e[0];let r=e[1];if(!Array.isArray(r))throw new Error('The "in" operator expects an array literal as its second argument.');if(typeof r[0]=="string"){if(r[0]!=="literal")throw new Error('For the "in" operator, a string array should be wrapped in a "literal" operator to disambiguate from expressions.');if(!Array.isArray(r[1]))throw new Error('The "in" operator was provided a literal value which was not an array as second argument.');r=r[1]}let i=O(t);for(let a=0;a<r.length-1;a+=1)i=i&O(r[a]);Re(["match",...e],i,l.STRING|l.NUMBER|l.BOOLEAN,"input"),i=(l.STRING|l.NUMBER|l.BOOLEAN)&i;const o=fr("in",n),s=[];for(let a=0;a<r.length;a+=1)s.push(`  if (inputValue == ${d(n,r[a],i)}) { return true; }`);return n.functions[o]=`bool ${o}(float inputValue) {
${s.join(`
`)}
  return false;
}`,`${o}(${d(n,t,i)})`}};export{ar as A,Fe as D,Ee as E,Rr as P,$e as R,w as U,l as V,xr as W,Ve as a,K as b,ze as c,de as d,d as e,Ot as f,Er as g,Yt as h,He as i,We as j,M as k,Tr as l,re as n,_r as s,gr as u};
